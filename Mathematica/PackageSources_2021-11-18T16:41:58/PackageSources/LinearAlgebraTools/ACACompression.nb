(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 11.3' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       158,          7]
NotebookDataLength[    110354,       2513]
NotebookOptionsPosition[    109276,       2492]
NotebookOutlinePosition[    109612,       2507]
CellTagsIndexPosition[    109569,       2504]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{
Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"ACACompression", "=", 
    RowBox[{"PackageFunction", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"idxfun_", ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"m_Integer", "?", "Positive"}], ",", 
          RowBox[{"n_Integer", "?", "Positive"}]}], "}"}], ",", 
        RowBox[{"opts", ":", 
         RowBox[{"OptionsPattern", "[", "]"}]}]}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"ACACompression", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"j", "\[Function]", 
         RowBox[{"idxfun", "[", 
          RowBox[{
           RowBox[{"Range", "[", "m", "]"}], ",", "j"}], "]"}]}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"i", "\[Function]", 
         RowBox[{"idxfun", "[", 
          RowBox[{"i", ",", 
           RowBox[{"Range", "[", "n", "]"}]}], "]"}]}], ",", 
        "\[IndentingNewLine]", "opts"}], "\[IndentingNewLine]", "]"}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ACACompression", "=", 
    RowBox[{"PackageFunction", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"ker_", ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"x_", "?", "List"}], ",", 
          RowBox[{"y_", "?", "List"}]}], "}"}], ",", 
        RowBox[{"opts", ":", 
         RowBox[{"OptionsPattern", "[", "]"}]}]}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"ACACompression", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"j", "\[Function]", 
         RowBox[{"ker", "[", 
          RowBox[{"x", ",", 
           RowBox[{
           "y", "\[LeftDoubleBracket]", "j", "\[RightDoubleBracket]"}]}], 
          "]"}]}], ",", "\[IndentingNewLine]", 
        RowBox[{"i", "\[Function]", 
         RowBox[{"ker", "[", 
          RowBox[{
           RowBox[{
           "x", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], ",", 
           "y"}], "]"}]}], ",", "\[IndentingNewLine]", "opts"}], 
       "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ACACompression", "=", 
    RowBox[{"PackageFunction", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"A_", "?", "MatrixQ"}], ",", 
        RowBox[{"opts", ":", 
         RowBox[{"OptionsPattern", "[", "]"}]}]}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"ACACompression", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"i", "\[Function]", 
         RowBox[{"A", "\[LeftDoubleBracket]", 
          RowBox[{"i", ",", "All"}], "\[RightDoubleBracket]"}]}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"j", "\[Function]", 
         RowBox[{"A", "\[LeftDoubleBracket]", 
          RowBox[{"All", ",", "j"}], "\[RightDoubleBracket]"}]}], ",", 
        "\[IndentingNewLine]", "opts"}], "\[IndentingNewLine]", "]"}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ACACompression", "=", 
    RowBox[{"PackageFunction", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"idxfun_", ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"m_Integer", "?", "Positive"}], ",", 
          RowBox[{"n_Integer", "?", "Positive"}], ",", 
          RowBox[{"o_Integer", "?", "Positive"}]}], "}"}], ",", 
        RowBox[{"opts", ":", 
         RowBox[{"OptionsPattern", "[", "]"}]}]}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"Print", "[", "\"\<3-Index version\>\"", "]"}], ";"}], "*)"}],
       "\[IndentingNewLine]", 
      RowBox[{"ACACompression", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"{", 
          RowBox[{"j", ",", "k"}], "}"}], "\[Function]", 
         RowBox[{"idxfun", "[", 
          RowBox[{
           RowBox[{"Range", "[", "m", "]"}], ",", "j", ",", "k"}], "]"}]}], 
        ",", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"i", ",", "k"}], "}"}], "\[Function]", 
         RowBox[{"idxfun", "[", 
          RowBox[{"i", ",", 
           RowBox[{"Range", "[", "n", "]"}], ",", "k"}], "]"}]}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"i", ",", "j"}], "}"}], "\[Function]", 
         RowBox[{"idxfun", "[", 
          RowBox[{"i", ",", "j", ",", 
           RowBox[{"Range", "[", "o", "]"}]}], "]"}]}], ",", 
        "\[IndentingNewLine]", "opts"}], "\[IndentingNewLine]", "]"}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ACACompression", "=", 
    RowBox[{"PackageFunction", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"ker_", ",", 
        RowBox[{"{", 
         RowBox[{"x_List", ",", "y_List", ",", "z_List"}], "}"}], ",", 
        RowBox[{"opts", ":", 
         RowBox[{"OptionsPattern", "[", "]"}]}]}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"Print", "[", "\"\<Trivariate Kernel version\>\"", "]"}], 
        ";"}], "*)"}], "\[IndentingNewLine]", 
      RowBox[{"ACACompression", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"{", 
          RowBox[{"j", ",", "k"}], "}"}], "\[Function]", 
         RowBox[{"ker", "[", 
          RowBox[{"x", ",", 
           RowBox[{
           "y", "\[LeftDoubleBracket]", "j", "\[RightDoubleBracket]"}], ",", 
           RowBox[{
           "z", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}]}], 
          "]"}]}], ",", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"i", ",", "k"}], "}"}], "\[Function]", 
         RowBox[{"ker", "[", 
          RowBox[{
           RowBox[{
           "x", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], ",", 
           "y", ",", 
           RowBox[{
           "z", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}]}], 
          "]"}]}], ",", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"i", ",", "j"}], "}"}], "\[Function]", 
         RowBox[{"ker", "[", 
          RowBox[{
           RowBox[{
           "x", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], ",", 
           RowBox[{
           "y", "\[LeftDoubleBracket]", "j", "\[RightDoubleBracket]"}], ",", 
           "z"}], "]"}]}], ",", "\[IndentingNewLine]", "opts"}], 
       "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ACACompression", "=", 
   RowBox[{"PackageFunction", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"T_", "?", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{
           RowBox[{"ArrayQ", "[", "#", "]"}], "&&", 
           RowBox[{
            RowBox[{"ArrayDepth", "[", "#", "]"}], "\[Equal]", "3"}]}], "&"}],
          ")"}]}], ",", 
       RowBox[{"opts", ":", 
        RowBox[{"OptionsPattern", "[", "]"}]}]}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"Print", "[", "\"\<3-Tensor version\>\"", "]"}], ";"}], "*)"}],
      "\[IndentingNewLine]", 
     RowBox[{"ACACompression", "[", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"{", 
         RowBox[{"j", ",", "k"}], "}"}], "\[Function]", 
        RowBox[{"T", "\[LeftDoubleBracket]", 
         RowBox[{"All", ",", "j", ",", "k"}], "\[RightDoubleBracket]"}]}], 
       ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"i", ",", "k"}], "}"}], "\[Function]", 
        RowBox[{"T", "\[LeftDoubleBracket]", 
         RowBox[{"i", ",", "All", ",", "k"}], "\[RightDoubleBracket]"}]}], 
       ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"i", ",", "j"}], "}"}], "\[Function]", 
        RowBox[{"T", "\[LeftDoubleBracket]", 
         RowBox[{"i", ",", "j", ",", "All"}], "\[RightDoubleBracket]"}]}], 
       ",", "\[IndentingNewLine]", "opts"}], "\[IndentingNewLine]", "]"}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.7948373221621017`*^9, 3.794837384984229*^9}, {
   3.79483741617513*^9, 3.794837828087419*^9}, {3.79483795076302*^9, 
   3.794837960395802*^9}, {3.7948380661673393`*^9, 3.794838067965702*^9}, {
   3.7948381512290773`*^9, 3.794838153372178*^9}, {3.794838187555262*^9, 
   3.794838197706853*^9}, {3.794838264047971*^9, 3.794838264430738*^9}, {
   3.7948383176546717`*^9, 3.7948383197231417`*^9}, {3.794838351765143*^9, 
   3.7948383702131987`*^9}, {3.7948384059837523`*^9, 3.794838450435493*^9}, {
   3.7948385377066*^9, 3.794838569913123*^9}, {3.794838707517308*^9, 
   3.79483874940121*^9}, {3.794838814828187*^9, 3.794838826316513*^9}, {
   3.7948388642339697`*^9, 3.7948388913636007`*^9}, {3.794838957995392*^9, 
   3.794838969556469*^9}, {3.7948390550006027`*^9, 3.794839074885931*^9}, {
   3.794839148249825*^9, 3.794839163208055*^9}, {3.794839205741708*^9, 
   3.794839206889409*^9}, {3.794839247344475*^9, 3.794839256191567*^9}, {
   3.794839326652255*^9, 3.794839437702284*^9}, {3.7948397123841867`*^9, 
   3.7948397544122143`*^9}, {3.7948397955712423`*^9, 
   3.7948398068163643`*^9}, {3.794839869422751*^9, 3.7948400007384157`*^9}, {
   3.7948400342837543`*^9, 3.794840069609539*^9}, {3.794840486658043*^9, 
   3.7948405192292233`*^9}, 3.794840582934451*^9, {3.794840662637521*^9, 
   3.79484066910045*^9}, {3.794840711094595*^9, 3.7948408396163607`*^9}, {
   3.794840963636191*^9, 3.794840970061064*^9}, {3.794841060307474*^9, 
   3.794841075552926*^9}, {3.794841219427034*^9, 3.7948412689357758`*^9}, {
   3.794841301510251*^9, 3.794841354734193*^9}, {3.7948414009830513`*^9, 
   3.7948414571644783`*^9}, {3.79484154218364*^9, 3.794841547502245*^9}, {
   3.794841591390862*^9, 3.794841599695035*^9}, {3.794841637831821*^9, 
   3.794841673498241*^9}, {3.794841725378419*^9, 3.794841727168661*^9}, {
   3.794841795310596*^9, 3.79484187419759*^9}, {3.794841912365561*^9, 
   3.794841993001906*^9}, {3.794842037757947*^9, 3.7948421078995247`*^9}, {
   3.794842194321951*^9, 3.794842197451768*^9}, {3.794892477416704*^9, 
   3.7948924996074944`*^9}, {3.794892637002939*^9, 3.794892684336623*^9}, {
   3.794892836114772*^9, 3.794893092455532*^9}, {3.794893827125646*^9, 
   3.7948938838642473`*^9}, {3.7948939868490763`*^9, 3.794894183598523*^9}, {
   3.7948952942859373`*^9, 3.794895443270946*^9}, {3.7948954773428297`*^9, 
   3.794895477885416*^9}, {3.794920009251424*^9, 3.794920035274514*^9}, {
   3.7949200964808598`*^9, 3.794920101799481*^9}, {3.794920290067897*^9, 
   3.7949202925680237`*^9}, {3.794920323233989*^9, 3.794920333965701*^9}, {
   3.794920368793578*^9, 3.7949203731417294`*^9}},
 CellLabel->
  "In[111]:=",ExpressionUUID->"d2f2378e-7a28-4b98-9912-e08ec484fb90"],

Cell[BoxData[
 RowBox[{
  RowBox[{"ACACompression", "=", 
   RowBox[{"PackageFunction", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"col_", ",", "row_"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
        "maxrank", ",", "maxpivottrials", ",", "pivotiter", ",", 
         "pivotthreshold", ",", "pivotfailures", ",", "TOL", ",", "TOL2", ",",
          "\[IndentingNewLine]", "ii", ",", "jj", ",", "i", ",", "j", ",", 
         "u", ",", "v", ",", "a", ",", "b", ",", "U", ",", "V", ",", "test", 
         ",", "norm2", ",", "\[Delta]", ",", "buffer", ",", "iter", ",", 
         "rank", ",", "\[Sigma]", ",", "scale"}], "}"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{"Print", "[", "\"\<Bivariate backend\>\"", "]"}], ";"}], 
        "*)"}], "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"pivotfailures", "=", "0"}], ";", "\[IndentingNewLine]", 
        RowBox[{"pivotthreshold", "=", 
         RowBox[{"OptionValue", "[", "\"\<PivotThreshold\>\"", "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"maxpivottrials", "=", 
         RowBox[{"OptionValue", "[", "\"\<MaxPivotTrials\>\"", "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"maxrank", "=", 
         RowBox[{"OptionValue", "[", "\"\<MaxRank\>\"", "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"TOL", "=", 
         RowBox[{"OptionValue", "[", "\"\<Tolerance\>\"", "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"TOL2", "=", 
         RowBox[{"TOL", "^", "2"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"iter", "=", "1"}], ";", "\[IndentingNewLine]", 
        RowBox[{"i", "=", 
         RowBox[{"OptionValue", "[", "\"\<StartingIndex\>\"", "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"v", "=", 
         RowBox[{"row", "[", "i", "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"j", "=", 
         RowBox[{"IAMAX", "[", "v", "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"u", "=", 
         RowBox[{"col", "[", "j", "]"}]}], ";", "\[IndentingNewLine]", 
        "\[IndentingNewLine]", 
        RowBox[{"U", "=", 
         RowBox[{"ConstantArray", "[", 
          RowBox[{"0.", ",", 
           RowBox[{"{", 
            RowBox[{"maxrank", ",", 
             RowBox[{"Length", "[", "u", "]"}]}], "}"}]}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"V", "=", 
         RowBox[{"ConstantArray", "[", 
          RowBox[{"0.", ",", 
           RowBox[{"{", 
            RowBox[{"maxrank", ",", 
             RowBox[{"Length", "[", "v", "]"}]}], "}"}]}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"ii", "=", 
         RowBox[{"ConstantArray", "[", 
          RowBox[{"0", ",", 
           RowBox[{"{", "maxrank", "}"}]}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"jj", "=", 
         RowBox[{"ConstantArray", "[", 
          RowBox[{"0", ",", 
           RowBox[{"{", "maxrank", "}"}]}], "]"}]}], ";", 
        "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"\[Delta]", "=", 
         RowBox[{
         "v", "\[LeftDoubleBracket]", "j", "\[RightDoubleBracket]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"scale", "=", 
         RowBox[{"1.", "/", 
          RowBox[{"Sqrt", "[", 
           RowBox[{"Abs", "[", "\[Delta]", "]"}], "]"}]}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"U", "\[LeftDoubleBracket]", 
          RowBox[{"iter", ",", "All"}], "\[RightDoubleBracket]"}], "=", 
         RowBox[{"u", " ", "=", 
          RowBox[{"u", " ", "scale"}]}]}], ";", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"V", "\[LeftDoubleBracket]", 
          RowBox[{"iter", ",", "All"}], "\[RightDoubleBracket]"}], "=", 
         RowBox[{"v", "=", 
          RowBox[{"v", " ", "scale", " ", 
           RowBox[{"Sign", "[", "\[Delta]", "]"}]}]}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
         "ii", "\[LeftDoubleBracket]", "iter", "\[RightDoubleBracket]"}], "=",
          "i"}], ";", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
         "jj", "\[LeftDoubleBracket]", "iter", "\[RightDoubleBracket]"}], "=",
          "j"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"OptionValue", "[", "\"\<Weights\>\"", "]"}], "===", 
           "Automatic"}], ",", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"a", "=", 
            RowBox[{"ConstantArray", "[", 
             RowBox[{"1.", ",", 
              RowBox[{"Length", "[", "u", "]"}]}], "]"}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"b", "=", 
            RowBox[{"ConstantArray", "[", 
             RowBox[{"1.", ",", 
              RowBox[{"Length", "[", "v", "]"}]}], "]"}]}], ";"}], 
          "\[IndentingNewLine]", ",", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"a", ",", "b"}], "}"}], "=", 
           RowBox[{"OptionValue", "[", "\"\<Weights\>\"", "]"}]}]}], 
         "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
        "\[IndentingNewLine]", 
        RowBox[{"test", "=", 
         RowBox[{
          RowBox[{"Dot", "[", 
           RowBox[{
            RowBox[{"u", "^", "2"}], ",", "a"}], "]"}], " ", 
          RowBox[{"Dot", "[", 
           RowBox[{
            RowBox[{"v", "^", "2"}], ",", "b"}], "]"}]}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"norm2", "=", "test"}], ";", "\[IndentingNewLine]", 
        "\[IndentingNewLine]", 
        RowBox[{"maxrank", "=", 
         RowBox[{"Min", "[", 
          RowBox[{
           RowBox[{"Length", "[", "u", "]"}], ",", 
           RowBox[{"Length", "[", "v", "]"}], ",", "maxrank"}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"While", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"test", ">", 
            RowBox[{"TOL2", " ", "norm2"}]}], "&&", 
           RowBox[{"iter", "<", "maxrank"}]}], ",", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{
            RowBox[{"i", "=", 
             RowBox[{"IAMAX", "[", "u", "]"}]}], ";", "\[IndentingNewLine]", 
            RowBox[{"v", "=", 
             RowBox[{"Subtract", "[", 
              RowBox[{
               RowBox[{"row", "[", "i", "]"}], ",", 
               RowBox[{
                RowBox[{"U", "\[LeftDoubleBracket]", 
                 RowBox[{
                  RowBox[{";;", "iter"}], ",", "i"}], 
                 "\[RightDoubleBracket]"}], ".", 
                RowBox[{"V", "\[LeftDoubleBracket]", 
                 RowBox[{";;", "iter"}], "\[RightDoubleBracket]"}]}]}], 
              "]"}]}], ";", "\[IndentingNewLine]", 
            RowBox[{"j", "=", 
             RowBox[{"IAMAX", "[", "v", "]"}]}], ";", "\[IndentingNewLine]", 
            RowBox[{"\[Delta]", "=", 
             RowBox[{
             "v", "\[LeftDoubleBracket]", "j", "\[RightDoubleBracket]"}]}], 
            ";", "\[IndentingNewLine]", 
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"Abs", "[", "\[Delta]", "]"}], "<", "pivotthreshold"}],
               ",", "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{"buffer", "=", "u"}], ";", "\[IndentingNewLine]", 
               RowBox[{"\[Delta]", "=", "0."}], ";", "\[IndentingNewLine]", 
               RowBox[{"pivotiter", "=", "0"}], ";", "\[IndentingNewLine]", 
               RowBox[{"While", "[", 
                RowBox[{
                 RowBox[{
                  RowBox[{
                   RowBox[{"Abs", "[", "\[Delta]", "]"}], "<", 
                   "pivotthreshold"}], "&&", 
                  RowBox[{"iter", "<", "maxpivottrials"}]}], ",", 
                 "\[IndentingNewLine]", 
                 RowBox[{
                  RowBox[{"pivotiter", "++"}], ";", "\[IndentingNewLine]", 
                  RowBox[{
                   RowBox[{
                   "buffer", "\[LeftDoubleBracket]", "i", 
                    "\[RightDoubleBracket]"}], "=", "0."}], ";", 
                  "\[IndentingNewLine]", 
                  RowBox[{"i", "=", 
                   RowBox[{"IAMAX", "[", "buffer", "]"}]}], ";", 
                  "\[IndentingNewLine]", 
                  RowBox[{"v", "=", 
                   RowBox[{"Subtract", "[", 
                    RowBox[{
                    RowBox[{"row", "[", "i", "]"}], ",", 
                    RowBox[{
                    RowBox[{"U", "\[LeftDoubleBracket]", 
                    RowBox[{
                    RowBox[{";;", "iter"}], ",", "i"}], 
                    "\[RightDoubleBracket]"}], ".", 
                    RowBox[{"V", "\[LeftDoubleBracket]", 
                    RowBox[{";;", "iter"}], "\[RightDoubleBracket]"}]}]}], 
                    "]"}]}], ";", "\[IndentingNewLine]", 
                  RowBox[{"j", "=", 
                   RowBox[{"IAMAX", "[", "v", "]"}]}], ";", 
                  "\[IndentingNewLine]", 
                  RowBox[{"\[Delta]", "=", 
                   RowBox[{
                   "v", "\[LeftDoubleBracket]", "j", 
                    "\[RightDoubleBracket]"}]}], ";"}]}], 
                "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
               RowBox[{"pivotfailures", "+=", "pivotiter"}], ";"}]}], 
             "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
            RowBox[{"u", "=", 
             RowBox[{"Subtract", "[", 
              RowBox[{
               RowBox[{"col", "[", "j", "]"}], ",", 
               RowBox[{
                RowBox[{"V", "\[LeftDoubleBracket]", 
                 RowBox[{
                  RowBox[{";;", "iter"}], ",", "j"}], 
                 "\[RightDoubleBracket]"}], ".", 
                RowBox[{"U", "\[LeftDoubleBracket]", 
                 RowBox[{";;", "iter"}], "\[RightDoubleBracket]"}]}]}], 
              "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
            RowBox[{"iter", "++"}], ";", "\[IndentingNewLine]", 
            RowBox[{"scale", "=", 
             RowBox[{"1.", "/", 
              RowBox[{"Sqrt", "[", 
               RowBox[{"Abs", "[", "\[Delta]", "]"}], "]"}]}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"V", "\[LeftDoubleBracket]", 
              RowBox[{"iter", ",", "All"}], "\[RightDoubleBracket]"}], "=", 
             RowBox[{"v", "=", 
              RowBox[{"v", 
               RowBox[{"(", 
                RowBox[{"scale", " ", 
                 RowBox[{"Sign", "[", "\[Delta]", "]"}]}], ")"}]}]}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"U", "\[LeftDoubleBracket]", 
              RowBox[{"iter", ",", "All"}], "\[RightDoubleBracket]"}], "=", 
             RowBox[{"u", "=", 
              RowBox[{"u", " ", "scale"}]}]}], ";", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{
             "ii", "\[LeftDoubleBracket]", "iter", "\[RightDoubleBracket]"}], 
             "=", "i"}], ";", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{
             "jj", "\[LeftDoubleBracket]", "iter", "\[RightDoubleBracket]"}], 
             "=", "j"}], ";", "\[IndentingNewLine]", 
            RowBox[{"test", "=", 
             RowBox[{
              RowBox[{"Dot", "[", 
               RowBox[{
                RowBox[{"u", "^", "2"}], ",", "a"}], "]"}], " ", 
              RowBox[{"Dot", "[", 
               RowBox[{
                RowBox[{"v", "^", "2"}], ",", "b"}], "]"}]}]}], ";"}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"norm2", "+=", "test"}], 
           RowBox[{"(*", 
            RowBox[{"+", 
             RowBox[{"Dot", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"U", "\[LeftDoubleBracket]", 
                 RowBox[{"1", ";;", 
                  RowBox[{"iter", "-", "1"}]}], "\[RightDoubleBracket]"}], 
                ".", "u"}], ",", 
               RowBox[{
                RowBox[{"V", "\[LeftDoubleBracket]", 
                 RowBox[{"1", ";;", 
                  RowBox[{"iter", "-", "1"}]}], "\[RightDoubleBracket]"}], 
                ".", "v"}]}], "]"}]}], "*)"}], ";"}]}], "\[IndentingNewLine]",
          "]"}], ";", "\[IndentingNewLine]", 
        RowBox[{"Association", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"\"\<Rank\>\"", "\[Rule]", "iter"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"\"\<NormEstimator\>\"", "\[Rule]", 
           RowBox[{"Sqrt", "[", "norm2", "]"}]}], ",", "\[IndentingNewLine]", 
          
          RowBox[{"\"\<RelativeErrorEstimator\>\"", "\[Rule]", 
           RowBox[{
            RowBox[{"Sqrt", "[", "test", "]"}], "/", 
            RowBox[{"Sqrt", "[", "norm2", "]"}]}]}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"\"\<PivotFailures\>\"", "\[Rule]", "pivotfailures"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"\"\<U\>\"", "\[Rule]", 
           RowBox[{"U", "\[LeftDoubleBracket]", 
            RowBox[{"1", ";;", "iter"}], "\[RightDoubleBracket]"}]}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"\"\<V\>\"", "\[Rule]", 
           RowBox[{"V", "\[LeftDoubleBracket]", 
            RowBox[{"1", ";;", "iter"}], "\[RightDoubleBracket]"}]}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"\"\<ColumnIndices\>\"", "\[Rule]", 
           RowBox[{"jj", "\[LeftDoubleBracket]", 
            RowBox[{"1", ";;", "iter"}], "\[RightDoubleBracket]"}]}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"\"\<RowIndices\>\"", "\[Rule]", 
           RowBox[{"ii", "\[LeftDoubleBracket]", 
            RowBox[{"1", ";;", "iter"}], "\[RightDoubleBracket]"}]}]}], 
         "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", "]"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{"Options", "\[Rule]", 
      RowBox[{"{", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"\"\<MaxRank\>\"", "\[Rule]", "50"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"\"\<Tolerance\>\"", "\[Rule]", 
         RowBox[{"1.", " ", 
          RowBox[{"10", "^", 
           RowBox[{"-", "4"}]}]}]}], ",", "\[IndentingNewLine]", 
        RowBox[{"\"\<StartingIndex\>\"", "\[Rule]", "1"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"\"\<MaxPivotTrials\>\"", "\[Rule]", "100"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"\"\<PivotThreshold\>\"", "\[Rule]", "$MachineEpsilon"}], ",",
         "\[IndentingNewLine]", 
        RowBox[{"\"\<Weights\>\"", "\[Rule]", "Automatic"}]}], 
       "\[IndentingNewLine]", "}"}]}]}], "\[IndentingNewLine]", "]"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.7948940040151253`*^9, 3.794894004655036*^9}, {
  3.79491963828296*^9, 3.794919642329618*^9}, {3.794919674210891*^9, 
  3.794919797430661*^9}, {3.794919879957573*^9, 3.794919953635084*^9}, {
  3.7949201476188917`*^9, 3.7949201687685833`*^9}, {3.7949203585197563`*^9, 
  3.7949203761810493`*^9}},
 CellLabel->
  "In[128]:=",ExpressionUUID->"9f48f3e4-7308-4057-b647-1a5e5183e2e7"],

Cell[BoxData[
 RowBox[{"\[IndentingNewLine]", "\[IndentingNewLine]"}]], "Input",
 CellChangeTimes->{{3.794894005521734*^9, 3.794894005811121*^9}},
 CellLabel->
  "In[118]:=",ExpressionUUID->"b3ec59a6-011f-4ead-9766-f5a1705864c7"],

Cell[BoxData[
 RowBox[{
  RowBox[{"ACACompression", "=", 
   RowBox[{"PackageFunction", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"ker1_", ",", "ker2_", ",", "ker3_"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
        "a", ",", "b", ",", "c", ",", "u", ",", "v", ",", "w", ",", "U", ",", 
         "V", ",", "W", ",", "\[Alpha]", ",", "\[Beta]", ",", "i", ",", "j", 
         ",", "k", ",", "ijk", ",", "jj", ",", "kk", ",", "\[Delta]", ",", 
         "TOL", ",", "TOL2", ",", "iter", ",", "scale", ",", "test", ",", 
         "norm2", ",", "\[IndentingNewLine]", "pivotthreshold", ",", 
         "outermaxrank", ",", "innermaxrank", ",", "maxpivottrials", ",", 
         "data", ",", "outerpivotfailures", ",", "innerpivotfailures", ",", 
         "aborted", ",", "innererrorestimators"}], "\[IndentingNewLine]", 
        "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{"Print", "[", "\"\<Trivariate backend\>\"", "]"}], ";"}], 
        "*)"}], "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"outerpivotfailures", "=", "0"}], ";", "\[IndentingNewLine]", 
        
        RowBox[{"innerpivotfailures", "=", "0"}], ";", "\[IndentingNewLine]", 
        
        RowBox[{"aborted", "=", "False"}], ";", "\[IndentingNewLine]", 
        RowBox[{"pivotthreshold", "=", 
         RowBox[{"OptionValue", "[", "\"\<PivotThreshold\>\"", "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"outermaxrank", "=", 
         RowBox[{"OptionValue", "[", "\"\<OuterMaxRank\>\"", "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"innermaxrank", "=", 
         RowBox[{"OptionValue", "[", "\"\<InnerMaxRank\>\"", "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"maxpivottrials", "=", 
         RowBox[{"OptionValue", "[", "\"\<MaxPivotTrials\>\"", "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"TOL", "=", 
         RowBox[{"OptionValue", "[", "\"\<Tolerance\>\"", "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"TOL2", "=", 
         RowBox[{"TOL", "^", "2"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"\[Alpha]", "=", 
         RowBox[{"ConstantArray", "[", 
          RowBox[{"1", ",", "outermaxrank"}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"\[Beta]", "=", 
         RowBox[{"ConstantArray", "[", 
          RowBox[{"1", ",", "outermaxrank"}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"innererrorestimators", "=", 
         RowBox[{"ConstantArray", "[", 
          RowBox[{"0.", ",", "outermaxrank"}], "]"}]}], ";", 
        "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"iter", "=", "1"}], ";", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"j", ",", "k"}], "}"}], "=", 
         RowBox[{"OptionValue", "[", "\"\<StartingIndices\>\"", "]"}]}], ";", 
        "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"u", "=", 
         RowBox[{"ker1", "[", 
          RowBox[{"j", ",", "k"}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"i", "=", 
         RowBox[{"IAMAX", "[", "u", "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"data", "=", 
         RowBox[{"ACACompression", "[", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{
            RowBox[{"ker2", "[", 
             RowBox[{"i", ",", "#"}], "]"}], "&"}], ",", 
           RowBox[{
            RowBox[{"ker3", "[", 
             RowBox[{"i", ",", "#"}], "]"}], "&"}], ",", 
           "\[IndentingNewLine]", 
           RowBox[{"Tolerance", "\[Rule]", "TOL"}], ",", 
           RowBox[{"\"\<MaxRank\>\"", "\[Rule]", "innermaxrank"}], ",", 
           RowBox[{"\"\<MaxPivotTrials\>\"", "\[Rule]", "maxpivottrials"}], 
           ",", 
           RowBox[{"\"\<PivotThreshold\>\"", "\[Rule]", "pivotthreshold"}]}], 
          "\[IndentingNewLine]", "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"innerpivotfailures", "+=", 
         RowBox[{"data", "[", "\"\<PivotFailures\>\"", "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
         "innererrorestimators", "\[LeftDoubleBracket]", "iter", 
          "\[RightDoubleBracket]"}], "=", 
         RowBox[{"data", "[", "\"\<RelativeErrorEstimator\>\"", "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"v", "=", 
         RowBox[{"data", "[", "\"\<U\>\"", "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"w", "=", 
         RowBox[{"data", "[", "\"\<V\>\"", "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
         "\[Alpha]", "\[LeftDoubleBracket]", "iter", 
          "\[RightDoubleBracket]"}], "=", "1"}], ";", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
         "\[Beta]", "\[LeftDoubleBracket]", "iter", "\[RightDoubleBracket]"}],
          "=", 
         RowBox[{"Length", "[", "v", "]"}]}], ";", "\[IndentingNewLine]", 
        "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"OptionValue", "[", "\"\<Weights\>\"", "]"}], "===", 
           "Automatic"}], ",", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"a", "=", 
            RowBox[{"ConstantArray", "[", 
             RowBox[{"1.", ",", 
              RowBox[{"Length", "[", "u", "]"}]}], "]"}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"b", "=", 
            RowBox[{"ConstantArray", "[", 
             RowBox[{"1.", ",", 
              RowBox[{
               RowBox[{"Dimensions", "[", "v", "]"}], "\[LeftDoubleBracket]", 
               "2", "\[RightDoubleBracket]"}]}], "]"}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"c", "=", 
            RowBox[{"ConstantArray", "[", 
             RowBox[{"1.", ",", 
              RowBox[{
               RowBox[{"Dimensions", "[", "w", "]"}], "\[LeftDoubleBracket]", 
               "2", "\[RightDoubleBracket]"}]}], "]"}]}], ";"}], 
          "\[IndentingNewLine]", ",", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"a", ",", "b", ",", "c"}], "}"}], "=", 
           RowBox[{"OptionValue", "[", "\"\<Weights\>\"", "]"}]}]}], 
         "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
        RowBox[{"U", "=", 
         RowBox[{"ConstantArray", "[", 
          RowBox[{"0.", ",", 
           RowBox[{"{", 
            RowBox[{"outermaxrank", ",", 
             RowBox[{"Length", "[", "a", "]"}]}], "}"}]}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"V", "=", 
         RowBox[{"ConstantArray", "[", 
          RowBox[{"0.", ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"outermaxrank", " ", "innermaxrank"}], ",", 
             RowBox[{"Length", "[", "b", "]"}]}], "}"}]}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"W", "=", 
         RowBox[{"ConstantArray", "[", 
          RowBox[{"0.", ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"outermaxrank", " ", "innermaxrank"}], ",", 
             RowBox[{"Length", "[", "c", "]"}]}], "}"}]}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"ijk", "=", 
         RowBox[{"ConstantArray", "[", 
          RowBox[{"0", ",", 
           RowBox[{"{", 
            RowBox[{"outermaxrank", ",", "3"}], "}"}]}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"jj", "=", 
         RowBox[{"ConstantArray", "[", 
          RowBox[{"0", ",", 
           RowBox[{"{", 
            RowBox[{"outermaxrank", " ", "innermaxrank"}], "}"}]}], "]"}]}], 
        ";", "\[IndentingNewLine]", 
        RowBox[{"kk", "=", 
         RowBox[{"ConstantArray", "[", 
          RowBox[{"0", ",", 
           RowBox[{"{", 
            RowBox[{"outermaxrank", " ", "innermaxrank"}], "}"}]}], "]"}]}], 
        ";", "\[IndentingNewLine]", 
        RowBox[{"\[Delta]", "=", 
         RowBox[{
         "u", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"scale", "=", 
         RowBox[{
          RowBox[{"1.", "/", 
           RowBox[{"Surd", "[", 
            RowBox[{
             RowBox[{"Abs", "[", "\[Delta]", "]"}], ",", "3"}], "]"}]}], " ", 
          
          RowBox[{"Sign", "[", "\[Delta]", "]"}]}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
         "U", "\[LeftDoubleBracket]", "iter", "\[RightDoubleBracket]"}], "=", 
         
         RowBox[{"u", "=", 
          RowBox[{"u", " ", "scale"}]}]}], ";", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"V", "\[LeftDoubleBracket]", 
          RowBox[{
           RowBox[{
            RowBox[{
            "\[Alpha]", "\[LeftDoubleBracket]", "iter", 
             "\[RightDoubleBracket]"}], ";;", 
            RowBox[{
            "\[Beta]", "\[LeftDoubleBracket]", "iter", 
             "\[RightDoubleBracket]"}]}], ",", "All"}], 
          "\[RightDoubleBracket]"}], "=", 
         RowBox[{"v", "=", 
          RowBox[{"v", " ", "scale"}]}]}], ";", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"W", "\[LeftDoubleBracket]", 
          RowBox[{
           RowBox[{
            RowBox[{
            "\[Alpha]", "\[LeftDoubleBracket]", "iter", 
             "\[RightDoubleBracket]"}], ";;", 
            RowBox[{
            "\[Beta]", "\[LeftDoubleBracket]", "iter", 
             "\[RightDoubleBracket]"}]}], ",", "All"}], 
          "\[RightDoubleBracket]"}], "=", 
         RowBox[{"w", "=", 
          RowBox[{"w", " ", "scale"}]}]}], ";", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"ijk", "\[LeftDoubleBracket]", 
          RowBox[{"iter", ",", "1"}], "\[RightDoubleBracket]"}], "=", "i"}], 
        ";", 
        RowBox[{
         RowBox[{"ijk", "\[LeftDoubleBracket]", 
          RowBox[{"iter", ",", "2"}], "\[RightDoubleBracket]"}], "=", "j"}], 
        ";", 
        RowBox[{
         RowBox[{"ijk", "\[LeftDoubleBracket]", 
          RowBox[{"iter", ",", "3"}], "\[RightDoubleBracket]"}], "=", "k"}], 
        ";", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"jj", "\[LeftDoubleBracket]", 
          RowBox[{
           RowBox[{
           "\[Alpha]", "\[LeftDoubleBracket]", "iter", 
            "\[RightDoubleBracket]"}], ";;", 
           RowBox[{
           "\[Beta]", "\[LeftDoubleBracket]", "iter", 
            "\[RightDoubleBracket]"}]}], "\[RightDoubleBracket]"}], "=", 
         RowBox[{"data", "[", "\"\<RowIndices\>\"", "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"kk", "\[LeftDoubleBracket]", 
          RowBox[{
           RowBox[{
           "\[Alpha]", "\[LeftDoubleBracket]", "iter", 
            "\[RightDoubleBracket]"}], ";;", 
           RowBox[{
           "\[Beta]", "\[LeftDoubleBracket]", "iter", 
            "\[RightDoubleBracket]"}]}], "\[RightDoubleBracket]"}], "=", 
         RowBox[{"data", "[", "\"\<ColumnIndices\>\"", "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"test", "=", 
         RowBox[{"norm2", "=", 
          RowBox[{
           RowBox[{"(", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{"u", "^", "2"}], ")"}], ".", "a"}], ")"}], 
           RowBox[{"Dot", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"(", 
               RowBox[{"v", "^", "2"}], ")"}], ".", "b"}], ",", 
             RowBox[{
              RowBox[{"(", 
               RowBox[{"w", "^", "2"}], ")"}], ".", "c"}]}], "]"}]}]}]}], ";",
         "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"While", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"(", 
            RowBox[{"test", ">", 
             RowBox[{"TOL2", " ", "norm2"}]}], ")"}], "&&", 
           RowBox[{"(", 
            RowBox[{"iter", "<", "outermaxrank"}], ")"}]}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"j", "=", 
            RowBox[{"IAMAX", "[", 
             RowBox[{"ReplacePart", "[", 
              RowBox[{
               RowBox[{"V", "\[LeftDoubleBracket]", 
                RowBox[{
                "\[Beta]", "\[LeftDoubleBracket]", "iter", 
                 "\[RightDoubleBracket]"}], "\[RightDoubleBracket]"}], ",", 
               RowBox[{"j", "\[Rule]", "0."}]}], "]"}], "]"}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"k", "=", 
            RowBox[{"IAMAX", "[", 
             RowBox[{"ReplacePart", "[", 
              RowBox[{
               RowBox[{"W", "\[LeftDoubleBracket]", 
                RowBox[{
                "\[Beta]", "\[LeftDoubleBracket]", "iter", 
                 "\[RightDoubleBracket]"}], "\[RightDoubleBracket]"}], ",", 
               RowBox[{"k", "\[Rule]", "0."}]}], "]"}], "]"}]}], ";", 
           "\[IndentingNewLine]", "\[IndentingNewLine]", 
           RowBox[{"u", "=", 
            RowBox[{"Subtract", "[", 
             RowBox[{
              RowBox[{"ker1", "[", 
               RowBox[{"j", ",", "k"}], "]"}], ",", 
              RowBox[{"Sum", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{
                 "U", "\[LeftDoubleBracket]", "l", "\[RightDoubleBracket]"}], 
                 
                 RowBox[{
                  RowBox[{"V", "\[LeftDoubleBracket]", 
                   RowBox[{
                    RowBox[{
                    RowBox[{
                    "\[Alpha]", "\[LeftDoubleBracket]", "l", 
                    "\[RightDoubleBracket]"}], ";;", 
                    RowBox[{
                    "\[Beta]", "\[LeftDoubleBracket]", "l", 
                    "\[RightDoubleBracket]"}]}], ",", "j"}], 
                   "\[RightDoubleBracket]"}], ".", 
                  RowBox[{"W", "\[LeftDoubleBracket]", 
                   RowBox[{
                    RowBox[{
                    RowBox[{
                    "\[Alpha]", "\[LeftDoubleBracket]", "l", 
                    "\[RightDoubleBracket]"}], ";;", 
                    RowBox[{
                    "\[Beta]", "\[LeftDoubleBracket]", "l", 
                    "\[RightDoubleBracket]"}]}], ",", "k"}], 
                   "\[RightDoubleBracket]"}]}]}], ",", 
                RowBox[{"{", 
                 RowBox[{"l", ",", "1", ",", "iter"}], "}"}]}], "]"}]}], 
             "]"}]}], ";", "\[IndentingNewLine]", 
           RowBox[{"i", "=", 
            RowBox[{"IAMAX", "[", "u", "]"}]}], ";", "\[IndentingNewLine]", 
           RowBox[{"data", "=", 
            RowBox[{"ACACompression", "[", "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{
               RowBox[{"Subtract", "[", 
                RowBox[{
                 RowBox[{"ker2", "[", 
                  RowBox[{"i", ",", "#"}], "]"}], ",", 
                 RowBox[{"Sum", "[", 
                  RowBox[{
                   RowBox[{
                    RowBox[{"U", "\[LeftDoubleBracket]", 
                    RowBox[{"l", ",", "i"}], "\[RightDoubleBracket]"}], 
                    RowBox[{
                    RowBox[{"W", "\[LeftDoubleBracket]", 
                    RowBox[{
                    RowBox[{
                    RowBox[{
                    "\[Alpha]", "\[LeftDoubleBracket]", "l", 
                    "\[RightDoubleBracket]"}], ";;", 
                    RowBox[{
                    "\[Beta]", "\[LeftDoubleBracket]", "l", 
                    "\[RightDoubleBracket]"}]}], ",", "#"}], 
                    "\[RightDoubleBracket]"}], ".", 
                    RowBox[{"V", "\[LeftDoubleBracket]", 
                    RowBox[{
                    RowBox[{
                    "\[Alpha]", "\[LeftDoubleBracket]", "l", 
                    "\[RightDoubleBracket]"}], ";;", 
                    RowBox[{
                    "\[Beta]", "\[LeftDoubleBracket]", "l", 
                    "\[RightDoubleBracket]"}]}], 
                    "\[RightDoubleBracket]"}]}]}], ",", 
                   RowBox[{"{", 
                    RowBox[{"l", ",", "1", ",", "iter"}], "}"}]}], "]"}]}], 
                "]"}], "&"}], ",", "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{"Subtract", "[", 
                RowBox[{
                 RowBox[{"ker3", "[", 
                  RowBox[{"i", ",", "#"}], "]"}], ",", 
                 RowBox[{"Sum", "[", 
                  RowBox[{
                   RowBox[{
                    RowBox[{"U", "\[LeftDoubleBracket]", 
                    RowBox[{"l", ",", "i"}], "\[RightDoubleBracket]"}], 
                    RowBox[{
                    RowBox[{"V", "\[LeftDoubleBracket]", 
                    RowBox[{
                    RowBox[{
                    RowBox[{
                    "\[Alpha]", "\[LeftDoubleBracket]", "l", 
                    "\[RightDoubleBracket]"}], ";;", 
                    RowBox[{
                    "\[Beta]", "\[LeftDoubleBracket]", "l", 
                    "\[RightDoubleBracket]"}]}], ",", "#"}], 
                    "\[RightDoubleBracket]"}], ".", 
                    RowBox[{"W", "\[LeftDoubleBracket]", 
                    RowBox[{
                    RowBox[{
                    "\[Alpha]", "\[LeftDoubleBracket]", "l", 
                    "\[RightDoubleBracket]"}], ";;", 
                    RowBox[{
                    "\[Beta]", "\[LeftDoubleBracket]", "l", 
                    "\[RightDoubleBracket]"}]}], 
                    "\[RightDoubleBracket]"}]}]}], ",", 
                   RowBox[{"{", 
                    RowBox[{"l", ",", "1", ",", "iter"}], "}"}]}], "]"}]}], 
                "]"}], "&"}], ",", "\[IndentingNewLine]", 
              RowBox[{"Tolerance", "\[Rule]", "TOL"}], ",", 
              RowBox[{"\"\<MaxRank\>\"", "\[Rule]", "innermaxrank"}], ",", 
              RowBox[{"\"\<MaxPivotTrials\>\"", "\[Rule]", "maxpivottrials"}],
               ",", 
              RowBox[{
              "\"\<PivotThreshold\>\"", "\[Rule]", "pivotthreshold"}]}], 
             "\[IndentingNewLine]", "]"}]}], ";", "\[IndentingNewLine]", 
           RowBox[{"innerpivotfailures", "+=", 
            RowBox[{"data", "[", "\"\<PivotFailures\>\"", "]"}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{
            "innererrorestimators", "\[LeftDoubleBracket]", "iter", 
             "\[RightDoubleBracket]"}], "=", 
            RowBox[{"data", "[", "\"\<RelativeErrorEstimator\>\"", "]"}]}], 
           ";", "\[IndentingNewLine]", 
           RowBox[{"\[Delta]", "=", 
            RowBox[{
            "u", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}]}], 
           ";", "\[IndentingNewLine]", 
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"Abs", "[", "\[Delta]", "]"}], "<", "pivotthreshold"}], 
             ",", 
             RowBox[{
              RowBox[{"aborted", "=", "True"}], ";", 
              RowBox[{"Break", "[", "]"}]}]}], "]"}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"scale", "=", 
            RowBox[{
             RowBox[{"1.", "/", 
              RowBox[{"Surd", "[", 
               RowBox[{
                RowBox[{"Abs", "[", "\[Delta]", "]"}], ",", "3"}], "]"}]}], 
             " ", 
             RowBox[{"Sign", "[", "\[Delta]", "]"}]}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"iter", "++"}], ";", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{
            "\[Alpha]", "\[LeftDoubleBracket]", "iter", 
             "\[RightDoubleBracket]"}], "=", 
            RowBox[{
             RowBox[{"\[Beta]", "\[LeftDoubleBracket]", 
              RowBox[{"iter", "-", "1"}], "\[RightDoubleBracket]"}], "+", 
             "1"}]}], ";", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{
            "\[Beta]", "\[LeftDoubleBracket]", "iter", 
             "\[RightDoubleBracket]"}], "=", 
            RowBox[{
             RowBox[{"\[Beta]", "\[LeftDoubleBracket]", 
              RowBox[{"iter", "-", "1"}], "\[RightDoubleBracket]"}], "+", 
             RowBox[{"Length", "[", 
              RowBox[{"data", "[", "\"\<V\>\"", "]"}], "]"}]}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"U", "\[LeftDoubleBracket]", 
             RowBox[{"iter", ",", ";;"}], "\[RightDoubleBracket]"}], "=", 
            RowBox[{"u", "=", 
             RowBox[{"u", " ", "scale"}]}]}], ";", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"V", "\[LeftDoubleBracket]", 
             RowBox[{
              RowBox[{
               RowBox[{
               "\[Alpha]", "\[LeftDoubleBracket]", "iter", 
                "\[RightDoubleBracket]"}], ";;", 
               RowBox[{
               "\[Beta]", "\[LeftDoubleBracket]", "iter", 
                "\[RightDoubleBracket]"}]}], ",", "All"}], 
             "\[RightDoubleBracket]"}], "=", 
            RowBox[{"v", "=", 
             RowBox[{
              RowBox[{"data", "[", "\"\<U\>\"", "]"}], " ", "scale"}]}]}], 
           ";", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"W", "\[LeftDoubleBracket]", 
             RowBox[{
              RowBox[{
               RowBox[{
               "\[Alpha]", "\[LeftDoubleBracket]", "iter", 
                "\[RightDoubleBracket]"}], ";;", 
               RowBox[{
               "\[Beta]", "\[LeftDoubleBracket]", "iter", 
                "\[RightDoubleBracket]"}]}], ",", "All"}], 
             "\[RightDoubleBracket]"}], "=", 
            RowBox[{"w", "=", 
             RowBox[{
              RowBox[{"data", "[", "\"\<V\>\"", "]"}], " ", "scale"}]}]}], 
           ";", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"ijk", "\[LeftDoubleBracket]", 
             RowBox[{"iter", ",", "1"}], "\[RightDoubleBracket]"}], "=", 
            "i"}], ";", 
           RowBox[{
            RowBox[{"ijk", "\[LeftDoubleBracket]", 
             RowBox[{"iter", ",", "2"}], "\[RightDoubleBracket]"}], "=", 
            "j"}], ";", 
           RowBox[{
            RowBox[{"ijk", "\[LeftDoubleBracket]", 
             RowBox[{"iter", ",", "3"}], "\[RightDoubleBracket]"}], "=", 
            "k"}], ";", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"jj", "\[LeftDoubleBracket]", 
             RowBox[{
              RowBox[{
              "\[Alpha]", "\[LeftDoubleBracket]", "iter", 
               "\[RightDoubleBracket]"}], ";;", 
              RowBox[{
              "\[Beta]", "\[LeftDoubleBracket]", "iter", 
               "\[RightDoubleBracket]"}]}], "\[RightDoubleBracket]"}], "=", 
            RowBox[{"data", "[", "\"\<RowIndices\>\"", "]"}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"kk", "\[LeftDoubleBracket]", 
             RowBox[{
              RowBox[{
              "\[Alpha]", "\[LeftDoubleBracket]", "iter", 
               "\[RightDoubleBracket]"}], ";;", 
              RowBox[{
              "\[Beta]", "\[LeftDoubleBracket]", "iter", 
               "\[RightDoubleBracket]"}]}], "\[RightDoubleBracket]"}], "=", 
            RowBox[{"data", "[", "\"\<ColumnIndices\>\"", "]"}]}], ";", 
           "\[IndentingNewLine]", "\[IndentingNewLine]", 
           RowBox[{"test", "=", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{
               RowBox[{"(", 
                RowBox[{"u", "^", "2"}], ")"}], ".", "a"}], ")"}], 
             RowBox[{"Dot", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"(", 
                 RowBox[{"v", "^", "2"}], ")"}], ".", "b"}], ",", 
               RowBox[{
                RowBox[{"(", 
                 RowBox[{"w", "^", "2"}], ")"}], ".", "c"}]}], "]"}]}]}], ";",
            "\[IndentingNewLine]", 
           RowBox[{"norm2", "+=", "test"}], 
           RowBox[{"(*", 
            RowBox[{"+", 
             RowBox[{"??", "?"}]}], "*)"}], ";"}]}], "\[IndentingNewLine]", 
         "]"}], ";", "\[IndentingNewLine]", 
        RowBox[{"Association", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"\"\<RelativeErrorEstimator\>\"", "\[Rule]", 
           RowBox[{
            RowBox[{"Sqrt", "[", "test", "]"}], "/", 
            RowBox[{"Sqrt", "[", "norm2", "]"}]}]}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"\"\<InnerRanks\>\"", "\[Rule]", 
           RowBox[{
            RowBox[{"\[Beta]", "\[LeftDoubleBracket]", 
             RowBox[{"1", ";;", "iter"}], "\[RightDoubleBracket]"}], "-", 
            RowBox[{"\[Alpha]", "\[LeftDoubleBracket]", 
             RowBox[{"1", ";;", "iter"}], "\[RightDoubleBracket]"}], "+", 
            "1"}]}], ",", "\[IndentingNewLine]", 
          RowBox[{"\"\<NormEstimator\>\"", "\[Rule]", 
           RowBox[{"Sqrt", "[", "norm2", "]"}]}], ",", "\[IndentingNewLine]", 
          
          RowBox[{"\"\<InnerRelativeErrorEstimators\>\"", "\[Rule]", 
           RowBox[{"innererrorestimators", "\[LeftDoubleBracket]", 
            RowBox[{"1", ";;", "iter"}], "\[RightDoubleBracket]"}]}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{
          "\"\<OuterPivotFailures\>\"", "\[Rule]", "outerpivotfailures"}], 
          ",", "\[IndentingNewLine]", 
          RowBox[{
          "\"\<InnerPivotFailures\>\"", "\[Rule]", "innerpivotfailures"}], 
          ",", "\[IndentingNewLine]", 
          RowBox[{"\"\<Aborted\>\"", "\[Rule]", "aborted"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"\"\<U\>\"", "\[Rule]", 
           RowBox[{"U", "\[LeftDoubleBracket]", 
            RowBox[{"1", ";;", "iter"}], "\[RightDoubleBracket]"}]}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"\"\<V\>\"", "\[Rule]", 
           RowBox[{"V", "\[LeftDoubleBracket]", 
            RowBox[{"1", ";;", 
             RowBox[{
             "\[Beta]", "\[LeftDoubleBracket]", "iter", 
              "\[RightDoubleBracket]"}]}], "\[RightDoubleBracket]"}]}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"\"\<W\>\"", "\[Rule]", 
           RowBox[{"W", "\[LeftDoubleBracket]", 
            RowBox[{"1", ";;", 
             RowBox[{
             "\[Beta]", "\[LeftDoubleBracket]", "iter", 
              "\[RightDoubleBracket]"}]}], "\[RightDoubleBracket]"}]}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"\"\<\[Alpha]\>\"", "\[Rule]", 
           RowBox[{"\[Alpha]", "\[LeftDoubleBracket]", 
            RowBox[{"1", ";;", "iter"}], "\[RightDoubleBracket]"}]}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"\"\<\[Beta]\>\"", "\[Rule]", 
           RowBox[{"\[Beta]", "\[LeftDoubleBracket]", 
            RowBox[{"1", ";;", "iter"}], "\[RightDoubleBracket]"}]}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"\"\<IndexTriples\>\"", "\[Rule]", 
           RowBox[{"ijk", "\[LeftDoubleBracket]", 
            RowBox[{"1", ";;", "iter"}], "\[RightDoubleBracket]"}]}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"\"\<ColumnIndices\>\"", "\[Rule]", 
           RowBox[{"kk", "\[LeftDoubleBracket]", 
            RowBox[{"1", ";;", 
             RowBox[{
             "\[Beta]", "\[LeftDoubleBracket]", "iter", 
              "\[RightDoubleBracket]"}]}], "\[RightDoubleBracket]"}]}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"\"\<RowIndices\>\"", "\[Rule]", 
           RowBox[{"jj", "\[LeftDoubleBracket]", 
            RowBox[{"1", ";;", 
             RowBox[{
             "\[Beta]", "\[LeftDoubleBracket]", "iter", 
              "\[RightDoubleBracket]"}]}], "\[RightDoubleBracket]"}]}]}], 
         "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", "]"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{"Options", "\[Rule]", 
      RowBox[{"{", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"\"\<OuterMaxRank\>\"", "\[Rule]", "10"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"\"\<InnerMaxRank\>\"", "\[Rule]", "10"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"\"\<Tolerance\>\"", "\[Rule]", 
         RowBox[{"1.", " ", 
          RowBox[{"10", "^", 
           RowBox[{"-", "4"}]}]}]}], ",", "\[IndentingNewLine]", 
        RowBox[{"\"\<StartingIndices\>\"", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{"1", ",", "1"}], "}"}]}], ",", "\[IndentingNewLine]", 
        RowBox[{"\"\<MaxPivotTrials\>\"", "\[Rule]", "100"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"\"\<Weights\>\"", "\[Rule]", "Automatic"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"\"\<PivotThreshold\>\"", "\[Rule]", "$MachineEpsilon"}]}], 
       "\[IndentingNewLine]", "}"}]}]}], "\[IndentingNewLine]", "]"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{
  3.79489401708967*^9, {3.794920109382841*^9, 3.794920125374567*^9}, {
   3.794920156013989*^9, 3.794920160748396*^9}, 3.794920380639935*^9, {
   3.7949204353854322`*^9, 3.794920435839006*^9}, {3.794920477441544*^9, 
   3.7949204860635147`*^9}, {3.794920599852126*^9, 3.794920600154413*^9}},
 CellLabel->
  "In[133]:=",ExpressionUUID->"76961a3b-73f3-498b-8eba-4b6c2dc04946"],

Cell[BoxData[
 RowBox[{"\[IndentingNewLine]", "\[IndentingNewLine]"}]], "Input",
 CellChangeTimes->{{3.772725470709968*^9, 3.77272547087782*^9}},
 CellLabel->
  "In[120]:=",ExpressionUUID->"d7da8014-66d3-421a-ab5a-f556a7ef6778"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"ACASymmetricCompression", "=", 
   RowBox[{"PackageFunction", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"A_", "?", "MatrixQ"}], ",", 
       RowBox[{"opts", ":", 
        RowBox[{"OptionsPattern", "[", "]"}]}]}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{"ACASymmetricCompression", "[", 
      RowBox[{
       RowBox[{"Diagonal", "[", "A", "]"}], ",", 
       RowBox[{"i", "\[Function]", 
        RowBox[{"A", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}]}],
        ",", "opts"}], "]"}]}], "\[IndentingNewLine]", "]"}]}], 
  "\[IndentingNewLine]"}], "\n", 
 RowBox[{"ACASymmetricCompression", "=", 
  RowBox[{"PackageFunction", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"diag_", ",", "row_"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "eps", ",", "maxiter", ",", "maxrank", ",", "TOL", ",", "A", ",", "i", 
        ",", "d", ",", "\[Epsilon]", ",", "n", ",", "k", ",", "ik", ",", 
        "\[Epsilon]k"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"eps", "=", "$MachineEpsilon"}], ";", "\[IndentingNewLine]", 
       RowBox[{"maxrank", "=", 
        RowBox[{"OptionValue", "[", "\"\<MaxRank\>\"", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"TOL", "=", 
        RowBox[{"OptionValue", "[", "\"\<Tolerance\>\"", "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"d", "=", 
        RowBox[{"ToPack", "[", 
         RowBox[{"Normal", "[", 
          RowBox[{"N", "[", "diag", "]"}], "]"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"n", "=", 
        RowBox[{"Length", "[", "diag", "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"A", "=", 
        RowBox[{"ConstantArray", "[", 
         RowBox[{"0.", ",", 
          RowBox[{"{", 
           RowBox[{"maxrank", ",", "n"}], "}"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"i", "=", 
        RowBox[{"ConstantArray", "[", 
         RowBox[{"0", ",", "maxrank"}], "]"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"TOL", "=", 
        RowBox[{"1.", " ", 
         RowBox[{"10", "^", 
          RowBox[{"-", "15"}]}]}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"k", "=", "0"}], ";", "\[IndentingNewLine]", 
       RowBox[{"ik", "=", 
        RowBox[{"IAMAX", "[", "d", "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"\[Epsilon]k", "=", 
        RowBox[{
        "d", "\[LeftDoubleBracket]", "ik", "\[RightDoubleBracket]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"++", "k"}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"i", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}], 
        "=", "ik"}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"A", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}], 
        "=", 
        RowBox[{
         RowBox[{"row", "[", "ik", "]"}], "/", 
         RowBox[{"Sqrt", "[", "\[Epsilon]k", "]"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"d", "=", 
        RowBox[{"d", "-", 
         RowBox[{
          RowBox[{"A", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}],
           "^", "2"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"ik", "=", 
        RowBox[{"IAMAX", "[", "d", "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"\[Epsilon]k", "=", 
        RowBox[{
        "d", "\[LeftDoubleBracket]", "ik", "\[RightDoubleBracket]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"\[Epsilon]k", ">", "TOL"}], "&&", 
          RowBox[{"k", "<", "maxrank"}]}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"++", "k"}], ";", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{
           "i", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}], "=", 
           "ik"}], ";", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{
           "A", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}], "=", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{
              RowBox[{"row", "[", "ik", "]"}], "-", 
              RowBox[{
               RowBox[{"A", "\[LeftDoubleBracket]", 
                RowBox[{
                 RowBox[{"1", ";;", 
                  RowBox[{"k", "-", "1"}]}], ",", "ik"}], 
                "\[RightDoubleBracket]"}], ".", 
               RowBox[{"A", "\[LeftDoubleBracket]", 
                RowBox[{"1", ";;", 
                 RowBox[{"k", "-", "1"}]}], "\[RightDoubleBracket]"}]}]}], 
             ")"}], "/", 
            RowBox[{"Sqrt", "[", "\[Epsilon]k", "]"}]}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"d", "=", 
           RowBox[{"d", "-", 
            RowBox[{
             RowBox[{
             "A", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}], "^",
              "2"}]}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"ik", "=", 
           RowBox[{"IAMAX", "[", "d", "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"\[Epsilon]k", "=", 
           RowBox[{
           "d", "\[LeftDoubleBracket]", "ik", "\[RightDoubleBracket]"}]}], 
          ";"}]}], "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"\[Epsilon]k", "<", 
          RowBox[{"-", 
           RowBox[{"OptionValue", "[", "\"\<WarningTolerance\>\"", "]"}]}]}], 
         ",", 
         RowBox[{"Print", "[", 
          RowBox[{
          "\"\<Warning: Negative pivot element detected. Pivot = \>\"", ",", 
           "\[Epsilon]k"}], "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"A", "\[LeftDoubleBracket]", 
          RowBox[{"1", ";;", "k"}], "\[RightDoubleBracket]"}], ",", 
         RowBox[{"i", "\[LeftDoubleBracket]", 
          RowBox[{"1", ";;", "k"}], "\[RightDoubleBracket]"}], ",", 
         RowBox[{"{", 
          RowBox[{"d", ",", "ik"}], "}"}]}], "}"}]}]}], "\[IndentingNewLine]",
      "]"}], ",", "\[IndentingNewLine]", 
    RowBox[{"Options", "\[Rule]", 
     RowBox[{"{", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"\"\<MaxRank\>\"", "\[Rule]", "50"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"\"\<Tolerance\>\"", "\[Rule]", 
        RowBox[{"1.", " ", 
         RowBox[{"10", "^", 
          RowBox[{"-", "8"}]}]}]}], ",", "\[IndentingNewLine]", 
       RowBox[{"\"\<WarningTolerance\>\"", "\[Rule]", " ", 
        RowBox[{"1.", " ", 
         RowBox[{"10", "^", 
          RowBox[{"-", "12"}]}]}]}]}], "\[IndentingNewLine]", "}"}]}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{
    "Description", "\[Rule]", 
     "\"\<Liu, Matthies -- Pivoted Cholesky decomposition by cross \
approximation for efficient solution of kernel systems\n\nrelated:\n\n\
Harbrecht, Peters, Schneider - On the low-rank approximation by the pivoted \
Cholesky decomposition.pdf\n\>\""}]}], "\[IndentingNewLine]", 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.7567148292126913`*^9, 3.756714859380031*^9}, {
   3.7568922066908503`*^9, 3.756892225800558*^9}, 3.77270845834239*^9, {
   3.772725091393546*^9, 3.772725363337019*^9}, {3.7727254111644497`*^9, 
   3.772725450433213*^9}, {3.7729157916191597`*^9, 3.772915795177732*^9}, {
   3.772916040288267*^9, 3.772916042512282*^9}, {3.772916141115857*^9, 
   3.7729161431939287`*^9}, {3.7729162272252293`*^9, 3.772916250014347*^9}, {
   3.7729164104599237`*^9, 3.772916458760149*^9}, {3.772928259351818*^9, 
   3.77292826761012*^9}, 3.772928302329246*^9},
 CellLabel->
  "In[1999]:=",ExpressionUUID->"2f478178-18b3-4952-9d58-787a63a65756"],

Cell[BoxData[
 RowBox[{"(*", 
  RowBox[{"ACACompressionIndicesOld", "=", 
   RowBox[{
    RowBox[{
     RowBox[{"PackageFunction", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"A_", "?", "MatrixQ"}], ",", 
         RowBox[{"opts", ":", 
          RowBox[{"OptionsPattern", "[", "]"}]}]}], "}"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"ACACompressionIndicesOld", "[", 
        RowBox[{
         RowBox[{"i", "\[Function]", 
          RowBox[{
          "A", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}]}], ",", 
         
         RowBox[{"j", "\[Function]", 
          RowBox[{"A", "\[LeftDoubleBracket]", 
           RowBox[{"All", ",", "j"}], "\[RightDoubleBracket]"}]}], ",", 
         "opts"}], "]"}]}], "\[IndentingNewLine]", "]"}], 
     "\[IndentingNewLine]", "ACACompressionIndicesOld"}], "=", 
    RowBox[{"PackageFunction", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"row_", ",", "column_"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{"Module", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
         "maxrank", ",", "\[Epsilon]", ",", "recompressionQ", ",", "maxiter", 
          ",", "\[IndentingNewLine]", "u", ",", "v", ",", "k", ",", "ik", ",",
           "jk", ",", "uk", ",", "vk", ",", "test", ",", "norm2", ",", 
          "\[Delta]", ",", "w", ",", "iter", ",", "uQ", ",", "uR", ",", "vQ", 
          ",", "vR", ",", "U", ",", "\[CapitalSigma]", ",", "V", ",", "rank", 
          ",", "\[Sigma]", ",", "m", ",", "n", ",", "eps", ",", "ibag", ",", 
          "jbag", ",", "scale"}], "}"}], ",", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"eps", "=", "$MachineEpsilon"}], ";", "\[IndentingNewLine]", 
         
         RowBox[{"maxiter", "=", 
          RowBox[{"OptionValue", "[", "\"\<MaxPivotTrials\>\"", "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"maxrank", "=", 
          RowBox[{"OptionValue", "[", "\"\<MaxRank\>\"", "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"\[Epsilon]", "=", 
          RowBox[{"OptionValue", "[", "\"\<Tolerance\>\"", "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"recompressionQ", "=", 
          RowBox[{"OptionValue", "[", "\"\<Recompression\>\"", "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"k", "=", "1"}], ";", "\[IndentingNewLine]", 
         RowBox[{"ik", "=", 
          RowBox[{"OptionValue", "[", "\"\<StartingIndex\>\"", "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"vk", "=", 
          RowBox[{"row", "[", "ik", "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"m", "=", 
          RowBox[{"Length", "[", "vk", "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"v", "=", 
          RowBox[{"ConstantArray", "[", 
           RowBox[{"0.", ",", 
            RowBox[{"{", 
             RowBox[{"maxrank", ",", "m"}], "}"}]}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"jk", "=", 
          RowBox[{"IAMAX", "[", "vk", "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"uk", "=", 
          RowBox[{"column", "[", "jk", "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"n", "=", 
          RowBox[{"Length", "[", "uk", "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"u", "=", 
          RowBox[{"ConstantArray", "[", 
           RowBox[{"0.", ",", 
            RowBox[{"{", 
             RowBox[{"maxrank", ",", "n"}], "}"}]}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"\[Delta]", "=", 
          RowBox[{
          "vk", "\[LeftDoubleBracket]", "jk", "\[RightDoubleBracket]"}]}], 
         ";", "\[IndentingNewLine]", 
         RowBox[{"scale", "=", 
          RowBox[{"1.", "/", 
           RowBox[{"Sqrt", "[", 
            RowBox[{"Abs", "[", "\[Delta]", "]"}], "]"}]}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"v", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}],
           "=", 
          RowBox[{"vk", "=", 
           RowBox[{"vk", " ", "scale", " ", 
            RowBox[{"Sign", "[", "\[Delta]", "]"}]}]}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"u", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}],
           "=", 
          RowBox[{"uk", " ", "=", 
           RowBox[{"uk", " ", "scale"}]}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"test", "=", 
          RowBox[{
           RowBox[{"uk", ".", "uk"}], " ", 
           RowBox[{"vk", ".", "vk"}]}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"norm2", "=", "test"}], ";", "\[IndentingNewLine]", 
         RowBox[{"ibag", "=", 
          RowBox[{"Internal`Bag", "[", 
           RowBox[{"{", "ik", "}"}], "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"jbag", "=", 
          RowBox[{"Internal`Bag", "[", 
           RowBox[{"{", "jk", "}"}], "]"}]}], ";", "\[IndentingNewLine]", 
         "\[IndentingNewLine]", 
         RowBox[{"maxrank", "=", 
          RowBox[{"Min", "[", 
           RowBox[{"m", ",", "n", ",", "maxrank"}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"While", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"test", ">", 
             RowBox[{
              RowBox[{"\[Epsilon]", "^", "2"}], " ", "norm2"}]}], "&&", 
            RowBox[{"k", "<", "maxrank"}]}], ",", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"k", "++"}], ";", "\[IndentingNewLine]", 
            RowBox[{"ik", "=", 
             RowBox[{"IAMAX", "[", "uk", "]"}]}], ";", "\[IndentingNewLine]", 
            
            RowBox[{"vk", "=", 
             RowBox[{"Subtract", "[", 
              RowBox[{
               RowBox[{"row", "[", "ik", "]"}], ",", 
               RowBox[{
                RowBox[{"u", "\[LeftDoubleBracket]", 
                 RowBox[{
                  RowBox[{";;", 
                   RowBox[{"k", "-", "1"}]}], ",", "ik"}], 
                 "\[RightDoubleBracket]"}], ".", 
                RowBox[{"v", "\[LeftDoubleBracket]", 
                 RowBox[{";;", 
                  RowBox[{"k", "-", "1"}]}], "\[RightDoubleBracket]"}]}]}], 
              "]"}]}], ";", "\[IndentingNewLine]", 
            RowBox[{"jk", "=", 
             RowBox[{"IAMAX", "[", "vk", "]"}]}], ";", "\[IndentingNewLine]", 
            
            RowBox[{"\[Delta]", "=", 
             RowBox[{
             "vk", "\[LeftDoubleBracket]", "jk", "\[RightDoubleBracket]"}]}], 
            ";", "\[IndentingNewLine]", 
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"Abs", "[", "\[Delta]", "]"}], "<", "eps"}], ",", 
              "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{"w", "=", "uk"}], ";", "\[IndentingNewLine]", 
               RowBox[{"\[Delta]", "=", "0."}], ";", "\[IndentingNewLine]", 
               RowBox[{"iter", "=", "0"}], ";", "\[IndentingNewLine]", 
               RowBox[{"While", "[", 
                RowBox[{
                 RowBox[{
                  RowBox[{
                   RowBox[{"Abs", "[", "\[Delta]", "]"}], "<", "eps"}], "&&", 
                  
                  RowBox[{"iter", "<", "maxiter"}]}], ",", 
                 "\[IndentingNewLine]", 
                 RowBox[{
                  RowBox[{"iter", "++"}], ";", "\[IndentingNewLine]", 
                  RowBox[{
                   RowBox[{
                   "w", "\[LeftDoubleBracket]", "ik", 
                    "\[RightDoubleBracket]"}], "=", "0."}], ";", 
                  "\[IndentingNewLine]", 
                  RowBox[{"ik", "=", 
                   RowBox[{"IAMAX", "[", "w", "]"}]}], ";", 
                  "\[IndentingNewLine]", 
                  RowBox[{"vk", "=", 
                   RowBox[{"Subtract", "[", 
                    RowBox[{
                    RowBox[{"row", "[", "ik", "]"}], ",", 
                    RowBox[{
                    RowBox[{"u", "\[LeftDoubleBracket]", 
                    RowBox[{
                    RowBox[{";;", 
                    RowBox[{"k", "-", "1"}]}], ",", "ik"}], 
                    "\[RightDoubleBracket]"}], ".", 
                    RowBox[{"v", "\[LeftDoubleBracket]", 
                    RowBox[{";;", 
                    RowBox[{"k", "-", "1"}]}], "\[RightDoubleBracket]"}]}]}], 
                    "]"}]}], ";", "\[IndentingNewLine]", 
                  RowBox[{"jk", "=", 
                   RowBox[{"IAMAX", "[", "vk", "]"}]}], ";", 
                  "\[IndentingNewLine]", 
                  RowBox[{"\[Delta]", "=", 
                   RowBox[{
                   "vk", "\[LeftDoubleBracket]", "jk", 
                    "\[RightDoubleBracket]"}]}], ";"}]}], 
                "\[IndentingNewLine]", "]"}], ";"}]}], "\[IndentingNewLine]", 
             "]"}], ";", "\[IndentingNewLine]", 
            RowBox[{"uk", "=", 
             RowBox[{"Subtract", "[", 
              RowBox[{
               RowBox[{"column", "[", "jk", "]"}], ",", 
               RowBox[{
                RowBox[{"v", "\[LeftDoubleBracket]", 
                 RowBox[{
                  RowBox[{";;", 
                   RowBox[{"k", "-", "1"}]}], ",", "jk"}], 
                 "\[RightDoubleBracket]"}], ".", 
                RowBox[{"u", "\[LeftDoubleBracket]", 
                 RowBox[{";;", 
                  RowBox[{"k", "-", "1"}]}], "\[RightDoubleBracket]"}]}]}], 
              "]"}]}], ";", "\[IndentingNewLine]", 
            RowBox[{"scale", "=", 
             RowBox[{"1.", "/", 
              RowBox[{"Sqrt", "[", 
               RowBox[{"Abs", "[", "\[Delta]", "]"}], "]"}]}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{
             "v", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}], "=", 
             RowBox[{"vk", "=", 
              RowBox[{"vk", " ", "scale", " ", 
               RowBox[{"Sign", "[", "\[Delta]", "]"}]}]}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{
             "u", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}], "=", 
             RowBox[{"uk", " ", "=", 
              RowBox[{"uk", " ", "scale"}]}]}], ";", "\[IndentingNewLine]", 
            RowBox[{"test", "=", 
             RowBox[{
              RowBox[{"uk", ".", "uk"}], " ", 
              RowBox[{"vk", ".", "vk"}]}]}], ";", "\[IndentingNewLine]", 
            RowBox[{"norm2", "+=", 
             RowBox[{"test", "+", 
              RowBox[{"Dot", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{"u", "\[LeftDoubleBracket]", 
                  RowBox[{"1", ";;", 
                   RowBox[{"k", "-", "1"}]}], "\[RightDoubleBracket]"}], ".", 
                 "uk"}], ",", 
                RowBox[{
                 RowBox[{"v", "\[LeftDoubleBracket]", 
                  RowBox[{"1", ";;", 
                   RowBox[{"k", "-", "1"}]}], "\[RightDoubleBracket]"}], ".", 
                 "vk"}]}], "]"}]}]}], ";", "\[IndentingNewLine]", 
            RowBox[{"Internal`StuffBag", "[", 
             RowBox[{"ibag", ",", "ik"}], "]"}], ";", "\[IndentingNewLine]", 
            RowBox[{"Internal`StuffBag", "[", 
             RowBox[{"jbag", ",", "jk"}], "]"}], ";"}]}], 
          "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
         "\[IndentingNewLine]", 
         RowBox[{"If", "[", 
          RowBox[{"recompressionQ", ",", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{
             RowBox[{"{", 
              RowBox[{"uQ", ",", "uR"}], "}"}], "=", 
             RowBox[{"QRDecomposition", "[", 
              RowBox[{"Transpose", "[", 
               RowBox[{"u", "\[LeftDoubleBracket]", 
                RowBox[{"1", ";;", "k"}], "\[RightDoubleBracket]"}], "]"}], 
              "]"}]}], ";", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"vQ", ",", "vR"}], "}"}], "=", 
             RowBox[{"QRDecomposition", "[", 
              RowBox[{"Transpose", "[", 
               RowBox[{"v", "\[LeftDoubleBracket]", 
                RowBox[{"1", ";;", "k"}], "\[RightDoubleBracket]"}], "]"}], 
              "]"}]}], ";", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"U", ",", "\[CapitalSigma]", ",", "V"}], "}"}], "=", 
             RowBox[{"SingularValueDecomposition", "[", 
              RowBox[{"uR", ".", 
               RowBox[{"Transpose", "[", "vR", "]"}]}], "]"}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"\[Sigma]", "=", 
             RowBox[{"Diagonal", "[", "\[CapitalSigma]", "]"}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"rank", "=", 
             RowBox[{"Total", "[", 
              RowBox[{"UnitStep", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{
                  RowBox[{"#", "/", 
                   RowBox[{
                   "#", "\[LeftDoubleBracket]", "1", 
                    "\[RightDoubleBracket]"}]}], "&"}], "@", "\[Sigma]"}], 
                "-", 
                RowBox[{"\[Epsilon]", "/", "4"}]}], "]"}], "]"}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"{", "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{
               RowBox[{"Transpose", "[", 
                RowBox[{"U", "\[LeftDoubleBracket]", 
                 RowBox[{"All", ",", 
                  RowBox[{"1", ";;", "rank"}]}], "\[RightDoubleBracket]"}], 
                "]"}], ".", "uQ"}], ",", "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{"(", 
                RowBox[{
                 RowBox[{"\[Sigma]", "\[LeftDoubleBracket]", 
                  RowBox[{"1", ";;", "rank"}], "\[RightDoubleBracket]"}], 
                 RowBox[{"Transpose", "[", 
                  RowBox[{"V", "\[LeftDoubleBracket]", 
                   RowBox[{"All", ",", 
                    RowBox[{"1", ";;", "rank"}]}], "\[RightDoubleBracket]"}], 
                  "]"}]}], ")"}], ".", "vQ"}]}], "\[IndentingNewLine]", 
             "}"}]}], ",", "\[IndentingNewLine]", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"u", "\[LeftDoubleBracket]", 
              RowBox[{"1", ";;", "k"}], "\[RightDoubleBracket]"}], ",", 
             RowBox[{"v", "\[LeftDoubleBracket]", 
              RowBox[{"1", ";;", "k"}], "\[RightDoubleBracket]"}], ",", 
             RowBox[{"Internal`BagPart", "[", 
              RowBox[{"ibag", ",", "All"}], "]"}], ",", 
             RowBox[{"Internal`BagPart", "[", 
              RowBox[{"jbag", ",", "All"}], "]"}]}], "}"}]}], 
          "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", "]"}], ",",
       "\[IndentingNewLine]", 
      RowBox[{"Options", "\[Rule]", 
       RowBox[{"{", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"\"\<MaxRank\>\"", "\[Rule]", "50"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"\"\<Tolerance\>\"", "\[Rule]", 
          RowBox[{"1.", " ", 
           RowBox[{"10", "^", 
            RowBox[{"-", "4"}]}]}]}], ",", "\[IndentingNewLine]", 
         RowBox[{"\"\<Recompression\>\"", "\[Rule]", "False"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"\"\<StartingIndex\>\"", "\[Rule]", "1"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"\"\<MaxPivotTrials\>\"", "\[Rule]", "100"}]}], 
        "\[IndentingNewLine]", "}"}]}]}], "\[IndentingNewLine]", "]"}]}]}], 
  "*)"}]], "Input",
 CellChangeTimes->CompressedData["
1:eJxTTMoPSmViYGCQAGIQzXywyYjz72vHw3I93iB6x5vtYSD6HHtNFIh+5fhr
EYh2YI9eAqL3Sy9fA6J/Nc5eC6LTvsg+ANGNS2UfgeiVSzI28QLppaeOg2k3
cZ/dIHqWUgGYjmruOwCiMyY+OQ6iz9lfPAOi/y0TugCiP8WufgGif34/Aqb9
Cr1NRIC0wru3piDa8kGbFYietEfcDkQfesDuBKJPHOQH09y/Pfv0gHTp2tS5
IFoleNrLVCC9LmXuKxD9WOLGrlwgHZubvRtEr729wofh32vHVU0bwfQkpsfG
VvxvHNsSIs1AtOaP24L3pd84Gog8AtNyoa/0mRTeOJbULzQA0RMEb83mcnvj
mNf1ZAGInlT5UlEYSIvZmSuB6Le9bOogeochD5gu4H2opw+kues09UE0ALTp
xXA=
  "],
 CellLabel->
  "In[316]:=",ExpressionUUID->"535e9b65-cec7-4b4d-8946-4a4473796847"],

Cell[BoxData[""], "Input",
 CellChangeTimes->{{3.794893235057353*^9, 3.794893240211958*^9}},
 CellLabel->
  "In[331]:=",ExpressionUUID->"8dd2d07a-d3de-468d-9655-bf954f1f0cb2"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"ACACompressionOld", "[", 
     RowBox[{"ker_", ",", 
      RowBox[{"{", 
       RowBox[{"x_", ",", "y_"}], "}"}], ",", 
      RowBox[{"opts", ":", 
       RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
    RowBox[{"ACACompressionOld", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"j", "\[Function]", 
       RowBox[{"ker", "[", 
        RowBox[{"x", ",", 
         RowBox[{
         "y", "\[LeftDoubleBracket]", "j", "\[RightDoubleBracket]"}]}], 
        "]"}]}], ",", "\[IndentingNewLine]", 
      RowBox[{"i", "\[Function]", 
       RowBox[{"ker", "[", 
        RowBox[{
         RowBox[{"x", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], 
         ",", "y"}], "]"}]}], ",", "\[IndentingNewLine]", "opts"}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ACACompressionOld", "=", 
    RowBox[{"PackageFunction", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"A_", "?", "MatrixQ"}], ",", 
        RowBox[{"opts", ":", 
         RowBox[{"OptionsPattern", "[", "]"}]}]}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"ACACompressionOld", "[", 
       RowBox[{
        RowBox[{"i", "\[Function]", 
         RowBox[{
         "A", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}]}], ",", 
        RowBox[{"j", "\[Function]", 
         RowBox[{"A", "\[LeftDoubleBracket]", 
          RowBox[{"All", ",", "j"}], "\[RightDoubleBracket]"}]}], ",", 
        "opts"}], "]"}]}], "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ACACompressionOld", "=", 
    RowBox[{"PackageFunction", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"row_", ",", "column_"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{"Module", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
         "maxrank", ",", "\[Epsilon]", ",", "recompressionQ", ",", "maxiter", 
          ",", "\[IndentingNewLine]", "u", ",", "v", ",", "k", ",", "ik", ",",
           "jk", ",", "uk", ",", "vk", ",", "test", ",", "norm2", ",", 
          "\[Delta]", ",", "w", ",", "iter", ",", "uQ", ",", "uR", ",", "vQ", 
          ",", "vR", ",", "U", ",", "\[CapitalSigma]", ",", "V", ",", "rank", 
          ",", "\[Sigma]", ",", "m", ",", "n", ",", "eps", ",", "scale"}], 
         "}"}], ",", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"eps", "=", "$MachineEpsilon"}], ";", "\[IndentingNewLine]", 
         
         RowBox[{"maxiter", "=", 
          RowBox[{"OptionValue", "[", "\"\<MaxPivotTrials\>\"", "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"maxrank", "=", 
          RowBox[{"OptionValue", "[", "\"\<MaxRank\>\"", "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"\[Epsilon]", "=", 
          RowBox[{"OptionValue", "[", "\"\<Tolerance\>\"", "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"recompressionQ", "=", 
          RowBox[{"OptionValue", "[", "\"\<Recompression\>\"", "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"k", "=", "1"}], ";", "\[IndentingNewLine]", 
         RowBox[{"ik", "=", 
          RowBox[{"OptionValue", "[", "\"\<StartingIndex\>\"", "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"vk", "=", 
          RowBox[{"row", "[", "ik", "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"m", "=", 
          RowBox[{"Length", "[", "vk", "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"v", "=", 
          RowBox[{"ConstantArray", "[", 
           RowBox[{"0.", ",", 
            RowBox[{"{", 
             RowBox[{"maxrank", ",", "m"}], "}"}]}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"jk", "=", 
          RowBox[{"IAMAX", "[", "vk", "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"uk", "=", 
          RowBox[{"column", "[", "jk", "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"n", "=", 
          RowBox[{"Length", "[", "uk", "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"u", "=", 
          RowBox[{"ConstantArray", "[", 
           RowBox[{"0.", ",", 
            RowBox[{"{", 
             RowBox[{"maxrank", ",", "n"}], "}"}]}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"\[Delta]", "=", 
          RowBox[{
          "vk", "\[LeftDoubleBracket]", "jk", "\[RightDoubleBracket]"}]}], 
         ";", "\[IndentingNewLine]", 
         RowBox[{"scale", "=", 
          RowBox[{"1.", "/", 
           RowBox[{"Sqrt", "[", 
            RowBox[{"Abs", "[", "\[Delta]", "]"}], "]"}]}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"v", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}],
           "=", 
          RowBox[{"vk", "=", 
           RowBox[{"vk", " ", "scale", " ", 
            RowBox[{"Sign", "[", "\[Delta]", "]"}]}]}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"u", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}],
           "=", 
          RowBox[{"uk", " ", "=", 
           RowBox[{"uk", " ", "scale"}]}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"test", "=", 
          RowBox[{
           RowBox[{"uk", ".", "uk"}], " ", 
           RowBox[{"vk", ".", "vk"}]}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"norm2", "=", "test"}], ";", "\[IndentingNewLine]", 
         "\[IndentingNewLine]", 
         RowBox[{"maxrank", "=", 
          RowBox[{"Min", "[", 
           RowBox[{"m", ",", "n", ",", "maxrank"}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"While", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"test", ">", 
             RowBox[{
              RowBox[{"\[Epsilon]", "^", "2"}], " ", "norm2"}]}], "&&", 
            RowBox[{"k", "<", "maxrank"}]}], ",", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"k", "++"}], ";", "\[IndentingNewLine]", 
            RowBox[{"ik", "=", 
             RowBox[{"IAMAX", "[", "uk", "]"}]}], ";", "\[IndentingNewLine]", 
            
            RowBox[{"vk", "=", 
             RowBox[{"Subtract", "[", 
              RowBox[{
               RowBox[{"row", "[", "ik", "]"}], ",", 
               RowBox[{
                RowBox[{"u", "\[LeftDoubleBracket]", 
                 RowBox[{
                  RowBox[{";;", 
                   RowBox[{"k", "-", "1"}]}], ",", "ik"}], 
                 "\[RightDoubleBracket]"}], ".", 
                RowBox[{"v", "\[LeftDoubleBracket]", 
                 RowBox[{";;", 
                  RowBox[{"k", "-", "1"}]}], "\[RightDoubleBracket]"}]}]}], 
              "]"}]}], ";", "\[IndentingNewLine]", 
            RowBox[{"jk", "=", 
             RowBox[{"IAMAX", "[", "vk", "]"}]}], ";", "\[IndentingNewLine]", 
            
            RowBox[{"\[Delta]", "=", 
             RowBox[{
             "vk", "\[LeftDoubleBracket]", "jk", "\[RightDoubleBracket]"}]}], 
            ";", "\[IndentingNewLine]", 
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"Abs", "[", "\[Delta]", "]"}], "<", "eps"}], ",", 
              "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{"w", "=", "uk"}], ";", "\[IndentingNewLine]", 
               RowBox[{"\[Delta]", "=", "0."}], ";", "\[IndentingNewLine]", 
               RowBox[{"iter", "=", "0"}], ";", "\[IndentingNewLine]", 
               RowBox[{"While", "[", 
                RowBox[{
                 RowBox[{
                  RowBox[{
                   RowBox[{"Abs", "[", "\[Delta]", "]"}], "<", "eps"}], "&&", 
                  
                  RowBox[{"iter", "<", "maxiter"}]}], ",", 
                 "\[IndentingNewLine]", 
                 RowBox[{
                  RowBox[{"iter", "++"}], ";", "\[IndentingNewLine]", 
                  RowBox[{
                   RowBox[{
                   "w", "\[LeftDoubleBracket]", "ik", 
                    "\[RightDoubleBracket]"}], "=", "0."}], ";", 
                  "\[IndentingNewLine]", 
                  RowBox[{"ik", "=", 
                   RowBox[{"IAMAX", "[", "w", "]"}]}], ";", 
                  "\[IndentingNewLine]", 
                  RowBox[{"vk", "=", 
                   RowBox[{"Subtract", "[", 
                    RowBox[{
                    RowBox[{"row", "[", "ik", "]"}], ",", 
                    RowBox[{
                    RowBox[{"u", "\[LeftDoubleBracket]", 
                    RowBox[{
                    RowBox[{";;", 
                    RowBox[{"k", "-", "1"}]}], ",", "ik"}], 
                    "\[RightDoubleBracket]"}], ".", 
                    RowBox[{"v", "\[LeftDoubleBracket]", 
                    RowBox[{";;", 
                    RowBox[{"k", "-", "1"}]}], "\[RightDoubleBracket]"}]}]}], 
                    "]"}]}], ";", "\[IndentingNewLine]", 
                  RowBox[{"jk", "=", 
                   RowBox[{"IAMAX", "[", "vk", "]"}]}], ";", 
                  "\[IndentingNewLine]", 
                  RowBox[{"\[Delta]", "=", 
                   RowBox[{
                   "vk", "\[LeftDoubleBracket]", "jk", 
                    "\[RightDoubleBracket]"}]}], ";"}]}], 
                "\[IndentingNewLine]", "]"}], ";"}]}], "\[IndentingNewLine]", 
             "]"}], ";", "\[IndentingNewLine]", 
            RowBox[{"uk", "=", 
             RowBox[{"Subtract", "[", 
              RowBox[{
               RowBox[{"column", "[", "jk", "]"}], ",", 
               RowBox[{
                RowBox[{"v", "\[LeftDoubleBracket]", 
                 RowBox[{
                  RowBox[{";;", 
                   RowBox[{"k", "-", "1"}]}], ",", "jk"}], 
                 "\[RightDoubleBracket]"}], ".", 
                RowBox[{"u", "\[LeftDoubleBracket]", 
                 RowBox[{";;", 
                  RowBox[{"k", "-", "1"}]}], "\[RightDoubleBracket]"}]}]}], 
              "]"}]}], ";", "\[IndentingNewLine]", 
            RowBox[{"scale", "=", 
             RowBox[{"1.", "/", 
              RowBox[{"Sqrt", "[", 
               RowBox[{"Abs", "[", "\[Delta]", "]"}], "]"}]}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{
             "v", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}], "=", 
             RowBox[{"vk", "=", 
              RowBox[{"vk", " ", 
               RowBox[{"(", 
                RowBox[{"scale", " ", 
                 RowBox[{"Sign", "[", "\[Delta]", "]"}]}], ")"}]}]}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{
             "u", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}], "=", 
             RowBox[{"uk", "=", 
              RowBox[{"uk", " ", "scale"}]}]}], ";", "\[IndentingNewLine]", 
            RowBox[{"test", "=", 
             RowBox[{
              RowBox[{"uk", ".", "uk"}], " ", 
              RowBox[{"vk", ".", "vk"}]}]}], ";", "\[IndentingNewLine]", 
            RowBox[{"norm2", "+=", 
             RowBox[{"test", "+", 
              RowBox[{"Dot", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{"u", "\[LeftDoubleBracket]", 
                  RowBox[{"1", ";;", 
                   RowBox[{"k", "-", "1"}]}], "\[RightDoubleBracket]"}], ".", 
                 "uk"}], ",", 
                RowBox[{
                 RowBox[{"v", "\[LeftDoubleBracket]", 
                  RowBox[{"1", ";;", 
                   RowBox[{"k", "-", "1"}]}], "\[RightDoubleBracket]"}], ".", 
                 "vk"}]}], "]"}]}]}]}]}], "\[IndentingNewLine]", "]"}], ";", 
         "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"If", "[", 
          RowBox[{"recompressionQ", ",", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{
             RowBox[{"{", 
              RowBox[{"uQ", ",", "uR"}], "}"}], "=", 
             RowBox[{"QRDecomposition", "[", 
              RowBox[{"Transpose", "[", 
               RowBox[{"u", "\[LeftDoubleBracket]", 
                RowBox[{"1", ";;", "k"}], "\[RightDoubleBracket]"}], "]"}], 
              "]"}]}], ";", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"vQ", ",", "vR"}], "}"}], "=", 
             RowBox[{"QRDecomposition", "[", 
              RowBox[{"Transpose", "[", 
               RowBox[{"v", "\[LeftDoubleBracket]", 
                RowBox[{"1", ";;", "k"}], "\[RightDoubleBracket]"}], "]"}], 
              "]"}]}], ";", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"U", ",", "\[CapitalSigma]", ",", "V"}], "}"}], "=", 
             RowBox[{"SingularValueDecomposition", "[", 
              RowBox[{"uR", ".", 
               RowBox[{"Transpose", "[", "vR", "]"}]}], "]"}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"\[Sigma]", "=", 
             RowBox[{"Diagonal", "[", "\[CapitalSigma]", "]"}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"rank", "=", 
             RowBox[{"Total", "[", 
              RowBox[{"UnitStep", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{
                  RowBox[{"#", "/", 
                   RowBox[{
                   "#", "\[LeftDoubleBracket]", "1", 
                    "\[RightDoubleBracket]"}]}], "&"}], "@", "\[Sigma]"}], 
                "-", 
                RowBox[{"\[Epsilon]", "/", "4"}]}], "]"}], "]"}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"{", "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{
               RowBox[{"Transpose", "[", 
                RowBox[{"U", "\[LeftDoubleBracket]", 
                 RowBox[{"All", ",", 
                  RowBox[{"1", ";;", "rank"}]}], "\[RightDoubleBracket]"}], 
                "]"}], ".", "uQ"}], ",", "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{"(", 
                RowBox[{
                 RowBox[{"\[Sigma]", "\[LeftDoubleBracket]", 
                  RowBox[{"1", ";;", "rank"}], "\[RightDoubleBracket]"}], 
                 RowBox[{"Transpose", "[", 
                  RowBox[{"V", "\[LeftDoubleBracket]", 
                   RowBox[{"All", ",", 
                    RowBox[{"1", ";;", "rank"}]}], "\[RightDoubleBracket]"}], 
                  "]"}]}], ")"}], ".", "vQ"}]}], "\[IndentingNewLine]", 
             "}"}]}], ",", "\[IndentingNewLine]", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"u", "\[LeftDoubleBracket]", 
              RowBox[{"1", ";;", "k"}], "\[RightDoubleBracket]"}], ",", 
             RowBox[{"v", "\[LeftDoubleBracket]", 
              RowBox[{"1", ";;", "k"}], "\[RightDoubleBracket]"}]}], "}"}]}], 
          "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", "]"}], ",",
       "\[IndentingNewLine]", 
      RowBox[{"Options", "\[Rule]", 
       RowBox[{"{", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"\"\<MaxRank\>\"", "\[Rule]", "50"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"\"\<Tolerance\>\"", "\[Rule]", 
          RowBox[{"1.", " ", 
           RowBox[{"10", "^", 
            RowBox[{"-", "4"}]}]}]}], ",", "\[IndentingNewLine]", 
         RowBox[{"\"\<Recompression\>\"", "\[Rule]", "False"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"\"\<StartingIndex\>\"", "\[Rule]", "1"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"\"\<MaxPivotTrials\>\"", "\[Rule]", "100"}]}], 
        "\[IndentingNewLine]", "}"}]}]}], "\[IndentingNewLine]", "]"}]}], 
   ";"}], "\[IndentingNewLine]"}], "\n", 
 RowBox[{
  RowBox[{"(*", 
   RowBox[{"ACACompression", "=", 
    RowBox[{"PackageFunction", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"row_", ",", "column_"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{"Module", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
         "maxrank", ",", "\[Epsilon]", ",", "recompressionQ", ",", "maxiter", 
          ",", "\[IndentingNewLine]", "u", ",", "v", ",", "k", ",", "ik", ",",
           "jk", ",", "uk", ",", "vk", ",", "test", ",", "norm2", ",", 
          "\[Delta]", ",", "w", ",", "iter", ",", "uQ", ",", "uR", ",", "vQ", 
          ",", "vR", ",", "U", ",", "\[CapitalSigma]", ",", "V", ",", "rank", 
          ",", "\[Sigma]", ",", "m", ",", "n", ",", "eps"}], "}"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"eps", "=", "$MachineEpsilon"}], ";", "\[IndentingNewLine]", 
         
         RowBox[{"maxiter", "=", 
          RowBox[{"OptionValue", "[", "\"\<MaxPivotTrials\>\"", "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"maxrank", "=", 
          RowBox[{"OptionValue", "[", "\"\<MaxRank\>\"", "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"\[Epsilon]", "=", 
          RowBox[{"OptionValue", "[", "\"\<Tolerance\>\"", "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"recompressionQ", "=", 
          RowBox[{"OptionValue", "[", "\"\<Recompression\>\"", "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"k", "=", "1"}], ";", "\[IndentingNewLine]", 
         RowBox[{"ik", "=", 
          RowBox[{"OptionValue", "[", "\"\<StartingIndex\>\"", "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"vk", "=", 
          RowBox[{"row", "[", "ik", "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"m", "=", 
          RowBox[{"Length", "[", "vk", "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"v", "=", 
          RowBox[{"ConstantArray", "[", 
           RowBox[{"0.", ",", 
            RowBox[{"{", 
             RowBox[{"maxrank", ",", "m"}], "}"}]}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"jk", "=", 
          RowBox[{"IAMAX", "[", "vk", "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"v", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}],
           "=", 
          RowBox[{"vk", "=", 
           RowBox[{"vk", "/", 
            RowBox[{
            "vk", "\[LeftDoubleBracket]", "jk", 
             "\[RightDoubleBracket]"}]}]}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"uk", "=", 
          RowBox[{"column", "[", "jk", "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"n", "=", 
          RowBox[{"Length", "[", "uk", "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"u", "=", 
          RowBox[{"ConstantArray", "[", 
           RowBox[{"0.", ",", 
            RowBox[{"{", 
             RowBox[{"maxrank", ",", "n"}], "}"}]}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"u", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}],
           "=", "uk"}], ";", "\[IndentingNewLine]", 
         RowBox[{"test", "=", 
          RowBox[{
           RowBox[{"uk", ".", "uk"}], " ", 
           RowBox[{"vk", ".", "vk"}]}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"norm2", "=", "test"}], ";", "\[IndentingNewLine]", 
         "\[IndentingNewLine]", 
         RowBox[{"maxrank", "=", 
          RowBox[{"Min", "[", 
           RowBox[{"m", ",", "n", ",", "maxrank"}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"While", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"test", ">", 
             RowBox[{
              RowBox[{"\[Epsilon]", "^", "2"}], " ", "norm2"}]}], "&&", 
            RowBox[{"k", "<", "maxrank"}]}], ",", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"k", "++"}], ";", "\[IndentingNewLine]", 
            RowBox[{"ik", "=", 
             RowBox[{"IAMAX", "[", "uk", "]"}]}], ";", "\[IndentingNewLine]", 
            
            RowBox[{"vk", "=", 
             RowBox[{"Subtract", "[", 
              RowBox[{
               RowBox[{"row", "[", "ik", "]"}], ",", 
               RowBox[{
                RowBox[{"u", "\[LeftDoubleBracket]", 
                 RowBox[{
                  RowBox[{";;", 
                   RowBox[{"k", "-", "1"}]}], ",", "ik"}], 
                 "\[RightDoubleBracket]"}], ".", 
                RowBox[{"v", "\[LeftDoubleBracket]", 
                 RowBox[{";;", 
                  RowBox[{"k", "-", "1"}]}], "\[RightDoubleBracket]"}]}]}], 
              "]"}]}], ";", "\[IndentingNewLine]", 
            RowBox[{"jk", "=", 
             RowBox[{"IAMAX", "[", "vk", "]"}]}], ";", "\[IndentingNewLine]", 
            
            RowBox[{"\[Delta]", "=", 
             RowBox[{
             "vk", "\[LeftDoubleBracket]", "jk", "\[RightDoubleBracket]"}]}], 
            ";", "\[IndentingNewLine]", 
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"Abs", "[", "\[Delta]", "]"}], "<", "eps"}], ",", 
              "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{"w", "=", "uk"}], ";", "\[IndentingNewLine]", 
               RowBox[{"\[Delta]", "=", "0."}], ";", "\[IndentingNewLine]", 
               RowBox[{"iter", "=", "0"}], ";", "\[IndentingNewLine]", 
               RowBox[{"While", "[", 
                RowBox[{
                 RowBox[{
                  RowBox[{
                   RowBox[{"Abs", "[", "\[Delta]", "]"}], "<", "eps"}], "&&", 
                  
                  RowBox[{"iter", "<", "maxiter"}]}], ",", 
                 "\[IndentingNewLine]", 
                 RowBox[{
                  RowBox[{"iter", "++"}], ";", "\[IndentingNewLine]", 
                  RowBox[{
                   RowBox[{
                   "w", "\[LeftDoubleBracket]", "ik", 
                    "\[RightDoubleBracket]"}], "=", "0."}], ";", 
                  "\[IndentingNewLine]", 
                  RowBox[{"ik", "=", 
                   RowBox[{"IAMAX", "[", "w", "]"}]}], ";", 
                  "\[IndentingNewLine]", 
                  RowBox[{"vk", "=", 
                   RowBox[{"Subtract", "[", 
                    RowBox[{
                    RowBox[{"row", "[", "ik", "]"}], ",", 
                    RowBox[{
                    RowBox[{"u", "\[LeftDoubleBracket]", 
                    RowBox[{
                    RowBox[{";;", 
                    RowBox[{"k", "-", "1"}]}], ",", "ik"}], 
                    "\[RightDoubleBracket]"}], ".", 
                    RowBox[{"v", "\[LeftDoubleBracket]", 
                    RowBox[{";;", 
                    RowBox[{"k", "-", "1"}]}], "\[RightDoubleBracket]"}]}]}], 
                    "]"}]}], ";", "\[IndentingNewLine]", 
                  RowBox[{"jk", "=", 
                   RowBox[{"IAMAX", "[", "vk", "]"}]}], ";", 
                  "\[IndentingNewLine]", 
                  RowBox[{"\[Delta]", "=", 
                   RowBox[{
                   "vk", "\[LeftDoubleBracket]", "jk", 
                    "\[RightDoubleBracket]"}]}], ";"}]}], 
                "\[IndentingNewLine]", "]"}], ";"}]}], "\[IndentingNewLine]", 
             "]"}], ";", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{
             "v", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}], "=", 
             RowBox[{"vk", "=", 
              RowBox[{"vk", "/", "\[Delta]"}]}]}], ";", "\[IndentingNewLine]", 
            RowBox[{"uk", "=", 
             RowBox[{"Subtract", "[", 
              RowBox[{
               RowBox[{"column", "[", "jk", "]"}], ",", 
               RowBox[{
                RowBox[{"v", "\[LeftDoubleBracket]", 
                 RowBox[{
                  RowBox[{";;", 
                   RowBox[{"k", "-", "1"}]}], ",", "jk"}], 
                 "\[RightDoubleBracket]"}], ".", 
                RowBox[{"u", "\[LeftDoubleBracket]", 
                 RowBox[{";;", 
                  RowBox[{"k", "-", "1"}]}], "\[RightDoubleBracket]"}]}]}], 
              "]"}]}], ";", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{
             "u", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}], "=",
              "uk"}], ";", "\[IndentingNewLine]", 
            RowBox[{"test", "=", 
             RowBox[{
              RowBox[{"uk", ".", "uk"}], " ", 
              RowBox[{"vk", ".", "vk"}]}]}], ";", "\[IndentingNewLine]", 
            RowBox[{"norm2", "+=", 
             RowBox[{"test", "+", 
              RowBox[{"Dot", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{"u", "\[LeftDoubleBracket]", 
                  RowBox[{"1", ";;", 
                   RowBox[{"k", "-", "1"}]}], "\[RightDoubleBracket]"}], ".", 
                 "uk"}], ",", 
                RowBox[{
                 RowBox[{"v", "\[LeftDoubleBracket]", 
                  RowBox[{"1", ";;", 
                   RowBox[{"k", "-", "1"}]}], "\[RightDoubleBracket]"}], ".", 
                 "vk"}]}], "]"}]}]}]}]}], "\[IndentingNewLine]", "]"}], ";", 
         "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"If", "[", 
          RowBox[{"recompressionQ", ",", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{
             RowBox[{"{", 
              RowBox[{"uQ", ",", "uR"}], "}"}], "=", 
             RowBox[{"QRDecomposition", "[", 
              RowBox[{"Transpose", "[", 
               RowBox[{"u", "\[LeftDoubleBracket]", 
                RowBox[{"1", ";;", "k"}], "\[RightDoubleBracket]"}], "]"}], 
              "]"}]}], ";", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"vQ", ",", "vR"}], "}"}], "=", 
             RowBox[{"QRDecomposition", "[", 
              RowBox[{"Transpose", "[", 
               RowBox[{"v", "\[LeftDoubleBracket]", 
                RowBox[{"1", ";;", "k"}], "\[RightDoubleBracket]"}], "]"}], 
              "]"}]}], ";", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"U", ",", "\[CapitalSigma]", ",", "V"}], "}"}], "=", 
             RowBox[{"SingularValueDecomposition", "[", 
              RowBox[{"uR", ".", 
               RowBox[{"Transpose", "[", "vR", "]"}]}], "]"}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"\[Sigma]", "=", 
             RowBox[{"Diagonal", "[", "\[CapitalSigma]", "]"}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"rank", "=", 
             RowBox[{"Total", "[", 
              RowBox[{"UnitStep", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{
                  RowBox[{"#", "/", 
                   RowBox[{
                   "#", "\[LeftDoubleBracket]", "1", 
                    "\[RightDoubleBracket]"}]}], "&"}], "@", "\[Sigma]"}], 
                "-", 
                RowBox[{"\[Epsilon]", "/", "4"}]}], "]"}], "]"}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"{", "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{
               RowBox[{"Transpose", "[", 
                RowBox[{"U", "\[LeftDoubleBracket]", 
                 RowBox[{"All", ",", 
                  RowBox[{"1", ";;", "rank"}]}], "\[RightDoubleBracket]"}], 
                "]"}], ".", "uQ"}], ",", "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{"(", 
                RowBox[{
                 RowBox[{"\[Sigma]", "\[LeftDoubleBracket]", 
                  RowBox[{"1", ";;", "rank"}], "\[RightDoubleBracket]"}], 
                 RowBox[{"Transpose", "[", 
                  RowBox[{"V", "\[LeftDoubleBracket]", 
                   RowBox[{"All", ",", 
                    RowBox[{"1", ";;", "rank"}]}], "\[RightDoubleBracket]"}], 
                  "]"}]}], ")"}], ".", "vQ"}]}], "\[IndentingNewLine]", 
             "}"}]}], ",", "\[IndentingNewLine]", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"u", "\[LeftDoubleBracket]", 
              RowBox[{"1", ";;", "k"}], "\[RightDoubleBracket]"}], ",", 
             RowBox[{"v", "\[LeftDoubleBracket]", 
              RowBox[{"1", ";;", "k"}], "\[RightDoubleBracket]"}]}], "}"}]}], 
          "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", "]"}], ",",
       "\[IndentingNewLine]", 
      RowBox[{"Options", "\[Rule]", 
       RowBox[{"{", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"\"\<MaxRank\>\"", "\[Rule]", "50"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"\"\<Tolerance\>\"", "\[Rule]", 
          RowBox[{"1.", " ", 
           RowBox[{"10", "^", 
            RowBox[{"-", "4"}]}]}]}], ",", "\[IndentingNewLine]", 
         RowBox[{"\"\<Recompression\>\"", "\[Rule]", "False"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"\"\<StartingIndex\>\"", "\[Rule]", "1"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"\"\<MaxPivotTrials\>\"", "\[Rule]", "100"}]}], 
        "\[IndentingNewLine]", "}"}]}]}], "\[IndentingNewLine]", "]"}]}], 
   "*)"}]}]}], "Input",
 CellChangeTimes->{{3.7567148292126913`*^9, 3.756714859380031*^9}, {
   3.7568922066908503`*^9, 3.756892225800558*^9}, 3.77270845834239*^9, {
   3.794818254624029*^9, 3.7948182588754396`*^9}, {3.794818638360956*^9, 
   3.794818642640279*^9}, {3.794835735788549*^9, 3.794835762530139*^9}, {
   3.794893149632904*^9, 3.7948931689133377`*^9}, {3.794893226795205*^9, 
   3.7948932330316257`*^9}},
 CellLabel->
  "In[327]:=",ExpressionUUID->"a30d329d-6a07-49ee-9d96-8d0d6dcaaf47"]
},
WindowSize->{1440, 855},
WindowMargins->{{0, Automatic}, {Automatic, 0}},
FrontEndVersion->"12.0 for Mac OS X x86 (64-bit) (April 8, 2019)",
StyleDefinitions->"Default.nb"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[558, 20, 10983, 256, 1392, "Input",ExpressionUUID->"d2f2378e-7a28-4b98-9912-e08ec484fb90"],
Cell[11544, 278, 15189, 338, 2242, "Input",ExpressionUUID->"9f48f3e4-7308-4057-b647-1a5e5183e2e7"],
Cell[26736, 618, 229, 4, 92, "Input",ExpressionUUID->"b3ec59a6-011f-4ead-9766-f5a1705864c7"],
Cell[26968, 624, 28989, 661, 2967, "Input",ExpressionUUID->"76961a3b-73f3-498b-8eba-4b6c2dc04946"],
Cell[55960, 1287, 228, 4, 92, "Input",ExpressionUUID->"d7da8014-66d3-421a-ab5a-f556a7ef6778"],
Cell[56191, 1293, 7760, 180, 1292, "Input",ExpressionUUID->"2f478178-18b3-4952-9d58-787a63a65756"],
Cell[63954, 1475, 15987, 355, 2017, "Input",ExpressionUUID->"535e9b65-cec7-4b4d-8946-4a4473796847"],
Cell[79944, 1832, 175, 3, 41, "Input",ExpressionUUID->"8dd2d07a-d3de-468d-9655-bf954f1f0cb2"],
Cell[80122, 1837, 29150, 653, 3867, "Input",ExpressionUUID->"a30d329d-6a07-49ee-9d96-8d0d6dcaaf47"]
}
]
*)

