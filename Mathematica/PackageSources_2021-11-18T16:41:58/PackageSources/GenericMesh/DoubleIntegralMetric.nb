(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 11.3' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       158,          7]
NotebookDataLength[     47756,       1054]
NotebookOptionsPosition[     46790,       1034]
NotebookOutlinePosition[     47129,       1049]
CellTagsIndexPosition[     47086,       1046]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{
Cell[BoxData[
 RowBox[{"getIsotropicDoubleIntegralMetricCombinatorics", "=", 
  RowBox[{"CPackageFunction", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"{", 
      RowBox[{"q", ",", "_Integer", ",", "1"}], "}"}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"Flatten", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Table", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Table", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"Compile`GetElement", "[", 
             RowBox[{"q", ",", "i"}], "]"}], ",", 
            RowBox[{"Compile`GetElement", "[", 
             RowBox[{"q", ",", "j"}], "]"}]}], "}"}], "\[IndentingNewLine]", 
          ",", 
          RowBox[{"{", 
           RowBox[{"i", ",", "1", ",", 
            RowBox[{"Length", "[", "q", "]"}]}], "}"}]}], "]"}], 
        "\[IndentingNewLine]", ",", 
        RowBox[{"{", 
         RowBox[{"j", ",", "1", ",", 
          RowBox[{"Length", "[", "q", "]"}]}], "}"}]}], "]"}], ",", 
      "\[IndentingNewLine]", "1"}], "\[IndentingNewLine]", "]"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"CompilationTarget", "\[Rule]", "\"\<C\>\""}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"RuntimeAttributes", "\[Rule]", 
     RowBox[{"{", "Listable", "}"}]}], ",", "\[IndentingNewLine]", 
    RowBox[{"Parallelization", "\[Rule]", "True"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"RuntimeOptions", "\[Rule]", "\"\<Speed\>\""}]}], 
   "\[IndentingNewLine]", "]"}]}]], "Input",
 CellChangeTimes->{{3.764163362173078*^9, 3.7641633684659643`*^9}},
 CellLabel->"In[21]:=",ExpressionUUID->"d81fce63-a538-445f-9c06-9f7ec68169c7"],

Cell[BoxData[
 RowBox[{"getIsotropicDoubleIntegralMetricIList", "=", 
  RowBox[{"CPackageFunction", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"{", 
      RowBox[{"q", ",", "_Integer", ",", "1"}], "}"}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"Flatten", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Table", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Table", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"Compile`GetElement", "[", 
           RowBox[{"q", ",", "i"}], "]"}], "\[IndentingNewLine]", ",", 
          RowBox[{"{", 
           RowBox[{"i", ",", "1", ",", 
            RowBox[{"Length", "[", "q", "]"}]}], "}"}]}], "]"}], 
        "\[IndentingNewLine]", ",", 
        RowBox[{"{", 
         RowBox[{"j", ",", "1", ",", 
          RowBox[{"Length", "[", "q", "]"}]}], "}"}]}], "]"}], ",", 
      "\[IndentingNewLine]", "1"}], "\[IndentingNewLine]", "]"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"CompilationTarget", "\[Rule]", "\"\<C\>\""}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"RuntimeAttributes", "\[Rule]", 
     RowBox[{"{", "Listable", "}"}]}], ",", "\[IndentingNewLine]", 
    RowBox[{"Parallelization", "\[Rule]", "True"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"RuntimeOptions", "\[Rule]", "\"\<Speed\>\""}]}], 
   "\[IndentingNewLine]", "]"}]}]], "Input",
 CellChangeTimes->{{3.7641382243864107`*^9, 3.764138229802411*^9}},
 CellLabel->"In[22]:=",ExpressionUUID->"96d35d7b-ce89-4cb6-a353-ebbd8ddb5e5d"],

Cell[BoxData[
 RowBox[{"getIsotropicDoubleIntegralMetricJList", "=", 
  RowBox[{"CPackageFunction", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"{", 
      RowBox[{"q", ",", "_Integer", ",", "1"}], "}"}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"Flatten", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Table", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Table", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"Compile`GetElement", "[", 
           RowBox[{"q", ",", "j"}], "]"}], "\[IndentingNewLine]", ",", 
          RowBox[{"{", 
           RowBox[{"i", ",", "1", ",", 
            RowBox[{"Length", "[", "q", "]"}]}], "}"}]}], "]"}], 
        "\[IndentingNewLine]", ",", 
        RowBox[{"{", 
         RowBox[{"j", ",", "1", ",", 
          RowBox[{"Length", "[", "q", "]"}]}], "}"}]}], "]"}], ",", 
      "\[IndentingNewLine]", "1"}], "\[IndentingNewLine]", "]"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"CompilationTarget", "\[Rule]", "\"\<C\>\""}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"RuntimeAttributes", "\[Rule]", 
     RowBox[{"{", "Listable", "}"}]}], ",", "\[IndentingNewLine]", 
    RowBox[{"Parallelization", "\[Rule]", "True"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"RuntimeOptions", "\[Rule]", "\"\<Speed\>\""}]}], 
   "\[IndentingNewLine]", "]"}]}]], "Input",
 CellChangeTimes->{{3.7641382243864107`*^9, 3.764138271353284*^9}},
 CellLabel->"In[23]:=",ExpressionUUID->"946877d5-23c6-4500-8478-caa44c9d25fd"],

Cell[BoxData[
 RowBox[{"getAnisotropicDoubleIntegralMetricIList", "=", 
  RowBox[{"CPackageFunction", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"q", ",", "_Integer", ",", "1"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"d", ",", "_Integer"}], "}"}]}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"Flatten", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Table", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Table", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"Table", "[", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"Table", "[", "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{
               RowBox[{"d", 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{"Compile`GetElement", "[", 
                   RowBox[{"q", ",", "i"}], "]"}], "-", "1"}], ")"}]}], "+", 
               "ii"}], "\[IndentingNewLine]", ",", 
              RowBox[{"{", 
               RowBox[{"ii", ",", "1", ",", "d"}], "}"}]}], "]"}], 
            "\[IndentingNewLine]", ",", 
            RowBox[{"{", 
             RowBox[{"i", ",", "1", ",", 
              RowBox[{"Length", "[", "q", "]"}]}], "}"}]}], "]"}], 
          "\[IndentingNewLine]", ",", 
          RowBox[{"{", 
           RowBox[{"jj", ",", "1", ",", "d"}], "}"}]}], "]"}], 
        "\[IndentingNewLine]", ",", 
        RowBox[{"{", 
         RowBox[{"j", ",", "1", ",", 
          RowBox[{"Length", "[", "q", "]"}]}], "}"}]}], "]"}], ",", 
      "\[IndentingNewLine]", "3"}], "]"}], ",", "\[IndentingNewLine]", 
    RowBox[{"CompilationTarget", "\[Rule]", "\"\<C\>\""}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"RuntimeAttributes", "\[Rule]", 
     RowBox[{"{", "Listable", "}"}]}], ",", "\[IndentingNewLine]", 
    RowBox[{"Parallelization", "\[Rule]", "True"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"RuntimeOptions", "\[Rule]", "\"\<Speed\>\""}]}], 
   "\[IndentingNewLine]", "]"}]}]], "Input",
 CellChangeTimes->{{3.7641375498974953`*^9, 3.764137614652972*^9}, {
  3.764137673557148*^9, 3.764137676779846*^9}, {3.764137745949451*^9, 
  3.7641377719217243`*^9}, {3.764138294346353*^9, 3.764138320167807*^9}, {
  3.764168368256979*^9, 3.764168378838725*^9}},
 CellLabel->"In[24]:=",ExpressionUUID->"b035c983-38ad-4683-a1b0-ce38836ed81a"],

Cell[BoxData[
 RowBox[{"getAnisotropicDoubleIntegralMetricJList", "=", 
  RowBox[{"CPackageFunction", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"q", ",", "_Integer", ",", "1"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"d", ",", "_Integer"}], "}"}]}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"Flatten", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Table", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Table", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"Table", "[", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"Table", "[", "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{
               RowBox[{"d", 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{"Compile`GetElement", "[", 
                   RowBox[{"q", ",", "j"}], "]"}], "-", "1"}], ")"}]}], "+", 
               "jj"}], "\[IndentingNewLine]", ",", 
              RowBox[{"{", 
               RowBox[{"ii", ",", "1", ",", "d"}], "}"}]}], "]"}], 
            "\[IndentingNewLine]", ",", 
            RowBox[{"{", 
             RowBox[{"i", ",", "1", ",", 
              RowBox[{"Length", "[", "q", "]"}]}], "}"}]}], "]"}], 
          "\[IndentingNewLine]", ",", 
          RowBox[{"{", 
           RowBox[{"jj", ",", "1", ",", "d"}], "}"}]}], "]"}], 
        "\[IndentingNewLine]", ",", 
        RowBox[{"{", 
         RowBox[{"j", ",", "1", ",", 
          RowBox[{"Length", "[", "q", "]"}]}], "}"}]}], "]"}], ",", 
      "\[IndentingNewLine]", "3"}], "]"}], ",", "\[IndentingNewLine]", 
    RowBox[{"CompilationTarget", "\[Rule]", "\"\<C\>\""}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"RuntimeAttributes", "\[Rule]", 
     RowBox[{"{", "Listable", "}"}]}], ",", "\[IndentingNewLine]", 
    RowBox[{"Parallelization", "\[Rule]", "True"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"RuntimeOptions", "\[Rule]", "\"\<Speed\>\""}]}], 
   "\[IndentingNewLine]", "]"}]}]], "Input",
 CellChangeTimes->{{3.7641634773072863`*^9, 3.76416347777006*^9}, {
   3.7641683352542677`*^9, 3.764168389030869*^9}, 
   3.783943061547184*^9},ExpressionUUID->"9e4f1343-282a-4390-9b0a-\
46f8738511aa"],

Cell[BoxData[
 RowBox[{"VerbatimRegion", "[", "\[IndentingNewLine]", "\[IndentingNewLine]", 
  
  RowBox[{
   RowBox[{
    RowBox[{"IsotropicDoubleIntegralMetricCombinatorics", "::", "usage"}], 
    "=", "\"\<\>\""}], ";", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"AnisotropicDoubleIntegralMetricCombinatorics", "::", "usage"}], 
    "=", "\"\<\>\""}], ";", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"IntrinsicDimension", "::", "usage"}], "=", "\"\<\>\""}], ";", 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"ClearAll", "[", "CompileDoubleIntegralMetric", "]"}], ";", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"CompileDoubleIntegralMetric", "::", "usage"}], "=", "\"\<\>\""}],
    ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"SetAttributes", "[", 
    RowBox[{"CompileDoubleIntegralMetric", ",", "HoldRest"}], "]"}], ";", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"CompileDoubleIntegralMetric", "[", 
     RowBox[{
     "name0_", ",", "arglist_", ",", "f_", ",", "derargs0_", ",", "dim_", ",",
       "d_", ",", "\[IndentingNewLine]", 
      RowBox[{"OptionsPattern", "[", 
       RowBox[{"{", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"\"\<CompilationTarget\>\"", "\[Rule]", "\"\<C\>\""}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"\"\<Parallelization\>\"", "\[Rule]", "True"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"\"\<RuntimeAttributes\>\"", "\[Rule]", "Listable"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"\"\<RuntimeOptions\>\"", "\[Rule]", "\"\<Speed\>\""}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"\"\<CompilationOptions\>\"", "\[Rule]", 
          RowBox[{"{", "}"}]}], ",", "\[IndentingNewLine]", 
         RowBox[{"\"\<PrintCode\>\"", "\[Rule]", "False"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"\"\<ExportPseudoCode\>\"", "\[Rule]", "False"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"\"\<OptimizationLevel\>\"", "\[Rule]", "1"}]}], 
        "\[IndentingNewLine]", "}"}], "]"}]}], "]"}], ":=", 
    "\[IndentingNewLine]", 
    RowBox[{"Block", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "UU", ",", "U", ",", "VV", ",", "V", ",", "WW", ",", "W", ",", 
        "derargs", ",", "dims", ",", "S", ",", "fullname", ",", "rule", ",", 
        "r", ",", "xx", ",", "x", ",", "\[Omega]", ",", "i", ",", "h", ",", 
        "\[IndentingNewLine]", "matrix", ",", "Dmatrix", ",", "matrix0", ",", 
        "scalarQ", ",", "tic", ",", "toc", ",", "name"}], 
       "\[IndentingNewLine]", "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"h", "=", 
        RowBox[{"2.", "^", 
         RowBox[{"-", "20"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"name", "=", 
        RowBox[{"name0", "<>", "\"\<Metric\>\"", "<>", 
         RowBox[{"ToString", "[", "dim", "]"}], "<>", "\"\<D\>\"", "<>", 
         RowBox[{"ToString", "[", "d", "]"}], "<>", "\"\<D\>\""}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"PrintTemporary", "[", 
        RowBox[{
        "\"\<Preparing code for \>\"", "<>", "name", "<>", "\"\<...\>\""}], 
        "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"tic", "=", 
        RowBox[{"AbsoluteTime", "[", "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"xx", "=", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{"Compile`GetElement", "[", 
           RowBox[{"x", ",", "i", ",", "j"}], "]"}], ",", 
          RowBox[{"{", 
           RowBox[{"j", ",", "1", ",", 
            RowBox[{"2", " ", "dim"}]}], "}"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"matrix", "=", 
        RowBox[{"2", 
         RowBox[{"f", "[", "xx", "]"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"rule", "=", 
        RowBox[{"Part", "\[Rule]", "Compile`GetElement"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"derargs", "=", 
        RowBox[{"Flatten", "[", 
         RowBox[{"derargs0", "/.", "rule"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"r", "=", 
        RowBox[{"ArrayDepth", "[", "derargs", "]"}]}], ";", 
       RowBox[{"UU", "=", "derargs"}], ";", 
       RowBox[{
        RowBox[{"UU", "\[LeftDoubleBracket]", 
         RowBox[{
          RowBox[{"Sequence", "@@", 
           RowBox[{"ConstantArray", "[", 
            RowBox[{"All", ",", "r"}], "]"}]}], ",", "1"}], 
         "\[RightDoubleBracket]"}], "=", "U"}], ";", 
       RowBox[{"VV", "=", "derargs"}], ";", 
       RowBox[{
        RowBox[{"VV", "\[LeftDoubleBracket]", 
         RowBox[{
          RowBox[{"Sequence", "@@", 
           RowBox[{"ConstantArray", "[", 
            RowBox[{"All", ",", "r"}], "]"}]}], ",", "1"}], 
         "\[RightDoubleBracket]"}], "=", "V"}], ";", "\[IndentingNewLine]", 
       RowBox[{"WW", "=", "derargs"}], ";", 
       RowBox[{
        RowBox[{"WW", "\[LeftDoubleBracket]", 
         RowBox[{
          RowBox[{"Sequence", "@@", 
           RowBox[{"ConstantArray", "[", 
            RowBox[{"All", ",", "r"}], "]"}]}], ",", "1"}], 
         "\[RightDoubleBracket]"}], "=", "W"}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"matrix0", "=", 
        RowBox[{"SparseArray", "@", 
         RowBox[{"matrix", "\[LeftDoubleBracket]", 
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"Range", "[", 
              RowBox[{"0", ",", 
               RowBox[{
                RowBox[{"2", 
                 RowBox[{"(", 
                  RowBox[{"dim", "+", "1"}], ")"}]}], "-", "1"}]}], "]"}], 
             "d"}], "+", "1"}], ",", 
           RowBox[{
            RowBox[{
             RowBox[{"Range", "[", 
              RowBox[{"0", ",", 
               RowBox[{
                RowBox[{"2", 
                 RowBox[{"(", 
                  RowBox[{"dim", "+", "1"}], ")"}]}], "-", "1"}]}], "]"}], 
             "d"}], "+", "1"}]}], "\[RightDoubleBracket]"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"scalarQ", "=", 
        RowBox[{
         RowBox[{
          RowBox[{"KroneckerProduct", "[", 
           RowBox[{"matrix0", ",", 
            RowBox[{"IdentityMatrix", "[", "d", "]"}]}], "]"}], "[", 
          "\"\<NonzeroPositions\>\"", "]"}], "\[Equal]", 
         RowBox[{
          RowBox[{"SparseArray", "[", "matrix", "]"}], "[", 
          "\"\<NonzeroPositions\>\"", "]"}]}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"Dmatrix", "=", 
        RowBox[{"D", "[", 
         RowBox[{"matrix", ",", 
          RowBox[{"{", 
           RowBox[{"derargs", ",", "1"}], "}"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"With", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"opts", "=", 
           RowBox[{"Sequence", "[", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"CompilationTarget", "\[Rule]", 
              RowBox[{"OptionValue", "[", "CompilationTarget", "]"}]}], ",", 
             "\[IndentingNewLine]", 
             RowBox[{"RuntimeAttributes", "\[Rule]", 
              RowBox[{"OptionValue", "[", "RuntimeAttributes", "]"}]}], ",", 
             "\[IndentingNewLine]", 
             RowBox[{"Parallelization", "\[Rule]", 
              RowBox[{"OptionValue", "[", "Parallelization", "]"}]}], ",", 
             "\[IndentingNewLine]", 
             RowBox[{"RuntimeOptions", "\[Rule]", 
              RowBox[{"OptionValue", "[", "RuntimeOptions", "]"}]}], ",", 
             "\[IndentingNewLine]", 
             RowBox[{"\"\<ExportPseudoCode\>\"", "\[Rule]", 
              RowBox[{
              "OptionValue", "[", "\"\<ExportPseudoCode\>\"", "]"}]}]}], 
            "\[IndentingNewLine]", "]"}]}], "}"}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"fullname", "=", 
           RowBox[{"\"\<get\>\"", "<>", "name"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"Print", "[", "fullname", "]"}], ";", "\[IndentingNewLine]", 
          RowBox[{"ClearAll", "/@", 
           RowBox[{"{", "fullname", "}"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"S", "=", 
           RowBox[{"Symbol", "[", "fullname", "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{"scalarQ", ",", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"With", "[", 
              RowBox[{
               RowBox[{"{", "\[IndentingNewLine]", 
                RowBox[{
                 RowBox[{"code2", "=", 
                  RowBox[{"N", "[", 
                   RowBox[{"Normal", "[", "matrix0", "]"}], "]"}]}], ",", 
                 "\[IndentingNewLine]", 
                 RowBox[{"args", "=", 
                  RowBox[{"Join", "[", 
                   RowBox[{"arglist", ",", 
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"{", 
                    RowBox[{"x", ",", "_Real", ",", "2"}], "}"}], ",", 
                    RowBox[{"{", 
                    RowBox[{"\[Omega]", ",", "_Real", ",", "1"}], "}"}]}], 
                    "}"}]}], "]"}]}]}], "\[IndentingNewLine]", "}"}], ",", 
               "\[IndentingNewLine]", 
               RowBox[{"SetCPackageFunction", "[", 
                RowBox[{"S", ",", "args", ",", "\[IndentingNewLine]", 
                 RowBox[{"\[Omega]", ".", 
                  RowBox[{"Table", "[", 
                   RowBox[{"code2", ",", 
                    RowBox[{"{", 
                    RowBox[{"i", ",", "1", ",", 
                    RowBox[{"Length", "[", "x", "]"}]}], "}"}]}], "]"}]}], 
                 ",", "\[IndentingNewLine]", "opts"}], "\[IndentingNewLine]", 
                "]"}]}], "\[IndentingNewLine]", "]"}], ";"}], 
            "\[IndentingNewLine]", ",", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"With", "[", 
              RowBox[{
               RowBox[{"{", "\[IndentingNewLine]", 
                RowBox[{
                 RowBox[{"code2", "=", " ", 
                  RowBox[{"N", "[", 
                   RowBox[{"Normal", "[", "matrix", "]"}], "]"}]}], ",", 
                 "\[IndentingNewLine]", 
                 RowBox[{"args", "=", 
                  RowBox[{"Join", "[", 
                   RowBox[{"arglist", ",", 
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"{", 
                    RowBox[{"x", ",", "_Real", ",", "2"}], "}"}], ",", 
                    RowBox[{"{", 
                    RowBox[{"\[Omega]", ",", "_Real", ",", "1"}], "}"}]}], 
                    "}"}]}], "]"}]}]}], "\[IndentingNewLine]", "}"}], ",", 
               "\[IndentingNewLine]", 
               RowBox[{"SetCPackageFunction", "[", 
                RowBox[{"S", ",", "args", ",", "\[IndentingNewLine]", 
                 RowBox[{"\[Omega]", ".", 
                  RowBox[{"Table", "[", 
                   RowBox[{"code2", ",", 
                    RowBox[{"{", 
                    RowBox[{"i", ",", "1", ",", 
                    RowBox[{"Length", "[", "x", "]"}]}], "}"}]}], "]"}]}], 
                 ",", "\[IndentingNewLine]", "opts"}], "\[IndentingNewLine]", 
                "]"}]}], "\[IndentingNewLine]", "]"}], ";"}]}], 
           "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
          "\[IndentingNewLine]", 
          RowBox[{"fullname", "=", 
           RowBox[{"\"\<getD\>\"", "<>", "name", "<>", "\"\<1\>\""}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"Print", "[", "fullname", "]"}], ";", "\[IndentingNewLine]", 
          RowBox[{"ClearAll", "/@", 
           RowBox[{"{", "fullname", "}"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"With", "[", 
           RowBox[{
            RowBox[{"{", "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"code2", "=", 
               RowBox[{"N", "[", 
                RowBox[{
                 RowBox[{"Flatten", "[", "UU", "]"}], ".", "Dmatrix"}], 
                "]"}]}], ",", "\[IndentingNewLine]", 
              RowBox[{"args", "=", 
               RowBox[{"Join", "[", 
                RowBox[{"arglist", ",", 
                 RowBox[{"{", 
                  RowBox[{
                   RowBox[{"{", 
                    RowBox[{"x", ",", "_Real", ",", "2"}], "}"}], ",", 
                   RowBox[{"{", 
                    RowBox[{"\[Omega]", ",", "_Real", ",", "1"}], "}"}], ",", 
                   
                   RowBox[{"{", 
                    RowBox[{"U", ",", "_Real", ",", "2"}], "}"}]}], "}"}]}], 
                "]"}]}]}], "\[IndentingNewLine]", "}"}], ",", 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"SetCPackageFunction", "[", 
              RowBox[{
               RowBox[{"Symbol", "[", "fullname", "]"}], ",", "args", ",", 
               "\[IndentingNewLine]", 
               RowBox[{"\[Omega]", ".", 
                RowBox[{"Table", "[", 
                 RowBox[{"code2", ",", 
                  RowBox[{"{", 
                   RowBox[{"i", ",", "1", ",", 
                    RowBox[{"Length", "[", "x", "]"}]}], "}"}]}], "]"}]}], 
               ",", "\[IndentingNewLine]", "opts"}], "\[IndentingNewLine]", 
              "]"}], ";"}]}], "\[IndentingNewLine]", "]"}], ";", 
          "\[IndentingNewLine]", "\[IndentingNewLine]", 
          RowBox[{"fullname", "=", 
           RowBox[{"\"\<getD\>\"", "<>", "name", "<>", "\"\<3\>\""}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"Print", "[", "fullname", "]"}], ";", "\[IndentingNewLine]", 
          RowBox[{"ClearAll", "/@", 
           RowBox[{"{", "fullname", "}"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"With", "[", 
           RowBox[{
            RowBox[{"{", "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"code2", "=", 
               RowBox[{"N", "[", 
                RowBox[{"Dmatrix", ".", 
                 RowBox[{"Flatten", "[", 
                  RowBox[{"Flatten", "[", "UU", "]"}], "]"}]}], "]"}]}], ",", 
              "\[IndentingNewLine]", 
              RowBox[{"args", "=", 
               RowBox[{"Join", "[", 
                RowBox[{"arglist", ",", 
                 RowBox[{"{", 
                  RowBox[{
                   RowBox[{"{", 
                    RowBox[{"x", ",", "_Real", ",", "2"}], "}"}], ",", 
                   RowBox[{"{", 
                    RowBox[{"\[Omega]", ",", "_Real", ",", "1"}], "}"}], ",", 
                   
                   RowBox[{"{", 
                    RowBox[{"U", ",", "_Real", ",", "2"}], "}"}]}], "}"}]}], 
                "]"}]}]}], "\[IndentingNewLine]", "}"}], ",", 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"SetCPackageFunction", "[", 
              RowBox[{
               RowBox[{"Symbol", "[", "fullname", "]"}], ",", "args", ",", 
               "\[IndentingNewLine]", 
               RowBox[{"\[Omega]", ".", 
                RowBox[{"Table", "[", 
                 RowBox[{"code2", ",", 
                  RowBox[{"{", 
                   RowBox[{"i", ",", "1", ",", 
                    RowBox[{"Length", "[", "x", "]"}]}], "}"}]}], "]"}]}], 
               ",", "\[IndentingNewLine]", "opts"}], "\[IndentingNewLine]", 
              "]"}], ";"}]}], "\[IndentingNewLine]", "]"}], ";", 
          "\[IndentingNewLine]", "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{
            RowBox[{"fullname", "=", 
             RowBox[{"\"\<getD\>\"", "<>", "name", "<>", "\"\<12\>\""}]}], 
            ";", "\[IndentingNewLine]", 
            RowBox[{"Print", "[", "fullname", "]"}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"ClearAll", "/@", 
             RowBox[{"{", "fullname", "}"}]}], ";", "\[IndentingNewLine]", 
            RowBox[{"With", "[", 
             RowBox[{
              RowBox[{"{", "\[IndentingNewLine]", 
               RowBox[{
                RowBox[{"code2", "=", 
                 RowBox[{"N", "[", 
                  RowBox[{
                   RowBox[{"Flatten", "[", "UU", "]"}], ".", 
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{"Flatten", "[", "VV", "]"}], ".", "Dmatrix"}], 
                    ")"}]}], "]"}]}], ",", "\[IndentingNewLine]", 
                RowBox[{"args", "=", 
                 RowBox[{"Join", "[", 
                  RowBox[{"arglist", ",", 
                   RowBox[{"{", 
                    RowBox[{
                    RowBox[{"{", 
                    RowBox[{"x", ",", "_Real", ",", "2"}], "}"}], ",", 
                    RowBox[{"{", 
                    RowBox[{"\[Omega]", ",", "_Real", ",", "1"}], "}"}], ",", 
                    
                    RowBox[{"{", 
                    RowBox[{"U", ",", "_Real", ",", "2"}], "}"}], ",", 
                    RowBox[{"{", 
                    RowBox[{"V", ",", "_Real", ",", "2"}], "}"}]}], "}"}]}], 
                  "]"}]}]}], "\[IndentingNewLine]", "}"}], ",", 
              "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{"SetCPackageFunction", "[", 
                RowBox[{
                 RowBox[{"Symbol", "[", "fullname", "]"}], ",", "args", ",", 
                 "\[IndentingNewLine]", 
                 RowBox[{"\[Omega]", ".", 
                  RowBox[{"Table", "[", 
                   RowBox[{"code2", ",", 
                    RowBox[{"{", 
                    RowBox[{"i", ",", "1", ",", 
                    RowBox[{"Length", "[", "x", "]"}]}], "}"}]}], "]"}]}], 
                 ",", "\[IndentingNewLine]", "opts"}], "\[IndentingNewLine]", 
                "]"}], ";"}]}], "\[IndentingNewLine]", "]"}], ";"}], "*)"}], 
          "\[IndentingNewLine]", "\[IndentingNewLine]", 
          RowBox[{"fullname", "=", 
           RowBox[{"\"\<getD\>\"", "<>", "name", "<>", "\"\<23\>\""}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"Print", "[", "fullname", "]"}], ";", "\[IndentingNewLine]", 
          RowBox[{"ClearAll", "/@", 
           RowBox[{"{", "fullname", "}"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"With", "[", 
           RowBox[{
            RowBox[{"{", "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"code", "=", " ", 
               RowBox[{"N", "[", 
                RowBox[{
                 RowBox[{"Im", "[", 
                  RowBox[{
                   RowBox[{"Normal", "[", "matrix0", "]"}], "/.", 
                   RowBox[{"Thread", "[", 
                    RowBox[{
                    RowBox[{"Flatten", "[", "derargs", "]"}], "\[Rule]", 
                    RowBox[{"Flatten", "[", 
                    RowBox[{"derargs", "+", 
                    RowBox[{"I", " ", "h", " ", "VV"}]}], "]"}]}], "]"}]}], 
                  "]"}], "/", "h"}], "]"}]}], ",", "\[IndentingNewLine]", 
              RowBox[{"(*", 
               RowBox[{
                RowBox[{"code", "=", " ", 
                 RowBox[{"N", "[", 
                  RowBox[{
                   RowBox[{"Flatten", "[", "UU", "]"}], ".", 
                   RowBox[{"(", 
                    RowBox[{"Dmatrix", ".", 
                    RowBox[{"Flatten", "[", "VV", "]"}]}], ")"}]}], "]"}]}], 
                ","}], "*)"}], "\[IndentingNewLine]", 
              RowBox[{"args", "=", 
               RowBox[{"Join", "[", 
                RowBox[{"arglist", ",", 
                 RowBox[{"{", 
                  RowBox[{
                   RowBox[{"{", 
                    RowBox[{"x", ",", "_Real", ",", "2"}], "}"}], ",", 
                   RowBox[{"{", 
                    RowBox[{"\[Omega]", ",", "_Real", ",", "1"}], "}"}], ",", 
                   
                   RowBox[{"{", 
                    RowBox[{"U", ",", "_Real", ",", "2"}], "}"}], ",", 
                   RowBox[{"{", 
                    RowBox[{"V", ",", "_Real", ",", "2"}], "}"}]}], "}"}]}], 
                "]"}]}]}], "\[IndentingNewLine]", "}"}], ",", 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"SetCPackageFunction", "[", 
              RowBox[{
               RowBox[{"Symbol", "[", "fullname", "]"}], ",", "args", ",", 
               "\[IndentingNewLine]", 
               RowBox[{"Flatten", "[", 
                RowBox[{
                 RowBox[{"(", 
                  RowBox[{"\[Omega]", ".", 
                   RowBox[{"Table", "[", 
                    RowBox[{"code", ",", 
                    RowBox[{"{", 
                    RowBox[{"i", ",", "1", ",", 
                    RowBox[{"Length", "[", "x", "]"}]}], "}"}]}], "]"}]}], 
                  ")"}], ".", "U"}], "]"}], ",", "\[IndentingNewLine]", 
               "opts"}], "\[IndentingNewLine]", "]"}], ";"}]}], 
           "\[IndentingNewLine]", "]"}], ";"}]}], "\[IndentingNewLine]", 
        "\[IndentingNewLine]", 
        RowBox[{"(*", 
         RowBox[{
          RowBox[{"fullname", "=", 
           RowBox[{"\"\<getD\>\"", "<>", "name", "<>", "\"\<13\>\""}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"Print", "[", "fullname", "]"}], ";", "\[IndentingNewLine]", 
          RowBox[{"ClearAll", "/@", 
           RowBox[{"{", "fullname", "}"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"With", "[", 
           RowBox[{
            RowBox[{"{", "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"code", "=", 
               RowBox[{"N", "[", 
                RowBox[{
                 RowBox[{"Flatten", "[", "UU", "]"}], ".", 
                 RowBox[{"(", 
                  RowBox[{"Dmatrix", ".", 
                   RowBox[{"Flatten", "[", "VV", "]"}]}], ")"}]}], "]"}]}], 
              ",", "\[IndentingNewLine]", 
              RowBox[{"args", "=", 
               RowBox[{"Join", "[", 
                RowBox[{"arglist", ",", 
                 RowBox[{"{", 
                  RowBox[{
                   RowBox[{"{", 
                    RowBox[{"x", ",", "_Real", ",", "2"}], "}"}], ",", 
                   RowBox[{"{", 
                    RowBox[{"\[Omega]", ",", "_Real", ",", "1"}], "}"}], ",", 
                   
                   RowBox[{"{", 
                    RowBox[{"U", ",", "_Real", ",", "2"}], "}"}], ",", 
                   RowBox[{"{", 
                    RowBox[{"V", ",", "_Real", ",", "2"}], "}"}]}], "}"}]}], 
                "]"}]}]}], "\[IndentingNewLine]", "}"}], ",", 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"SetCPackageFunction", "[", 
              RowBox[{
               RowBox[{"Symbol", "[", "fullname", "]"}], ",", "args", ",", 
               "\[IndentingNewLine]", 
               RowBox[{"\[Omega]", ".", 
                RowBox[{"Table", "[", 
                 RowBox[{"code", ",", 
                  RowBox[{"{", 
                   RowBox[{"i", ",", "1", ",", 
                    RowBox[{"Length", "[", "x", "]"}]}], "}"}]}], "]"}]}], 
               ",", "\[IndentingNewLine]", "opts"}], "\[IndentingNewLine]", 
              "]"}], ";"}]}], "\[IndentingNewLine]", "]"}], ";"}], "*)"}], 
        "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"(*", 
         RowBox[{
          RowBox[{"fullname", "=", 
           RowBox[{"\"\<getD\>\"", "<>", "name", "<>", "\"\<123\>\""}]}], ";",
           "\[IndentingNewLine]", 
          RowBox[{"Print", "[", "fullname", "]"}], ";", "\[IndentingNewLine]", 
          RowBox[{"ClearAll", "/@", 
           RowBox[{"{", "fullname", "}"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"With", "[", 
           RowBox[{
            RowBox[{"{", "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"code", "=", " ", 
               RowBox[{"N", "[", 
                RowBox[{
                 RowBox[{"Flatten", "[", "UU", "]"}], ".", 
                 RowBox[{"(", 
                  RowBox[{"Dmatrix", ".", 
                   RowBox[{"Flatten", "[", "WW", "]"}]}], ")"}]}], "]"}]}], 
              ",", "\[IndentingNewLine]", 
              RowBox[{"args", "=", 
               RowBox[{"Join", "[", 
                RowBox[{"arglist", ",", 
                 RowBox[{"{", 
                  RowBox[{
                   RowBox[{"{", 
                    RowBox[{"x", ",", "_Real", ",", "2"}], "}"}], ",", 
                   RowBox[{"{", 
                    RowBox[{"\[Omega]", ",", "_Real", ",", "1"}], "}"}], ",", 
                   
                   RowBox[{"{", 
                    RowBox[{"U", ",", "_Real", ",", "2"}], "}"}], ",", 
                   RowBox[{"{", 
                    RowBox[{"V", ",", "_Real", ",", "2"}], "}"}], ",", 
                   RowBox[{"{", 
                    RowBox[{"W", ",", "_Real", ",", "2"}], "}"}]}], "}"}]}], 
                "]"}]}]}], "\[IndentingNewLine]", "}"}], ",", 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"SetCPackageFunction", "[", 
              RowBox[{
               RowBox[{"Symbol", "[", "fullname", "]"}], ",", "args", ",", 
               "\[IndentingNewLine]", 
               RowBox[{"\[Omega]", ".", 
                RowBox[{"Table", "[", 
                 RowBox[{"code", ",", 
                  RowBox[{"{", 
                   RowBox[{"i", ",", "1", ",", 
                    RowBox[{"Length", "[", "x", "]"}]}], "}"}]}], "]"}]}], 
               ",", "\[IndentingNewLine]", "opts"}], "\[IndentingNewLine]", 
              "]"}], ";"}]}], "\[IndentingNewLine]", "]"}], ";"}], "*)"}], 
        "\[IndentingNewLine]", "\[IndentingNewLine]", "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"toc", "=", 
        RowBox[{"AbsoluteTime", "[", "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"Print", "[", 
        RowBox[{
         RowBox[{
         "\"\<Code preparation for \>\"", "<>", "name", "<>", 
          "\"\< completed. Time elapsed: \>\""}], ",", 
         RowBox[{"toc", "-", "tic"}], ",", "\"\< s.\>\""}], "]"}], ";"}]}], 
     "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", "\[IndentingNewLine]", "]"}]], "Input",
 CellChangeTimes->{{3.7641573402923813`*^9, 3.764157345167528*^9}, {
   3.764157952423689*^9, 3.764157954942569*^9}, {3.764159409983902*^9, 
   3.7641594283183537`*^9}, {3.7641599896474123`*^9, 3.764159992223135*^9}, {
   3.764166530674622*^9, 3.764166614009687*^9}, {3.764173939098946*^9, 
   3.764173993724655*^9}, {3.764174494100216*^9, 3.764174494467182*^9}, {
   3.764174544279022*^9, 3.764174555494102*^9}, {3.7641749563243723`*^9, 
   3.7641749674025927`*^9}, 3.764175015462605*^9, {3.764175095348694*^9, 
   3.764175184248507*^9}, {3.7641760797472258`*^9, 3.764176097381002*^9}, {
   3.7643129337693996`*^9, 3.764312936483609*^9}, 3.764313722283448*^9, {
   3.7643138857190113`*^9, 3.764313887502307*^9}, {3.7643141946348753`*^9, 
   3.7643142029126873`*^9}, {3.7648537180981083`*^9, 
   3.7648537228905487`*^9}, {3.7648542176608057`*^9, 3.764854220385414*^9}, {
   3.764854298046619*^9, 3.76485433763586*^9}, {3.764854439434617*^9, 
   3.7648544540702257`*^9}, {3.7648545403542337`*^9, 
   3.7648545565037003`*^9}, {3.76485477184309*^9, 3.7648547767981443`*^9}, 
   3.764854832740232*^9, {3.76485525911771*^9, 3.764855263596542*^9}, {
   3.7648610024198017`*^9, 3.764861003408266*^9}, {3.780493452751672*^9, 
   3.780493515420145*^9}, {3.783943055783121*^9, 3.783943064311059*^9}, 
   3.787303410020018*^9, 3.787303456110951*^9},
 CellLabel->
  "In[103]:=",ExpressionUUID->"f778253d-2b93-4468-b361-932b308feb98"],

Cell[BoxData[
 RowBox[{"\[IndentingNewLine]", "\[IndentingNewLine]"}]], "Input",
 CellChangeTimes->{{3.764159957999332*^9, 3.764159958139317*^9}},
 CellLabel->"In[37]:=",ExpressionUUID->"4fad4855-a249-4c2d-b401-c35c5a7e8abf"],

Cell[BoxData[
 RowBox[{"VerbatimRegion", "[", "\[IndentingNewLine]", "\[IndentingNewLine]", 
  
  RowBox[{
   RowBox[{"ClearAll", "[", "CreateDoubleIntegralMetric", "]"}], ";", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"CreateDoubleIntegralMetric", "::", "usage"}], "=", "\"\<\>\""}], 
   ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"SetAttributes", "[", 
    RowBox[{"CreateDoubleIntegralMetric", ",", "HoldRest"}], "]"}], ";", 
   RowBox[{
    RowBox[{"CreateDoubleIntegralMetric", "[", 
     RowBox[{"name0_", ",", "type0_", ",", "tuplefun0_", ",", "funlist0_"}], 
     "]"}], ":=", "\[IndentingNewLine]", 
    RowBox[{"Block", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"M", ",", "name"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"name", "=", 
        RowBox[{"name0", "<>", "\"\<Metric\>\""}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"With", "[", 
        RowBox[{
         RowBox[{"{", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"F", "=", 
            RowBox[{"Symbol", "[", "name", "]"}]}], ",", 
           "\[IndentingNewLine]", 
           RowBox[{"type", "=", "type0"}], ",", "\[IndentingNewLine]", 
           RowBox[{"tuplefun", "=", "tuplefun0"}], ",", "\[IndentingNewLine]", 
           RowBox[{"funlist", "=", 
            RowBox[{"Flatten", "[", 
             RowBox[{"{", "funlist0", "}"}], "]"}]}], ",", 
           "\[IndentingNewLine]", 
           RowBox[{"dim", "=", 
            RowBox[{"IntrinsicDimension", "[", "type0", "]"}]}], ",", 
           "\[IndentingNewLine]", 
           RowBox[{"cfname", "=", 
            RowBox[{"name", "<>", 
             RowBox[{"IntegerString", "[", 
              RowBox[{"IntrinsicDimension", "[", "type0", "]"}], "]"}], "<>", 
             "\"\<D\>\""}]}]}], "\[IndentingNewLine]", "}"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"F", "=", 
           RowBox[{"PackageFunction", "[", 
            RowBox[{
             RowBox[{"Pattern", "[", 
              RowBox[{"M", ",", 
               RowBox[{"Blank", "[", "type", "]"}]}], "]"}], ",", 
             "\[IndentingNewLine]", 
             RowBox[{"Module", "[", 
              RowBox[{
               RowBox[{"{", 
                RowBox[{"a", ",", "d", ",", "cf", ",", "vals"}], "}"}], ",", 
               "\[IndentingNewLine]", 
               RowBox[{
                RowBox[{"d", "=", 
                 RowBox[{"EmbeddingDimension", "[", "M", "]"}]}], ";", 
                "\[IndentingNewLine]", 
                RowBox[{"cf", "=", 
                 RowBox[{"Symbol", "[", 
                  RowBox[{"\"\<get\>\"", "<>", "cfname", "<>", 
                   RowBox[{"ToString", "[", "d", "]"}], "<>", "\"\<D\>\""}], 
                  "]"}]}], ";", "\[IndentingNewLine]", 
                RowBox[{"vals", "=", 
                 RowBox[{"cf", "[", 
                  RowBox[{"Sequence", "@@", 
                   RowBox[{"Through", "[", 
                    RowBox[{"funlist", "[", "M", "]"}], "]"}]}], "]"}]}], ";",
                 "\[IndentingNewLine]", 
                RowBox[{"a", "=", 
                 RowBox[{"If", "[", 
                  RowBox[{
                   RowBox[{
                    RowBox[{
                    RowBox[{"Dimensions", "[", "vals", "]"}], 
                    "\[LeftDoubleBracket]", 
                    RowBox[{"-", "1"}], "\[RightDoubleBracket]"}], "\[Equal]", 
                    RowBox[{"2", 
                    RowBox[{"(", 
                    RowBox[{"dim", "+", "1"}], ")"}]}]}], ",", 
                   "\[IndentingNewLine]", 
                   RowBox[{
                   "IsotropicDoubleIntegralMetricCombinatorics", "[", "M", 
                    "]"}], ",", "\[IndentingNewLine]", 
                   RowBox[{
                   "AnisotropicDoubleIntegralMetricCombinatorics", "[", "M", 
                    "]"}]}], "\[IndentingNewLine]", "]"}]}], ";", 
                "\[IndentingNewLine]", 
                RowBox[{"Normal", "[", 
                 RowBox[{"a", "[", 
                  RowBox[{"Flatten", "[", "vals", "]"}], "]"}], "]"}]}]}], 
              "\[IndentingNewLine]", "]"}], ",", "\[IndentingNewLine]", 
             RowBox[{"Caching", "\[Rule]", "True"}]}], "\[IndentingNewLine]", 
            "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{
            RowBox[{"Derivative", "[", "1", "]"}], "[", "F", "]"}], "=", 
           RowBox[{"PackageFunction", "[", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{
               RowBox[{"Pattern", "[", 
                RowBox[{"M", ",", 
                 RowBox[{"Blank", "[", "type", "]"}]}], "]"}], ",", 
               "ulist_List", ",", "slotlist_List"}], "}"}], ",", 
             RowBox[{"Module", "[", 
              RowBox[{
               RowBox[{"{", 
                RowBox[{
                "a", ",", "fun", ",", "funname", ",", "udistlist", ",", 
                 "data", ",", "d"}], "}"}], ",", "\[IndentingNewLine]", 
               RowBox[{
                RowBox[{"d", "=", 
                 RowBox[{"EmbeddingDimension", "[", "M", "]"}]}], ";", 
                "\[IndentingNewLine]", 
                RowBox[{"funname", "=", 
                 RowBox[{"\"\<getD\>\"", "<>", "cfname", "<>", 
                  RowBox[{"IntegerString", "[", "d", "]"}], "<>", "\"\<D\>\"",
                   "<>", 
                  RowBox[{"IntegerString", "/@", 
                   RowBox[{"Sort", "[", "slotlist", "]"}]}]}]}], ";", 
                "\[IndentingNewLine]", 
                RowBox[{"fun", "=", 
                 RowBox[{"Symbol", "[", "funname", "]"}]}], ";", 
                "\[IndentingNewLine]", 
                RowBox[{"data", "=", 
                 RowBox[{"fun", "[", "\[IndentingNewLine]", 
                  RowBox[{
                   RowBox[{"Sequence", "@@", 
                    RowBox[{"Through", "[", 
                    RowBox[{"funlist", "[", "M", "]"}], "]"}]}], ",", 
                   "\[IndentingNewLine]", 
                   RowBox[{"Sequence", "@@", 
                    RowBox[{"Table", "[", 
                    RowBox[{
                    RowBox[{"DistributeVector", "[", 
                    RowBox[{"M", ",", "tuplefun", ",", 
                    RowBox[{
                    "ulist", "\[LeftDoubleBracket]", "i", 
                    "\[RightDoubleBracket]"}]}], "]"}], ",", 
                    RowBox[{"{", 
                    RowBox[{"i", ",", 
                    RowBox[{"Ordering", "[", "slotlist", "]"}]}], "}"}]}], 
                    "]"}]}]}], "\[IndentingNewLine]", "]"}]}], ";", 
                "\[IndentingNewLine]", 
                RowBox[{"If", "[", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"Length", "[", "slotlist", "]"}], "\[Equal]", 
                   "3"}], ",", 
                  RowBox[{"(*", "Then", "*)"}], "\[IndentingNewLine]", 
                  RowBox[{"Total", "[", "data", "]"}], ",", 
                  RowBox[{"(*", "Else", "*)"}], "\[IndentingNewLine]", 
                  RowBox[{
                   RowBox[{"a", "=", 
                    RowBox[{"AssemblyCombinatorics", "[", 
                    RowBox[{"M", ",", "tuplefun", ",", 
                    RowBox[{"3", "-", 
                    RowBox[{"Length", "[", "slotlist", "]"}]}], ",", 
                    "\"\<Global\>\"", ",", "1"}], "]"}]}], ";", 
                   "\[IndentingNewLine]", 
                   RowBox[{"a", "[", "data", "]"}]}]}], "\[IndentingNewLine]",
                  "]"}]}]}], "\[IndentingNewLine]", "]"}]}], 
            "\[IndentingNewLine]", "]"}]}]}]}], "\[IndentingNewLine]", 
        "]"}]}]}], "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", "\[IndentingNewLine]", "]"}]], "Input",
 CellChangeTimes->{{3.7641599594014893`*^9, 3.7641599818300123`*^9}, 
   3.764160349396185*^9, {3.7641604399047728`*^9, 3.764160478414679*^9}, {
   3.764160512668787*^9, 3.764160649162375*^9}, {3.764160690467342*^9, 
   3.764160694025249*^9}, {3.7641633210908203`*^9, 3.7641633245461273`*^9}, {
   3.7641642636651382`*^9, 3.764164267846447*^9}, {3.7641753113861322`*^9, 
   3.764175314319193*^9}, {3.7641756957276793`*^9, 3.764175710949102*^9}, {
   3.764175810368067*^9, 3.764175818803685*^9}, {3.764175890897746*^9, 
   3.7641758969425097`*^9}, 3.764176025913423*^9, {3.7641762167938833`*^9, 
   3.764176232078862*^9}, {3.764176652757728*^9, 3.76417666103531*^9}, {
   3.764312415872024*^9, 3.764312616619813*^9}, {3.764312701828128*^9, 
   3.764312731658514*^9}, {3.764312845185986*^9, 3.764312871720978*^9}, {
   3.76431335240932*^9, 3.764313353583034*^9}, 3.764313737058387*^9, {
   3.764313809563326*^9, 3.764313811943673*^9}, {3.764313877382711*^9, 
   3.76431387929979*^9}, {3.783941957566984*^9, 3.7839419642949047`*^9}, {
   3.783942001206194*^9, 3.783942034530875*^9}, {3.783956959619719*^9, 
   3.7839570044207897`*^9}, 3.7839576155399933`*^9, {3.7839577887098513`*^9, 
   3.783957827265134*^9}, {3.78395787484182*^9, 3.783957876520505*^9}, {
   3.78395973812643*^9, 
   3.783959752365396*^9}},ExpressionUUID->"cbb5382a-1908-43b5-bb67-\
4d5d6a618a29"]
},
WindowSize->{1440, 855},
WindowMargins->{{376, Automatic}, {Automatic, 44}},
FrontEndVersion->"12.0 for Mac OS X x86 (64-bit) (April 8, 2019)",
StyleDefinitions->"Default.nb"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[558, 20, 1692, 39, 367, "Input",ExpressionUUID->"d81fce63-a538-445f-9c06-9f7ec68169c7"],
Cell[2253, 61, 1517, 34, 367, "Input",ExpressionUUID->"96d35d7b-ce89-4cb6-a353-ebbd8ddb5e5d"],
Cell[3773, 97, 1517, 34, 367, "Input",ExpressionUUID->"946877d5-23c6-4500-8478-caa44c9d25fd"],
Cell[5293, 133, 2376, 54, 442, "Input",ExpressionUUID->"b035c983-38ad-4683-a1b0-ce38836ed81a"],
Cell[7672, 189, 2236, 53, 442, "Input",ExpressionUUID->"9e4f1343-282a-4390-9b0a-46f8738511aa"],
Cell[9911, 244, 27396, 592, 4092, "Input",ExpressionUUID->"f778253d-2b93-4468-b361-932b308feb98"],
Cell[37310, 838, 225, 3, 92, "Input",ExpressionUUID->"4fad4855-a249-4c2d-b401-c35c5a7e8abf"],
Cell[37538, 843, 9248, 189, 1317, "Input",ExpressionUUID->"cbb5382a-1908-43b5-bb67-4d5d6a618a29"]
}
]
*)

