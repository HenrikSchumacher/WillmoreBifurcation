(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 11.3' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       158,          7]
NotebookDataLength[     64800,       1387]
NotebookOptionsPosition[     63732,       1366]
NotebookOutlinePosition[     64068,       1381]
CellTagsIndexPosition[     64025,       1378]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{
Cell[BoxData[
 RowBox[{"getIsotropicTripleIntegralMetricCombinatorics", "=", 
  RowBox[{"CPackageFunction", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"{", 
      RowBox[{"q", ",", "_Integer", ",", "1"}], "}"}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"Flatten", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Table", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Table", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"Compile`GetElement", "[", 
             RowBox[{"q", ",", "i"}], "]"}], ",", 
            RowBox[{"Compile`GetElement", "[", 
             RowBox[{"q", ",", "j"}], "]"}]}], "}"}], "\[IndentingNewLine]", 
          ",", 
          RowBox[{"{", 
           RowBox[{"i", ",", "1", ",", 
            RowBox[{"Length", "[", "q", "]"}]}], "}"}]}], "]"}], 
        "\[IndentingNewLine]", ",", 
        RowBox[{"{", 
         RowBox[{"j", ",", "1", ",", 
          RowBox[{"Length", "[", "q", "]"}]}], "}"}]}], "]"}], ",", 
      "\[IndentingNewLine]", "1"}], "\[IndentingNewLine]", "]"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"CompilationTarget", "\[Rule]", "\"\<C\>\""}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"RuntimeAttributes", "\[Rule]", 
     RowBox[{"{", "Listable", "}"}]}], ",", "\[IndentingNewLine]", 
    RowBox[{"Parallelization", "\[Rule]", "True"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"RuntimeOptions", "\[Rule]", "\"\<Speed\>\""}]}], 
   "\[IndentingNewLine]", "]"}]}]], "Input",
 CellChangeTimes->{{3.764163362173078*^9, 3.7641633684659643`*^9}, 
   3.765118051689808*^9, {3.7651181123500347`*^9, 3.765118146052785*^9}, {
   3.765121367365171*^9, 3.765121381130025*^9}, {3.765121739306353*^9, 
   3.765121739504149*^9}},
 CellLabel->"In[10]:=",ExpressionUUID->"d81fce63-a538-445f-9c06-9f7ec68169c7"],

Cell[BoxData[
 RowBox[{"getIsotropicTripleIntegralMetricIList", "=", 
  RowBox[{"CPackageFunction", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"{", 
      RowBox[{"q", ",", "_Integer", ",", "1"}], "}"}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"Flatten", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Table", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Table", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"Compile`GetElement", "[", 
           RowBox[{"q", ",", "i"}], "]"}], "\[IndentingNewLine]", ",", 
          RowBox[{"{", 
           RowBox[{"i", ",", "1", ",", 
            RowBox[{"Length", "[", "q", "]"}]}], "}"}]}], "]"}], 
        "\[IndentingNewLine]", ",", 
        RowBox[{"{", 
         RowBox[{"j", ",", "1", ",", 
          RowBox[{"Length", "[", "q", "]"}]}], "}"}]}], "]"}], ",", 
      "\[IndentingNewLine]", "1"}], "\[IndentingNewLine]", "]"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"CompilationTarget", "\[Rule]", "\"\<C\>\""}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"RuntimeAttributes", "\[Rule]", 
     RowBox[{"{", "Listable", "}"}]}], ",", "\[IndentingNewLine]", 
    RowBox[{"Parallelization", "\[Rule]", "True"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"RuntimeOptions", "\[Rule]", "\"\<Speed\>\""}]}], 
   "\[IndentingNewLine]", "]"}]}]], "Input",
 CellChangeTimes->{{3.7641382243864107`*^9, 3.764138229802411*^9}, 
   3.765118051898694*^9, {3.7651181338679028`*^9, 3.765118144020568*^9}, {
   3.765121376339692*^9, 3.7651213796584044`*^9}},
 CellLabel->"In[11]:=",ExpressionUUID->"96d35d7b-ce89-4cb6-a353-ebbd8ddb5e5d"],

Cell[BoxData[
 RowBox[{"getIsotropicTripleIntegralMetricJList", "=", 
  RowBox[{"CPackageFunction", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"{", 
      RowBox[{"q", ",", "_Integer", ",", "1"}], "}"}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"Flatten", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Table", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Table", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"Compile`GetElement", "[", 
           RowBox[{"q", ",", "j"}], "]"}], "\[IndentingNewLine]", ",", 
          RowBox[{"{", 
           RowBox[{"i", ",", "1", ",", 
            RowBox[{"Length", "[", "q", "]"}]}], "}"}]}], "]"}], 
        "\[IndentingNewLine]", ",", 
        RowBox[{"{", 
         RowBox[{"j", ",", "1", ",", 
          RowBox[{"Length", "[", "q", "]"}]}], "}"}]}], "]"}], ",", 
      "\[IndentingNewLine]", "1"}], "\[IndentingNewLine]", "]"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"CompilationTarget", "\[Rule]", "\"\<C\>\""}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"RuntimeAttributes", "\[Rule]", 
     RowBox[{"{", "Listable", "}"}]}], ",", "\[IndentingNewLine]", 
    RowBox[{"Parallelization", "\[Rule]", "True"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"RuntimeOptions", "\[Rule]", "\"\<Speed\>\""}]}], 
   "\[IndentingNewLine]", "]"}]}]], "Input",
 CellChangeTimes->{{3.7641382243864107`*^9, 3.764138271353284*^9}, 
   3.765118052101026*^9, {3.7651181490747643`*^9, 3.76511815575638*^9}, {
   3.765121384571877*^9, 3.765121388306286*^9}},
 CellLabel->"In[12]:=",ExpressionUUID->"946877d5-23c6-4500-8478-caa44c9d25fd"],

Cell[BoxData[
 RowBox[{"getAnisotropicTripleIntegralMetricIList", "=", 
  RowBox[{"CPackageFunction", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"q", ",", "_Integer", ",", "1"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"d", ",", "_Integer"}], "}"}]}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"Flatten", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Table", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Table", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"Table", "[", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"Table", "[", "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{
               RowBox[{"d", 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{"Compile`GetElement", "[", 
                   RowBox[{"q", ",", "i"}], "]"}], "-", "1"}], ")"}]}], "+", 
               "ii"}], "\[IndentingNewLine]", ",", 
              RowBox[{"{", 
               RowBox[{"ii", ",", "1", ",", "d"}], "}"}]}], "]"}], 
            "\[IndentingNewLine]", ",", 
            RowBox[{"{", 
             RowBox[{"i", ",", "1", ",", 
              RowBox[{"Length", "[", "q", "]"}]}], "}"}]}], "]"}], 
          "\[IndentingNewLine]", ",", 
          RowBox[{"{", 
           RowBox[{"jj", ",", "1", ",", "d"}], "}"}]}], "]"}], 
        "\[IndentingNewLine]", ",", 
        RowBox[{"{", 
         RowBox[{"j", ",", "1", ",", 
          RowBox[{"Length", "[", "q", "]"}]}], "}"}]}], "]"}], ",", 
      "\[IndentingNewLine]", "3"}], "]"}], ",", "\[IndentingNewLine]", 
    RowBox[{"CompilationTarget", "\[Rule]", "\"\<C\>\""}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"RuntimeAttributes", "\[Rule]", 
     RowBox[{"{", "Listable", "}"}]}], ",", "\[IndentingNewLine]", 
    RowBox[{"Parallelization", "\[Rule]", "True"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"RuntimeOptions", "\[Rule]", "\"\<Speed\>\""}]}], 
   "\[IndentingNewLine]", "]"}]}]], "Input",
 CellChangeTimes->{{3.7641375498974953`*^9, 3.764137614652972*^9}, {
   3.764137673557148*^9, 3.764137676779846*^9}, {3.764137745949451*^9, 
   3.7641377719217243`*^9}, {3.764138294346353*^9, 3.764138320167807*^9}, {
   3.764168368256979*^9, 3.764168378838725*^9}, 3.7651180523402033`*^9, {
   3.7651182189464903`*^9, 3.7651182350417*^9}, 3.7651182658202877`*^9, {
   3.765121404658935*^9, 3.765121408833826*^9}},
 CellLabel->"In[13]:=",ExpressionUUID->"b035c983-38ad-4683-a1b0-ce38836ed81a"],

Cell[BoxData[
 RowBox[{"getAnisotropicTripleIntegralMetricJList", "=", 
  RowBox[{"CPackageFunction", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"q", ",", "_Integer", ",", "1"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"d", ",", "_Integer"}], "}"}]}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"Flatten", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Table", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Table", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"Table", "[", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"Table", "[", "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{
               RowBox[{"d", 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{"Compile`GetElement", "[", 
                   RowBox[{"q", ",", "j"}], "]"}], "-", "1"}], ")"}]}], "+", 
               "jj"}], "\[IndentingNewLine]", ",", 
              RowBox[{"{", 
               RowBox[{"ii", ",", "1", ",", "d"}], "}"}]}], "]"}], 
            "\[IndentingNewLine]", ",", 
            RowBox[{"{", 
             RowBox[{"i", ",", "1", ",", 
              RowBox[{"Length", "[", "q", "]"}]}], "}"}]}], "]"}], 
          "\[IndentingNewLine]", ",", 
          RowBox[{"{", 
           RowBox[{"jj", ",", "1", ",", "d"}], "}"}]}], "]"}], 
        "\[IndentingNewLine]", ",", 
        RowBox[{"{", 
         RowBox[{"j", ",", "1", ",", 
          RowBox[{"Length", "[", "q", "]"}]}], "}"}]}], "]"}], ",", 
      "\[IndentingNewLine]", "3"}], "]"}], ",", "\[IndentingNewLine]", 
    RowBox[{"CompilationTarget", "\[Rule]", "\"\<C\>\""}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"RuntimeAttributes", "\[Rule]", 
     RowBox[{"{", "Listable", "}"}]}], ",", "\[IndentingNewLine]", 
    RowBox[{"Parallelization", "\[Rule]", "True"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"RuntimeOptions", "\[Rule]", "\"\<Speed\>\""}]}], 
   "\[IndentingNewLine]", "]"}]}]], "Input",
 CellChangeTimes->{{3.7641634773072863`*^9, 3.76416347777006*^9}, {
   3.7641683352542677`*^9, 3.764168389030869*^9}, 3.765118052902124*^9, {
   3.7651182869204283`*^9, 3.765118305272422*^9}, {3.765121413482765*^9, 
   3.765121418176976*^9}},
 CellLabel->"In[14]:=",ExpressionUUID->"9e4f1343-282a-4390-9b0a-46f8738511aa"],

Cell[BoxData[
 RowBox[{"VerbatimRegion", "[", "\[IndentingNewLine]", "\[IndentingNewLine]", 
  
  RowBox[{
   RowBox[{
    RowBox[{"IsotropicTripleIntegralMetricCombinatorics", "::", "usage"}], 
    "=", "\"\<\>\""}], ";", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"AnisotropicTripleIntegralMetricCombinatorics", "::", "usage"}], 
    "=", "\"\<\>\""}], ";", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"IntrinsicDimension", "::", "usage"}], "=", "\"\<\>\""}], ";", 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"ClearAll", "[", "CompileTripleIntegralEnergy", "]"}], ";", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"CompileTripleIntegralEnergy", "::", "usage"}], "=", "\"\<\>\""}],
    ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"SetAttributes", "[", 
    RowBox[{"CompileTripleIntegralEnergy", ",", "HoldRest"}], "]"}], ";", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"CompileTripleIntegralEnergy", "[", 
     RowBox[{
     "name0_", ",", "arglist_", ",", "f_", ",", "derargs0_", ",", "dim_", ",",
       "d_", ",", "\[IndentingNewLine]", 
      RowBox[{"OptionsPattern", "[", 
       RowBox[{"{", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"\"\<CompilationTarget\>\"", "\[Rule]", "\"\<C\>\""}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"\"\<Parallelization\>\"", "\[Rule]", "True"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"\"\<RuntimeAttributes\>\"", "\[Rule]", "Listable"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"\"\<RuntimeOptions\>\"", "\[Rule]", "\"\<Speed\>\""}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"\"\<CompilationOptions\>\"", "\[Rule]", 
          RowBox[{"{", "}"}]}], ",", "\[IndentingNewLine]", 
         RowBox[{"\"\<Derivatives\>\"", "\[Rule]", "2"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"\"\<PrintCode\>\"", "\[Rule]", "False"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"\"\<ExportPseudoCode\>\"", "\[Rule]", "False"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"\"\<OptimizationLevel\>\"", "\[Rule]", "1"}]}], 
        "\[IndentingNewLine]", "}"}], "]"}]}], "]"}], ":=", 
    "\[IndentingNewLine]", 
    RowBox[{"Block", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "name", ",", "U", ",", "UU", ",", "UU1", ",", "UU2", ",", "UU3", ",", 
        "UU4", ",", "U1", ",", "U2", ",", "U3", ",", "U4", ",", "VV", ",", 
        "V", ",", "WW", ",", "W", ",", "derargs", ",", "l", ",", "dims", ",", 
        "pos", ",", "dcode", ",", "r", ",", "der", ",", "vecarglist", ",", 
        "tuples", ",", "S", ",", "s", ",", "code0", ",", "code1", ",", "code",
         ",", "rule", ",", "xx", ",", "x", ",", "\[Omega]", ",", "i", ",", 
        "tic", ",", "toc", ",", "h"}], "}"}], ",", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"h", "=", 
        RowBox[{"2.", "^", 
         RowBox[{"-", "20"}]}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"name", "=", 
        RowBox[{"name0", "<>", "\"\<Energy\>\"", "<>", 
         RowBox[{"ToString", "[", "dim", "]"}], "<>", "\"\<D\>\"", "<>", 
         RowBox[{"ToString", "[", "d", "]"}], "<>", "\"\<D\>\""}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"PrintTemporary", "[", 
        RowBox[{
        "\"\<Preparing code for \>\"", "<>", "name", "<>", "\"\<...\>\""}], 
        "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"tic", "=", 
        RowBox[{"AbsoluteTime", "[", "]"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"xx", "=", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{"Compile`GetElement", "[", 
           RowBox[{"x", ",", "i", ",", "j"}], "]"}], ",", 
          RowBox[{"{", 
           RowBox[{"j", ",", "1", ",", 
            RowBox[{"3", " ", "dim"}]}], "}"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"code0", "=", 
        RowBox[{
         RowBox[{"3", "!"}], 
         RowBox[{"f", "[", "xx", "]"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"der", "=", 
        RowBox[{"OptionValue", "[", "\"\<Derivatives\>\"", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"rule", "=", 
        RowBox[{"Part", "\[Rule]", "Compile`GetElement"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"derargs", "=", 
        RowBox[{"Flatten", "[", 
         RowBox[{"derargs0", "/.", "rule"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"r", "=", 
        RowBox[{"ArrayDepth", "[", "derargs", "]"}]}], ";", 
       RowBox[{"UU1", "=", "derargs"}], ";", 
       RowBox[{
        RowBox[{"UU1", "\[LeftDoubleBracket]", 
         RowBox[{
          RowBox[{"Sequence", "@@", 
           RowBox[{"ConstantArray", "[", 
            RowBox[{"All", ",", "r"}], "]"}]}], ",", "1"}], 
         "\[RightDoubleBracket]"}], "=", "U1"}], ";", 
       RowBox[{"UU2", "=", "derargs"}], ";", 
       RowBox[{
        RowBox[{"UU2", "\[LeftDoubleBracket]", 
         RowBox[{
          RowBox[{"Sequence", "@@", 
           RowBox[{"ConstantArray", "[", 
            RowBox[{"All", ",", "r"}], "]"}]}], ",", "1"}], 
         "\[RightDoubleBracket]"}], "=", "U2"}], ";", 
       RowBox[{"UU3", "=", "derargs"}], ";", 
       RowBox[{
        RowBox[{"UU3", "\[LeftDoubleBracket]", 
         RowBox[{
          RowBox[{"Sequence", "@@", 
           RowBox[{"ConstantArray", "[", 
            RowBox[{"All", ",", "r"}], "]"}]}], ",", "1"}], 
         "\[RightDoubleBracket]"}], "=", "U3"}], ";", 
       RowBox[{"UU4", "=", "derargs"}], ";", 
       RowBox[{
        RowBox[{"UU4", "\[LeftDoubleBracket]", 
         RowBox[{
          RowBox[{"Sequence", "@@", 
           RowBox[{"ConstantArray", "[", 
            RowBox[{"All", ",", "r"}], "]"}]}], ",", "1"}], 
         "\[RightDoubleBracket]"}], "=", "U4"}], ";", 
       RowBox[{"UU", "=", 
        RowBox[{"{", 
         RowBox[{"UU1", ",", "UU2", ",", "UU3", ",", "UU4"}], "}"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"ArrayQ", "[", "code0", "]"}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"VV", "=", 
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"V", "[", 
              RowBox[{"[", "i", "]"}], "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"i", ",", "1", ",", 
               RowBox[{"Length", "[", 
                RowBox[{"Flatten", "[", "code0", "]"}], "]"}]}], "}"}]}], 
            "]"}]}], ";", 
          RowBox[{"WW", "=", 
           RowBox[{"{", 
            RowBox[{"VV", ",", "UU1", ",", "UU2", ",", "UU3", ",", "UU4"}], 
            "}"}]}], ";", 
          RowBox[{"vecarglist", "=", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"V", ",", "_Real", ",", "1"}], "}"}], ",", 
             RowBox[{"{", 
              RowBox[{"U1", ",", "_Real", ",", "r"}], "}"}], ",", 
             RowBox[{"{", 
              RowBox[{"U2", ",", "_Real", ",", "r"}], "}"}], ",", 
             RowBox[{"{", 
              RowBox[{"U3", ",", "_Real", ",", "r"}], "}"}], ",", 
             RowBox[{"{", 
              RowBox[{"U4", ",", "_Real", ",", "r"}], "}"}]}], "}"}]}], ";", 
          RowBox[{"code", "=", 
           RowBox[{"code0", "/.", "rule"}]}], ";"}], "\[IndentingNewLine]", 
         ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"VV", "=", 
           RowBox[{"{", "V", "}"}]}], ";", 
          RowBox[{"WW", "=", 
           RowBox[{"{", 
            RowBox[{"VV", ",", "UU1", ",", "UU2", ",", "UU3", ",", "UU4"}], 
            "}"}]}], ";", 
          RowBox[{"vecarglist", "=", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"V", ",", "_Real"}], "}"}], ",", 
             RowBox[{"{", 
              RowBox[{"U1", ",", "_Real", ",", "r"}], "}"}], ",", 
             RowBox[{"{", 
              RowBox[{"U2", ",", "_Real", ",", "r"}], "}"}], ",", 
             RowBox[{"{", 
              RowBox[{"U3", ",", "_Real", ",", "r"}], "}"}], ",", 
             RowBox[{"{", 
              RowBox[{"U4", ",", "_Real", ",", "r"}], "}"}]}], "}"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"code", "=", 
           RowBox[{
            RowBox[{"{", "code0", "}"}], "/.", "rule"}]}], ";"}]}], 
        "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"Do", "[", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{"dcode", "=", 
           RowBox[{"N", "[", 
            RowBox[{"D", "[", 
             RowBox[{"code", ",", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{"Flatten", "[", "derargs", "]"}], ",", "k"}], "}"}]}],
              "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"tuples", "=", 
           RowBox[{"SortBy", "[", 
            RowBox[{
             RowBox[{"Join", "[", 
              RowBox[{
               RowBox[{"Table", "[", 
                RowBox[{
                 RowBox[{"Range", "[", 
                  RowBox[{"1", ",", "i"}], "]"}], ",", 
                 RowBox[{"{", 
                  RowBox[{"i", ",", "0", ",", 
                   RowBox[{"k", "+", "1"}]}], "}"}]}], "]"}], ",", 
               RowBox[{"Table", "[", 
                RowBox[{
                 RowBox[{"Range", "[", 
                  RowBox[{"2", ",", "i"}], "]"}], ",", 
                 RowBox[{"{", 
                  RowBox[{"i", ",", "2", ",", 
                   RowBox[{"k", "+", "1"}]}], "}"}]}], "]"}]}], "]"}], ",", 
             "Length"}], "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"Table", "[", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{
             RowBox[{"l", "=", 
              RowBox[{"Length", "[", "slotlist", "]"}]}], ";", 
             "\[IndentingNewLine]", 
             RowBox[{"dims", "=", 
              RowBox[{"Dimensions", "[", "dcode", "]"}]}], ";", 
             "\[IndentingNewLine]", 
             RowBox[{"code1", "=", 
              RowBox[{"TensorVectorContract", "[", 
               RowBox[{"dcode", ",", 
                RowBox[{
                "WW", "\[LeftDoubleBracket]", "slotlist", 
                 "\[RightDoubleBracket]"}], ",", "slotlist"}], "]"}]}], ";", 
             "\[IndentingNewLine]", 
             RowBox[{"s", "=", 
              RowBox[{"StringJoin", "[", 
               RowBox[{"\"\<get\>\"", ",", 
                RowBox[{"ConstantArray", "[", 
                 RowBox[{"\"\<D\>\"", ",", "k"}], "]"}], ",", "name", ",", 
                RowBox[{"ToString", "/@", "slotlist"}]}], "]"}]}], ";", 
             RowBox[{"ClearAll", "/@", 
              RowBox[{"{", "s", "}"}]}], ";", 
             RowBox[{"S", "=", 
              RowBox[{"Symbol", "[", "s", "]"}]}], ";", "\[IndentingNewLine]", 
             RowBox[{"Print", "[", "s", "]"}], ";", "\[IndentingNewLine]", 
             RowBox[{"With", "[", 
              RowBox[{
               RowBox[{"{", "\[IndentingNewLine]", 
                RowBox[{
                 RowBox[{"args", "=", 
                  RowBox[{"Evaluate", "[", 
                   RowBox[{"Join", "[", 
                    RowBox[{"arglist", ",", 
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"{", 
                    RowBox[{"x", ",", "_Real", ",", "2"}], "}"}], ",", 
                    RowBox[{"{", 
                    RowBox[{"\[Omega]", ",", "_Real", ",", "1"}], "}"}]}], 
                    "}"}], ",", 
                    RowBox[{
                    "vecarglist", "\[LeftDoubleBracket]", "slotlist", 
                    "\[RightDoubleBracket]"}]}], "]"}], "]"}]}], ",", 
                 "\[IndentingNewLine]", 
                 RowBox[{"opts", "=", 
                  RowBox[{"Sequence", "[", "\[IndentingNewLine]", 
                   RowBox[{
                    RowBox[{"\"\<Parallelization\>\"", "\[Rule]", 
                    RowBox[{
                    "OptionValue", "[", "\"\<Parallelization\>\"", "]"}]}], 
                    ",", 
                    RowBox[{"\"\<RuntimeAttributes\>\"", "\[Rule]", 
                    RowBox[{
                    "OptionValue", "[", "\"\<RuntimeAttributes\>\"", "]"}]}], 
                    ",", 
                    RowBox[{"\"\<RuntimeOptions\>\"", "\[Rule]", 
                    RowBox[{
                    "OptionValue", "[", "\"\<RuntimeOptions\>\"", "]"}]}], 
                    ",", 
                    RowBox[{"\"\<CompilationOptions\>\"", "\[Rule]", 
                    RowBox[{
                    "OptionValue", "[", "\"\<CompilationOptions\>\"", "]"}]}],
                     ",", 
                    RowBox[{"\"\<ExportPseudoCode\>\"", "\[Rule]", 
                    RowBox[{
                    "OptionValue", "[", "\"\<ExportPseudoCode\>\"", "]"}]}]}],
                    "\[IndentingNewLine]", "]"}]}]}], "}"}], ",", 
               "\[IndentingNewLine]", 
               RowBox[{"If", "[", 
                RowBox[{"True", 
                 RowBox[{"(*", 
                  RowBox[{
                   RowBox[{"k", "\[NotEqual]", "2"}], "&&", 
                   RowBox[{
                    RowBox[{"Length", "[", "slotlist", "]"}], "\[NotEqual]", 
                    RowBox[{"{", "2", "}"}]}]}], "*)"}], ",", 
                 "\[IndentingNewLine]", 
                 RowBox[{"With", "[", 
                  RowBox[{
                   RowBox[{"{", 
                    RowBox[{"code2", "=", " ", "code1"}], "}"}], ",", 
                   "\[IndentingNewLine]", 
                   RowBox[{"SetCPackageFunction", "[", 
                    RowBox[{"S", ",", "args", ",", "\[IndentingNewLine]", 
                    RowBox[{"\[Omega]", ".", 
                    RowBox[{"Table", "[", 
                    RowBox[{"code2", ",", 
                    RowBox[{"{", 
                    RowBox[{"i", ",", "1", ",", 
                    RowBox[{"Length", "[", "x", "]"}]}], "}"}]}], "]"}]}], 
                    ",", "\[IndentingNewLine]", "opts"}], 
                    "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", 
                  "]"}]}], "\[IndentingNewLine]", "]"}]}], 
              "\[IndentingNewLine]", "]"}], ";"}], "\[IndentingNewLine]", ",",
             "\[IndentingNewLine]", 
            RowBox[{"{", 
             RowBox[{"slotlist", ",", "tuples"}], "}"}]}], "]"}]}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{"k", ",", "0", ",", 
           RowBox[{"Min", "[", 
            RowBox[{"2", ",", "der"}], "]"}]}], "}"}]}], "]"}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"dcode", "=", 
        RowBox[{"N", "[", 
         RowBox[{"D", "[", 
          RowBox[{"code", ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"Flatten", "[", "derargs", "]"}], ",", "1"}], "}"}]}], 
          "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"s", "=", 
        RowBox[{"StringJoin", "[", 
         RowBox[{"\"\<get\>\"", ",", 
          RowBox[{"ConstantArray", "[", 
           RowBox[{"\"\<D\>\"", ",", "2"}], "]"}], ",", "name", ",", 
          RowBox[{"IntegerString", "[", "2", "]"}]}], "]"}]}], ";", 
       RowBox[{"ClearAll", "/@", 
        RowBox[{"{", "s", "}"}]}], ";", 
       RowBox[{"S", "=", 
        RowBox[{"Symbol", "[", "s", "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"Print", "[", "s", "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"With", "[", 
        RowBox[{
         RowBox[{"{", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"code2", "=", " ", 
            RowBox[{"N", "[", 
             RowBox[{
              RowBox[{"Im", "[", 
               RowBox[{"dcode", "/.", 
                RowBox[{"Thread", "[", 
                 RowBox[{
                  RowBox[{"Flatten", "[", "derargs", "]"}], "\[Rule]", 
                  RowBox[{"Flatten", "[", 
                   RowBox[{"derargs", "+", 
                    RowBox[{"I", " ", "h", " ", "UU1"}]}], "]"}]}], "]"}]}], 
               "]"}], "/", "h"}], "]"}]}], ",", "\[IndentingNewLine]", 
           RowBox[{"args", "=", 
            RowBox[{"Evaluate", "[", 
             RowBox[{"Join", "[", 
              RowBox[{"arglist", ",", 
               RowBox[{"{", 
                RowBox[{
                 RowBox[{"{", 
                  RowBox[{"x", ",", "_Real", ",", "2"}], "}"}], ",", 
                 RowBox[{"{", 
                  RowBox[{"\[Omega]", ",", "_Real", ",", "1"}], "}"}], ",", 
                 RowBox[{"{", 
                  RowBox[{"U1", ",", "_Real", ",", "2"}], "}"}]}], "}"}]}], 
              "]"}], "]"}]}], ",", "\[IndentingNewLine]", 
           RowBox[{"opts", "=", 
            RowBox[{"Sequence", "[", "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"\"\<Parallelization\>\"", "\[Rule]", 
               RowBox[{"OptionValue", "[", "\"\<Parallelization\>\"", "]"}]}],
               ",", 
              RowBox[{"\"\<RuntimeAttributes\>\"", "\[Rule]", 
               RowBox[{
               "OptionValue", "[", "\"\<RuntimeAttributes\>\"", "]"}]}], ",", 
              
              RowBox[{"\"\<RuntimeOptions\>\"", "\[Rule]", 
               RowBox[{"OptionValue", "[", "\"\<RuntimeOptions\>\"", "]"}]}], 
              ",", 
              RowBox[{"\"\<CompilationOptions\>\"", "\[Rule]", 
               RowBox[{
               "OptionValue", "[", "\"\<CompilationOptions\>\"", "]"}]}], ",", 
              RowBox[{"\"\<ExportPseudoCode\>\"", "\[Rule]", 
               RowBox[{
               "OptionValue", "[", "\"\<ExportPseudoCode\>\"", "]"}]}]}], 
             "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", "}"}], 
         ",", "\[IndentingNewLine]", 
         RowBox[{"SetCPackageFunction", "[", 
          RowBox[{"S", ",", "args", ",", "\[IndentingNewLine]", 
           RowBox[{"\[Omega]", ".", 
            RowBox[{"Table", "[", 
             RowBox[{"code2", ",", 
              RowBox[{"{", 
               RowBox[{"i", ",", "1", ",", 
                RowBox[{"Length", "[", "x", "]"}]}], "}"}]}], "]"}]}], ",", 
           "\[IndentingNewLine]", "opts"}], "\[IndentingNewLine]", "]"}]}], 
        "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"toc", "=", 
        RowBox[{"AbsoluteTime", "[", "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"Print", "[", 
        RowBox[{
         RowBox[{
         "\"\<Code preparation for \>\"", "<>", "name", "<>", 
          "\"\< completed. Time elapsed: \>\""}], ",", 
         RowBox[{"toc", "-", "tic"}], ",", "\"\< s.\>\""}], "]"}], ";"}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", "\[IndentingNewLine]", "]"}]], "Input",
 CellChangeTimes->{{3.729593625824298*^9, 3.729593630354609*^9}, {
   3.730202353609103*^9, 3.73020235772609*^9}, {3.7302040613230343`*^9, 
   3.730204080281461*^9}, {3.730204113448863*^9, 3.7302041207860317`*^9}, {
   3.730204171168626*^9, 3.7302041748487062`*^9}, {3.730204204983519*^9, 
   3.7302042564994097`*^9}, {3.730204340742766*^9, 3.730204372505485*^9}, {
   3.730204452151264*^9, 3.730204458436018*^9}, {3.730204563360363*^9, 
   3.730204572609432*^9}, {3.7599147403295794`*^9, 3.7599148501246758`*^9}, {
   3.759914969967636*^9, 3.759914985780315*^9}, {3.759915668931088*^9, 
   3.759915674544471*^9}, {3.7600960791391563`*^9, 3.7600960878727217`*^9}, {
   3.7600962014782953`*^9, 3.760096207335782*^9}, {3.760096344554895*^9, 
   3.7600963447766123`*^9}, {3.7641433563322887`*^9, 3.764143410177197*^9}, {
   3.764143513036746*^9, 3.76414358687113*^9}, {3.764143681292588*^9, 
   3.7641436999169064`*^9}, 3.764143912004985*^9, {3.764144279244767*^9, 
   3.764144296449728*^9}, {3.764144400406333*^9, 3.764144410005801*^9}, {
   3.764144520387877*^9, 3.764144526179541*^9}, 3.764144562528685*^9, {
   3.764144623565506*^9, 3.7641446250994253`*^9}, {3.7641447236821527`*^9, 
   3.7641447495000763`*^9}, {3.7641447875870333`*^9, 3.764144815524273*^9}, {
   3.764144845723497*^9, 3.764144959336637*^9}, {3.76414571853843*^9, 
   3.764145852986369*^9}, {3.764146068415716*^9, 3.764146070918599*^9}, {
   3.764146118761691*^9, 3.764146142491514*^9}, {3.7641465380196*^9, 
   3.764146678935933*^9}, {3.7641472025959044`*^9, 3.764147235533601*^9}, {
   3.7641472717703247`*^9, 3.7641472733133307`*^9}, {3.764147507580612*^9, 
   3.764147573650118*^9}, {3.764147612343392*^9, 3.764147637111184*^9}, {
   3.764147746686602*^9, 3.7641477485639563`*^9}, {3.764147796450858*^9, 
   3.764147796737598*^9}, {3.764147858441585*^9, 3.764147864503477*^9}, {
   3.764148319373646*^9, 3.7641483207322474`*^9}, 3.76414835806892*^9, {
   3.764148396943513*^9, 3.764148417204763*^9}, {3.764148448151367*^9, 
   3.7641484763614273`*^9}, {3.764148537645647*^9, 3.764148540293462*^9}, {
   3.764148579610086*^9, 3.764148621951552*^9}, {3.7641486969242153`*^9, 
   3.764148713762329*^9}, {3.764148744409203*^9, 3.764148797715672*^9}, {
   3.764148829739746*^9, 3.764148838643195*^9}, 3.764148966589192*^9, {
   3.764149010815742*^9, 3.7641490203130827`*^9}, {3.76414912535828*^9, 
   3.764149129588293*^9}, {3.764149165000304*^9, 3.764149165294808*^9}, {
   3.7641492121970243`*^9, 3.764149223162587*^9}, {3.764149410786007*^9, 
   3.764149419312743*^9}, 3.764149517490199*^9, {3.764149755492734*^9, 
   3.764149756402047*^9}, {3.764149787977314*^9, 3.764149888193684*^9}, {
   3.764149932804056*^9, 3.764149970698039*^9}, {3.764150061495829*^9, 
   3.764150208987054*^9}, {3.764150344696992*^9, 3.7641503606784887`*^9}, {
   3.7641504745042467`*^9, 3.764150488846759*^9}, {3.764150561530469*^9, 
   3.7641505984694033`*^9}, {3.764150680687262*^9, 3.7641507421258993`*^9}, {
   3.764150810437318*^9, 3.764150841329731*^9}, {3.764150891058955*^9, 
   3.7641509219630013`*^9}, {3.764150962161771*^9, 3.764150962511406*^9}, {
   3.7641513165988817`*^9, 3.764151364262121*^9}, {3.7641514759108143`*^9, 
   3.764151581384091*^9}, {3.764151613090066*^9, 3.76415164155093*^9}, {
   3.764152120308778*^9, 3.7641521385664377`*^9}, {3.764156604597185*^9, 
   3.764156604887895*^9}, {3.7641572093340807`*^9, 3.7641572424201813`*^9}, {
   3.7641573538155403`*^9, 3.764157359365707*^9}, {3.764157864922586*^9, 
   3.7641579443685837`*^9}, {3.7641599978926992`*^9, 3.764159999716358*^9}, {
   3.764163500633354*^9, 3.764163504426825*^9}, {3.764164915825512*^9, 
   3.764164934757737*^9}, {3.764165878819797*^9, 3.764165898821135*^9}, {
   3.764166313767913*^9, 3.764166353391108*^9}, {3.764166398632619*^9, 
   3.7641664052224073`*^9}, {3.764166969077342*^9, 3.7641669734031773`*^9}, {
   3.7641674402802687`*^9, 3.764167453471155*^9}, {3.764168408456244*^9, 
   3.764168447760468*^9}, {3.7641726885119658`*^9, 3.764172698061112*^9}, {
   3.7641727360472403`*^9, 3.7641727392762957`*^9}, {3.764172788293005*^9, 
   3.764172788947547*^9}, {3.764172842715355*^9, 3.7641728687675962`*^9}, 
   3.764172994430129*^9, {3.764173151522064*^9, 3.7641731599338417`*^9}, {
   3.7641733869224577`*^9, 3.7641733915359917`*^9}, {3.764173569331691*^9, 
   3.764173785188097*^9}, {3.764173815320829*^9, 3.76417381628846*^9}, 
   3.7641738534188757`*^9, {3.764174017581306*^9, 3.764174030192864*^9}, {
   3.764176511613493*^9, 3.7641765303529367`*^9}, {3.7641832805105133`*^9, 
   3.764183287196966*^9}, {3.764304895325467*^9, 3.764304910150828*^9}, {
   3.764304952733588*^9, 3.764304955900756*^9}, {3.764305176339394*^9, 
   3.7643052283878803`*^9}, {3.7643052857245913`*^9, 3.764305319841136*^9}, {
   3.764306306582027*^9, 3.7643063117611437`*^9}, {3.7643135839388*^9, 
   3.764313638914571*^9}, {3.7643136890792503`*^9, 3.764313717066792*^9}, {
   3.7643258345645514`*^9, 3.7643258364984713`*^9}, {3.764860946715392*^9, 
   3.7648609492557287`*^9}, {3.765118053943408*^9, 3.7651180834287853`*^9}, 
   3.777553675819727*^9},
 CellLabel->"In[28]:=",ExpressionUUID->"bfc8a7fd-7475-4ed1-a399-f8f9e1d8a0d6"],

Cell[BoxData[
 RowBox[{"VerbatimRegion", "[", "\[IndentingNewLine]", "\[IndentingNewLine]", 
  
  RowBox[{
   RowBox[{"ClearAll", "[", "CompileTripleIntegralMetric", "]"}], ";", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"CompileTripleIntegralMetric", "::", "usage"}], "=", "\"\<\>\""}],
    ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"SetAttributes", "[", 
    RowBox[{"CompileTripleIntegralMetric", ",", "HoldRest"}], "]"}], ";", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"CompileTripleIntegralMetric", "[", 
     RowBox[{
     "name0_", ",", "arglist_", ",", "f_", ",", "derargs0_", ",", "dim_", ",",
       "d_", ",", "\[IndentingNewLine]", 
      RowBox[{"OptionsPattern", "[", 
       RowBox[{"{", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"\"\<CompilationTarget\>\"", "\[Rule]", "\"\<C\>\""}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"\"\<Parallelization\>\"", "\[Rule]", "True"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"\"\<RuntimeAttributes\>\"", "\[Rule]", "Listable"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"\"\<RuntimeOptions\>\"", "\[Rule]", "\"\<Speed\>\""}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"\"\<CompilationOptions\>\"", "\[Rule]", 
          RowBox[{"{", "}"}]}], ",", "\[IndentingNewLine]", 
         RowBox[{"\"\<PrintCode\>\"", "\[Rule]", "False"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"\"\<ExportPseudoCode\>\"", "\[Rule]", "False"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"\"\<OptimizationLevel\>\"", "\[Rule]", "1"}]}], 
        "\[IndentingNewLine]", "}"}], "]"}]}], "]"}], ":=", 
    "\[IndentingNewLine]", 
    RowBox[{"Block", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "UU", ",", "U", ",", "VV", ",", "V", ",", "WW", ",", "W", ",", 
        "derargs", ",", "dims", ",", "S", ",", "s", ",", "rule", ",", "r", 
        ",", "xx", ",", "x", ",", "\[Omega]", ",", "i", ",", "h", ",", 
        "\[IndentingNewLine]", "matrix", ",", "Dmatrix", ",", "matrix0", ",", 
        "scalarQ", ",", "tic", ",", "toc", ",", "name"}], 
       "\[IndentingNewLine]", "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"h", "=", 
        RowBox[{"2.", "^", 
         RowBox[{"-", "20"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"name", "=", 
        RowBox[{"name0", "<>", "\"\<Metric\>\"", "<>", 
         RowBox[{"ToString", "[", "dim", "]"}], "<>", "\"\<D\>\"", "<>", 
         RowBox[{"ToString", "[", "d", "]"}], "<>", "\"\<D\>\""}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"PrintTemporary", "[", 
        RowBox[{
        "\"\<Preparing code for \>\"", "<>", "name", "<>", "\"\<...\>\""}], 
        "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"tic", "=", 
        RowBox[{"AbsoluteTime", "[", "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"xx", "=", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{"Compile`GetElement", "[", 
           RowBox[{"x", ",", "i", ",", "j"}], "]"}], ",", 
          RowBox[{"{", 
           RowBox[{"j", ",", "1", ",", 
            RowBox[{"3", " ", "dim"}]}], "}"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"matrix", "=", 
        RowBox[{
         RowBox[{"3", "!"}], 
         RowBox[{"f", "[", "xx", "]"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"rule", "=", 
        RowBox[{"Part", "\[Rule]", "Compile`GetElement"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"derargs", "=", 
        RowBox[{"Flatten", "[", 
         RowBox[{"derargs0", "/.", "rule"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"r", "=", 
        RowBox[{"ArrayDepth", "[", "derargs", "]"}]}], ";", 
       RowBox[{"UU", "=", "derargs"}], ";", 
       RowBox[{
        RowBox[{"UU", "\[LeftDoubleBracket]", 
         RowBox[{
          RowBox[{"Sequence", "@@", 
           RowBox[{"ConstantArray", "[", 
            RowBox[{"All", ",", "r"}], "]"}]}], ",", "1"}], 
         "\[RightDoubleBracket]"}], "=", "U"}], ";", 
       RowBox[{"VV", "=", "derargs"}], ";", 
       RowBox[{
        RowBox[{"VV", "\[LeftDoubleBracket]", 
         RowBox[{
          RowBox[{"Sequence", "@@", 
           RowBox[{"ConstantArray", "[", 
            RowBox[{"All", ",", "r"}], "]"}]}], ",", "1"}], 
         "\[RightDoubleBracket]"}], "=", "V"}], ";", "\[IndentingNewLine]", 
       RowBox[{"WW", "=", "derargs"}], ";", 
       RowBox[{
        RowBox[{"WW", "\[LeftDoubleBracket]", 
         RowBox[{
          RowBox[{"Sequence", "@@", 
           RowBox[{"ConstantArray", "[", 
            RowBox[{"All", ",", "r"}], "]"}]}], ",", "1"}], 
         "\[RightDoubleBracket]"}], "=", "W"}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"matrix0", "=", 
        RowBox[{"SparseArray", "@", 
         RowBox[{"matrix", "\[LeftDoubleBracket]", 
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"Range", "[", 
              RowBox[{"0", ",", 
               RowBox[{
                RowBox[{"3", 
                 RowBox[{"(", 
                  RowBox[{"dim", "+", "1"}], ")"}]}], "-", "1"}]}], "]"}], 
             "d"}], "+", "1"}], ",", 
           RowBox[{
            RowBox[{
             RowBox[{"Range", "[", 
              RowBox[{"0", ",", 
               RowBox[{
                RowBox[{"3", 
                 RowBox[{"(", 
                  RowBox[{"dim", "+", "1"}], ")"}]}], "-", "1"}]}], "]"}], 
             "d"}], "+", "1"}]}], "\[RightDoubleBracket]"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"scalarQ", "=", 
        RowBox[{
         RowBox[{
          RowBox[{"KroneckerProduct", "[", 
           RowBox[{"matrix0", ",", 
            RowBox[{"IdentityMatrix", "[", "d", "]"}]}], "]"}], "[", 
          "\"\<NonzeroPositions\>\"", "]"}], "\[Equal]", 
         RowBox[{
          RowBox[{"SparseArray", "[", "matrix", "]"}], "[", 
          "\"\<NonzeroPositions\>\"", "]"}]}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"Dmatrix", "=", 
        RowBox[{"D", "[", 
         RowBox[{"matrix", ",", 
          RowBox[{"{", 
           RowBox[{"derargs", ",", "1"}], "}"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"With", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"opts", "=", 
           RowBox[{"Sequence", "[", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"CompilationTarget", "\[Rule]", 
              RowBox[{"OptionValue", "[", "CompilationTarget", "]"}]}], ",", 
             "\[IndentingNewLine]", 
             RowBox[{"RuntimeAttributes", "\[Rule]", 
              RowBox[{"OptionValue", "[", "RuntimeAttributes", "]"}]}], ",", 
             "\[IndentingNewLine]", 
             RowBox[{"Parallelization", "\[Rule]", 
              RowBox[{"OptionValue", "[", "Parallelization", "]"}]}], ",", 
             "\[IndentingNewLine]", 
             RowBox[{"RuntimeOptions", "\[Rule]", 
              RowBox[{"OptionValue", "[", "RuntimeOptions", "]"}]}], ",", 
             "\[IndentingNewLine]", 
             RowBox[{"\"\<ExportPseudoCode\>\"", "\[Rule]", 
              RowBox[{
              "OptionValue", "[", "\"\<ExportPseudoCode\>\"", "]"}]}]}], 
            "\[IndentingNewLine]", "]"}]}], "}"}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"s", "=", 
           RowBox[{"\"\<get\>\"", "<>", "name"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"Print", "[", "s", "]"}], ";", "\[IndentingNewLine]", 
          RowBox[{"ClearAll", "/@", 
           RowBox[{"{", "s", "}"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"S", "=", 
           RowBox[{"Symbol", "[", "s", "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{"scalarQ", ",", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"With", "[", 
              RowBox[{
               RowBox[{"{", "\[IndentingNewLine]", 
                RowBox[{
                 RowBox[{"code2", "=", 
                  RowBox[{"N", "[", 
                   RowBox[{"Normal", "[", "matrix0", "]"}], "]"}]}], ",", 
                 "\[IndentingNewLine]", 
                 RowBox[{"args", "=", 
                  RowBox[{"Join", "[", 
                   RowBox[{"arglist", ",", 
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"{", 
                    RowBox[{"x", ",", "_Real", ",", "2"}], "}"}], ",", 
                    RowBox[{"{", 
                    RowBox[{"\[Omega]", ",", "_Real", ",", "1"}], "}"}]}], 
                    "}"}]}], "]"}]}]}], "\[IndentingNewLine]", "}"}], ",", 
               "\[IndentingNewLine]", 
               RowBox[{"SetCPackageFunction", "[", 
                RowBox[{"S", ",", "args", ",", "\[IndentingNewLine]", 
                 RowBox[{"\[Omega]", ".", 
                  RowBox[{"Table", "[", 
                   RowBox[{"code2", ",", 
                    RowBox[{"{", 
                    RowBox[{"i", ",", "1", ",", 
                    RowBox[{"Length", "[", "x", "]"}]}], "}"}]}], "]"}]}], 
                 ",", "\[IndentingNewLine]", "opts"}], "\[IndentingNewLine]", 
                "]"}]}], "\[IndentingNewLine]", "]"}], ";"}], 
            "\[IndentingNewLine]", ",", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"With", "[", 
              RowBox[{
               RowBox[{"{", "\[IndentingNewLine]", 
                RowBox[{
                 RowBox[{"code2", "=", " ", 
                  RowBox[{"N", "[", 
                   RowBox[{"Normal", "[", "matrix", "]"}], "]"}]}], ",", 
                 "\[IndentingNewLine]", 
                 RowBox[{"args", "=", 
                  RowBox[{"Join", "[", 
                   RowBox[{"arglist", ",", 
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"{", 
                    RowBox[{"x", ",", "_Real", ",", "2"}], "}"}], ",", 
                    RowBox[{"{", 
                    RowBox[{"\[Omega]", ",", "_Real", ",", "1"}], "}"}]}], 
                    "}"}]}], "]"}]}]}], "\[IndentingNewLine]", "}"}], ",", 
               "\[IndentingNewLine]", 
               RowBox[{"SetCPackageFunction", "[", 
                RowBox[{"S", ",", "args", ",", "\[IndentingNewLine]", 
                 RowBox[{"\[Omega]", ".", 
                  RowBox[{"Table", "[", 
                   RowBox[{"code2", ",", 
                    RowBox[{"{", 
                    RowBox[{"i", ",", "1", ",", 
                    RowBox[{"Length", "[", "x", "]"}]}], "}"}]}], "]"}]}], 
                 ",", "\[IndentingNewLine]", "opts"}], "\[IndentingNewLine]", 
                "]"}]}], "\[IndentingNewLine]", "]"}], ";"}]}], 
           "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
          "\[IndentingNewLine]", 
          RowBox[{"s", "=", 
           RowBox[{"\"\<getD\>\"", "<>", "name", "<>", "\"\<23\>\""}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"Print", "[", "s", "]"}], ";", "\[IndentingNewLine]", 
          RowBox[{"ClearAll", "/@", 
           RowBox[{"{", "s", "}"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"With", "[", 
           RowBox[{
            RowBox[{"{", "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"code", "=", " ", 
               RowBox[{"N", "[", 
                RowBox[{
                 RowBox[{"Im", "[", 
                  RowBox[{
                   RowBox[{"Normal", "[", "matrix0", "]"}], "/.", 
                   RowBox[{"Thread", "[", 
                    RowBox[{
                    RowBox[{"Flatten", "[", "derargs", "]"}], "\[Rule]", 
                    RowBox[{"Flatten", "[", 
                    RowBox[{"derargs", "+", 
                    RowBox[{"I", " ", "h", " ", "VV"}]}], "]"}]}], "]"}]}], 
                  "]"}], "/", "h"}], "]"}]}], ",", "\[IndentingNewLine]", 
              RowBox[{"(*", 
               RowBox[{
                RowBox[{"code", "=", " ", 
                 RowBox[{"N", "[", 
                  RowBox[{
                   RowBox[{"Flatten", "[", "UU", "]"}], ".", 
                   RowBox[{"(", 
                    RowBox[{"Dmatrix", ".", 
                    RowBox[{"Flatten", "[", "VV", "]"}]}], ")"}]}], "]"}]}], 
                ","}], "*)"}], "\[IndentingNewLine]", 
              RowBox[{"args", "=", 
               RowBox[{"Join", "[", 
                RowBox[{"arglist", ",", 
                 RowBox[{"{", 
                  RowBox[{
                   RowBox[{"{", 
                    RowBox[{"x", ",", "_Real", ",", "2"}], "}"}], ",", 
                   RowBox[{"{", 
                    RowBox[{"\[Omega]", ",", "_Real", ",", "1"}], "}"}], ",", 
                   
                   RowBox[{"{", 
                    RowBox[{"U", ",", "_Real", ",", "2"}], "}"}], ",", 
                   RowBox[{"{", 
                    RowBox[{"V", ",", "_Real", ",", "2"}], "}"}]}], "}"}]}], 
                "]"}]}]}], "\[IndentingNewLine]", "}"}], ",", 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"SetCPackageFunction", "[", 
              RowBox[{
               RowBox[{"Symbol", "[", "s", "]"}], ",", "args", ",", 
               "\[IndentingNewLine]", 
               RowBox[{"Flatten", "[", 
                RowBox[{
                 RowBox[{"(", 
                  RowBox[{"\[Omega]", ".", 
                   RowBox[{"Table", "[", 
                    RowBox[{"code", ",", 
                    RowBox[{"{", 
                    RowBox[{"i", ",", "1", ",", 
                    RowBox[{"Length", "[", "x", "]"}]}], "}"}]}], "]"}]}], 
                  ")"}], ".", "U"}], "]"}], ",", "\[IndentingNewLine]", 
               "opts"}], "\[IndentingNewLine]", "]"}], ";"}]}], 
           "\[IndentingNewLine]", "]"}], ";"}]}], "\[IndentingNewLine]", 
        "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"toc", "=", 
        RowBox[{"AbsoluteTime", "[", "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"Print", "[", 
        RowBox[{
         RowBox[{
         "\"\<Code preparation for \>\"", "<>", "name", "<>", 
          "\"\< completed. Time elapsed: \>\""}], ",", 
         RowBox[{"toc", "-", "tic"}], ",", "\"\< s.\>\""}], "]"}], ";"}]}], 
     "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", "\[IndentingNewLine]", "]"}]], "Input",
 CellChangeTimes->{{3.7641573402923813`*^9, 3.764157345167528*^9}, {
   3.764157952423689*^9, 3.764157954942569*^9}, {3.764159409983902*^9, 
   3.7641594283183537`*^9}, {3.7641599896474123`*^9, 3.764159992223135*^9}, {
   3.764166530674622*^9, 3.764166614009687*^9}, {3.764173939098946*^9, 
   3.764173993724655*^9}, {3.764174494100216*^9, 3.764174494467182*^9}, {
   3.764174544279022*^9, 3.764174555494102*^9}, {3.7641749563243723`*^9, 
   3.7641749674025927`*^9}, 3.764175015462605*^9, {3.764175095348694*^9, 
   3.764175184248507*^9}, {3.7641760797472258`*^9, 3.764176097381002*^9}, {
   3.7643129337693996`*^9, 3.764312936483609*^9}, 3.764313722283448*^9, {
   3.7643138857190113`*^9, 3.764313887502307*^9}, {3.7643141946348753`*^9, 
   3.7643142029126873`*^9}, {3.7648537180981083`*^9, 
   3.7648537228905487`*^9}, {3.7648542176608057`*^9, 3.764854220385414*^9}, {
   3.764854298046619*^9, 3.76485433763586*^9}, {3.764854439434617*^9, 
   3.7648544540702257`*^9}, {3.7648545403542337`*^9, 
   3.7648545565037003`*^9}, {3.76485477184309*^9, 3.7648547767981443`*^9}, 
   3.764854832740232*^9, {3.76485525911771*^9, 3.764855263596542*^9}, {
   3.7648610024198017`*^9, 3.764861003408266*^9}, {3.765118055127792*^9, 
   3.765118055720189*^9}, {3.765118354012011*^9, 3.765118358555534*^9}, {
   3.765119869305339*^9, 3.765119878119358*^9}, {3.765119909487359*^9, 
   3.765119911165942*^9}},
 CellLabel->"In[37]:=",ExpressionUUID->"f778253d-2b93-4468-b361-932b308feb98"],

Cell[BoxData[
 RowBox[{"\[IndentingNewLine]", "\[IndentingNewLine]"}]], "Input",
 CellChangeTimes->{{3.764159957999332*^9, 3.764159958139317*^9}},
 CellLabel->"In[37]:=",ExpressionUUID->"4fad4855-a249-4c2d-b401-c35c5a7e8abf"],

Cell[BoxData[
 RowBox[{"VerbatimRegion", "[", "\[IndentingNewLine]", "\[IndentingNewLine]", 
  
  RowBox[{
   RowBox[{"ClearAll", "[", "CreateTripleIntegralMetric", "]"}], ";", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"CreateTripleIntegralMetric", "::", "usage"}], "=", "\"\<\>\""}], 
   ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"SetAttributes", "[", 
    RowBox[{"CreateTripleIntegralMetric", ",", "HoldRest"}], "]"}], ";", 
   RowBox[{
    RowBox[{"CreateTripleIntegralMetric", "[", 
     RowBox[{
     "name0_", ",", "type0_", ",", "tuplefun0_", ",", "funlist0_", ",", 
      "\[IndentingNewLine]", 
      RowBox[{"OptionsPattern", "[", 
       RowBox[{"{", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"\"\<DefaultQuadraturePoints\>\"", "\[Rule]", 
          RowBox[{"With", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"subd", "=", "3"}], "}"}], ",", "\[IndentingNewLine]", 
            RowBox[{"Tuples", "[", 
             RowBox[{
              RowBox[{"MovingAverage", "[", 
               RowBox[{
                RowBox[{"Subdivide", "[", 
                 RowBox[{"0.", ",", "1.", ",", "subd"}], "]"}], ",", "2"}], 
               "]"}], ",", "3"}], "]"}]}], "\[IndentingNewLine]", "]"}]}], 
         ",", "\[IndentingNewLine]", 
         RowBox[{"\"\<DefaultQuadratureWeights\>\"", "\[Rule]", 
          RowBox[{"With", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"subd", "=", "3"}], "}"}], ",", "\[IndentingNewLine]", 
            RowBox[{"Flatten", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"KroneckerProduct", "[", 
                RowBox[{"#", ",", "#", ",", "#"}], "]"}], "&"}], "[", 
              RowBox[{"ConstantArray", "[", 
               RowBox[{
                RowBox[{"1.", "/", "subd"}], ",", "subd"}], "]"}], "]"}], 
             "]"}]}], "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]",
         "}"}], "]"}]}], "]"}], ":=", "\[IndentingNewLine]", 
    RowBox[{"Block", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"M", ",", "name"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"name", "=", 
        RowBox[{"name0", "<>", "\"\<Metric\>\""}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"With", "[", 
        RowBox[{
         RowBox[{"{", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"FQuadraturePoints", "=", 
            RowBox[{"Symbol", "[", 
             RowBox[{"name0", "<>", "\"\<QuadraturePoints\>\""}], "]"}]}], 
           ",", "\[IndentingNewLine]", 
           RowBox[{"FQuadratureWeights", "=", 
            RowBox[{"Symbol", "[", 
             RowBox[{"name0", "<>", "\"\<QuadratureWeights\>\""}], "]"}]}]}], 
          "\[IndentingNewLine]", "}"}], ",", "\[IndentingNewLine]", 
         RowBox[{"With", "[", 
          RowBox[{
           RowBox[{"{", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"F", "=", 
              RowBox[{"Symbol", "[", "name", "]"}]}], ",", 
             "\[IndentingNewLine]", 
             RowBox[{"type", "=", "type0"}], ",", "\[IndentingNewLine]", 
             RowBox[{"tuplefun", "=", "tuplefun0"}], ",", 
             "\[IndentingNewLine]", 
             RowBox[{"funlist", "=", 
              RowBox[{"Join", "[", 
               RowBox[{
                RowBox[{"Flatten", "[", 
                 RowBox[{"{", "funlist0", "}"}], "]"}], ",", 
                RowBox[{"{", 
                 RowBox[{"FQuadraturePoints", ",", "FQuadratureWeights"}], 
                 "}"}]}], "]"}]}], ",", "\[IndentingNewLine]", 
             RowBox[{"dim", "=", 
              RowBox[{"IntrinsicDimension", "[", "type0", "]"}]}], ",", 
             "\[IndentingNewLine]", 
             RowBox[{"cfname", "=", 
              RowBox[{"name", "<>", 
               RowBox[{"IntegerString", "[", 
                RowBox[{"IntrinsicDimension", "[", "type0", "]"}], "]"}], 
               "<>", "\"\<D\>\""}]}], ",", "\[IndentingNewLine]", 
             "\[IndentingNewLine]", 
             RowBox[{"x", "=", 
              RowBox[{"ToPack", "[", 
               RowBox[{"N", "[", 
                RowBox[{
                "OptionValue", "[", "\"\<DefaultQuadraturePoints\>\"", "]"}], 
                "]"}], "]"}]}], ",", "\[IndentingNewLine]", 
             RowBox[{"\[Omega]", "=", 
              RowBox[{"ToPack", "[", 
               RowBox[{"N", "[", 
                RowBox[{
                "OptionValue", "[", "\"\<DefaultQuadratureWeights\>\"", "]"}],
                 "]"}], "]"}]}]}], "\[IndentingNewLine]", "}"}], ",", 
           "\[IndentingNewLine]", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"FQuadraturePoints", "=", 
             RowBox[{"SettingFunction", "[", 
              RowBox[{
               RowBox[{"Pattern", "[", 
                RowBox[{"M", ",", 
                 RowBox[{"Blank", "[", "type", "]"}]}], "]"}], ",", "x"}], 
              "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
            RowBox[{"FQuadratureWeights", "=", 
             RowBox[{"SettingFunction", "[", 
              RowBox[{
               RowBox[{"Pattern", "[", 
                RowBox[{"M", ",", 
                 RowBox[{"Blank", "[", "type", "]"}]}], "]"}], ",", 
               "\[Omega]"}], "]"}]}], ";", "\[IndentingNewLine]", 
            "\[IndentingNewLine]", 
            RowBox[{"F", "=", 
             RowBox[{"PackageFunction", "[", 
              RowBox[{
               RowBox[{"Pattern", "[", 
                RowBox[{"M", ",", 
                 RowBox[{"Blank", "[", "type", "]"}]}], "]"}], ",", 
               "\[IndentingNewLine]", 
               RowBox[{"Module", "[", 
                RowBox[{
                 RowBox[{"{", 
                  RowBox[{"a", ",", "d", ",", "cf", ",", "vals"}], "}"}], ",",
                  "\[IndentingNewLine]", 
                 RowBox[{
                  RowBox[{"d", "=", 
                   RowBox[{"EmbeddingDimension", "[", "M", "]"}]}], ";", 
                  "\[IndentingNewLine]", 
                  RowBox[{"cf", "=", 
                   RowBox[{"Symbol", "[", 
                    RowBox[{"\"\<get\>\"", "<>", "cfname", "<>", 
                    RowBox[{"ToString", "[", "d", "]"}], "<>", "\"\<D\>\""}], 
                    "]"}]}], ";", "\[IndentingNewLine]", 
                  RowBox[{"vals", "=", 
                   RowBox[{"cf", "[", 
                    RowBox[{"Sequence", "@@", 
                    RowBox[{"Through", "[", 
                    RowBox[{"funlist", "[", "M", "]"}], "]"}]}], "]"}]}], ";",
                   "\[IndentingNewLine]", 
                  RowBox[{"a", "=", 
                   RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{
                    RowBox[{
                    RowBox[{"Dimensions", "[", "vals", "]"}], 
                    "\[LeftDoubleBracket]", 
                    RowBox[{"-", "1"}], "\[RightDoubleBracket]"}], "\[Equal]", 
                    RowBox[{"3", 
                    RowBox[{"(", 
                    RowBox[{"dim", "+", "1"}], ")"}]}]}], ",", 
                    "\[IndentingNewLine]", 
                    RowBox[{
                    "IsotropicTripleIntegralMetricCombinatorics", "[", "M", 
                    "]"}], ",", "\[IndentingNewLine]", 
                    RowBox[{
                    "AnisotropicTripleIntegralMetricCombinatorics", "[", "M", 
                    "]"}]}], "\[IndentingNewLine]", "]"}]}], ";", 
                  "\[IndentingNewLine]", 
                  RowBox[{"Normal", "[", 
                   RowBox[{"a", "[", 
                    RowBox[{"Flatten", "[", "vals", "]"}], "]"}], "]"}]}]}], 
                "\[IndentingNewLine]", "]"}], ",", "\[IndentingNewLine]", 
               RowBox[{"Caching", "\[Rule]", "True"}]}], 
              "\[IndentingNewLine]", "]"}]}], ";", "\[IndentingNewLine]", 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{
              RowBox[{"Derivative", "[", "1", "]"}], "[", "F", "]"}], "=", 
             RowBox[{"PackageFunction", "[", 
              RowBox[{
               RowBox[{"{", 
                RowBox[{
                 RowBox[{"Pattern", "[", 
                  RowBox[{"M", ",", 
                   RowBox[{"Blank", "[", "type", "]"}]}], "]"}], ",", 
                 "ulist_List", ",", "slotlist_List"}], "}"}], ",", 
               RowBox[{"Module", "[", 
                RowBox[{
                 RowBox[{"{", 
                  RowBox[{
                  "a", ",", "fun", ",", "funname", ",", "udistlist", ",", 
                   "data", ",", "d"}], "}"}], ",", "\[IndentingNewLine]", 
                 RowBox[{
                  RowBox[{"d", "=", 
                   RowBox[{"EmbeddingDimension", "[", "M", "]"}]}], ";", 
                  "\[IndentingNewLine]", 
                  RowBox[{"funname", "=", 
                   RowBox[{"\"\<getD\>\"", "<>", "cfname", "<>", 
                    RowBox[{"IntegerString", "[", "d", "]"}], "<>", 
                    "\"\<D\>\"", "<>", 
                    RowBox[{"IntegerString", "/@", 
                    RowBox[{"Sort", "[", "slotlist", "]"}]}]}]}], ";", 
                  "\[IndentingNewLine]", 
                  RowBox[{"fun", "=", 
                   RowBox[{"Symbol", "[", "funname", "]"}]}], ";", 
                  "\[IndentingNewLine]", 
                  RowBox[{"data", "=", 
                   RowBox[{"fun", "[", "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"Sequence", "@@", 
                    RowBox[{"Through", "[", 
                    RowBox[{"funlist", "[", "M", "]"}], "]"}]}], ",", 
                    "\[IndentingNewLine]", 
                    RowBox[{"Sequence", "@@", 
                    RowBox[{"Table", "[", 
                    RowBox[{
                    RowBox[{"DistributeVector", "[", 
                    RowBox[{"M", ",", "tuplefun", ",", 
                    RowBox[{
                    "ulist", "\[LeftDoubleBracket]", "i", 
                    "\[RightDoubleBracket]"}]}], "]"}], ",", 
                    RowBox[{"{", 
                    RowBox[{"i", ",", 
                    RowBox[{"Ordering", "[", "slotlist", "]"}]}], "}"}]}], 
                    "]"}]}]}], "\[IndentingNewLine]", "]"}]}], ";", 
                  "\[IndentingNewLine]", 
                  RowBox[{"If", "[", 
                   RowBox[{
                    RowBox[{
                    RowBox[{"Length", "[", "slotlist", "]"}], "\[Equal]", 
                    "3"}], ",", 
                    RowBox[{"(*", "Then", "*)"}], "\[IndentingNewLine]", 
                    RowBox[{"Total", "[", "data", "]"}], ",", 
                    RowBox[{"(*", "Else", "*)"}], "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"a", "=", 
                    RowBox[{"AssemblyCombinatorics", "[", 
                    RowBox[{"M", ",", "tuplefun", ",", 
                    RowBox[{"3", "-", 
                    RowBox[{"Length", "[", "slotlist", "]"}]}], ",", 
                    "\"\<Global\>\"", ",", "1"}], "]"}]}], ";", 
                    "\[IndentingNewLine]", 
                    RowBox[{"a", "[", "data", "]"}]}]}], 
                   "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", 
                "]"}]}], "\[IndentingNewLine]", "]"}]}]}]}], 
          "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", "]"}]}]}], 
     "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", "\[IndentingNewLine]", "]"}]], "Input",
 CellChangeTimes->{{3.7641599594014893`*^9, 3.7641599818300123`*^9}, 
   3.764160349396185*^9, {3.7641604399047728`*^9, 3.764160478414679*^9}, {
   3.764160512668787*^9, 3.764160649162375*^9}, {3.764160690467342*^9, 
   3.764160694025249*^9}, {3.7641633210908203`*^9, 3.7641633245461273`*^9}, {
   3.7641642636651382`*^9, 3.764164267846447*^9}, {3.7641753113861322`*^9, 
   3.764175314319193*^9}, {3.7641756957276793`*^9, 3.764175710949102*^9}, {
   3.764175810368067*^9, 3.764175818803685*^9}, {3.764175890897746*^9, 
   3.7641758969425097`*^9}, 3.764176025913423*^9, {3.7641762167938833`*^9, 
   3.764176232078862*^9}, {3.764176652757728*^9, 3.76417666103531*^9}, {
   3.764312415872024*^9, 3.764312616619813*^9}, {3.764312701828128*^9, 
   3.764312731658514*^9}, {3.764312845185986*^9, 3.764312871720978*^9}, {
   3.76431335240932*^9, 3.764313353583034*^9}, 3.764313737058387*^9, {
   3.764313809563326*^9, 3.764313811943673*^9}, {3.764313877382711*^9, 
   3.76431387929979*^9}, {3.765118055914846*^9, 3.7651180569180202`*^9}, {
   3.765118369301343*^9, 3.765118375996477*^9}, {3.765119531461309*^9, 
   3.765119532402974*^9}, 3.7651196965832253`*^9, {3.765119819714748*^9, 
   3.765119819818015*^9}},
 CellLabel->"In[36]:=",ExpressionUUID->"cbb5382a-1908-43b5-bb67-4d5d6a618a29"]
},
WindowSize->{1440, 855},
WindowMargins->{{0, Automatic}, {Automatic, 0}},
FrontEndVersion->"12.0 for Mac OS X x86 (64-bit) (April 8, 2019)",
StyleDefinitions->"Default.nb"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[558, 20, 1866, 42, 367, "Input",ExpressionUUID->"d81fce63-a538-445f-9c06-9f7ec68169c7"],
Cell[2427, 64, 1643, 36, 367, "Input",ExpressionUUID->"96d35d7b-ce89-4cb6-a353-ebbd8ddb5e5d"],
Cell[4073, 102, 1640, 36, 367, "Input",ExpressionUUID->"946877d5-23c6-4500-8478-caa44c9d25fd"],
Cell[5716, 140, 2527, 56, 442, "Input",ExpressionUUID->"b035c983-38ad-4683-a1b0-ce38836ed81a"],
Cell[8246, 198, 2356, 54, 442, "Input",ExpressionUUID->"9e4f1343-282a-4390-9b0a-46f8738511aa"],
Cell[10605, 254, 24084, 493, 3017, "Input",ExpressionUUID->"bfc8a7fd-7475-4ed1-a399-f8f9e1d8a0d6"],
Cell[34692, 749, 15921, 342, 2367, "Input",ExpressionUUID->"f778253d-2b93-4468-b361-932b308feb98"],
Cell[50616, 1093, 225, 3, 92, "Input",ExpressionUUID->"4fad4855-a249-4c2d-b401-c35c5a7e8abf"],
Cell[50844, 1098, 12884, 266, 1842, "Input",ExpressionUUID->"cbb5382a-1908-43b5-bb67-4d5d6a618a29"]
}
]
*)

