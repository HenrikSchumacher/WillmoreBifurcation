(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 11.0' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       158,          7]
NotebookDataLength[     67488,       1471]
NotebookOptionsPosition[     65464,       1440]
NotebookOutlinePosition[     65800,       1455]
CellTagsIndexPosition[     65757,       1452]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{
Cell[BoxData[
 RowBox[{"VerbatimRegion", "[", "\[IndentingNewLine]", "\[IndentingNewLine]", 
  "]"}]], "Input",
 CellChangeTimes->{{3.797394832006378*^9, 
  3.797394835892338*^9}},ExpressionUUID->"999bd74a-04a3-4a8c-9a0b-\
f3fc22a8057c"],

Cell[BoxData[
 RowBox[{"(*", "\[IndentingNewLine]", 
  RowBox[{"TODO", "=", 
   RowBox[{"{", "\[IndentingNewLine]", 
    RowBox[{
    "\"\<Update Constraint, Constraint', and Constraint' to all work with \
ConstaintProcessingStorage and ConstaintProcessingLog. This makes things much \
more debuggable since one can inspect how they actually have been \
evaluated.\>\"", ",", "\[IndentingNewLine]", 
     "\"\<Switch for sparse/dense systems?\>\""}], "\[IndentingNewLine]", 
    "}"}]}], "*)"}]], "Input",
 CellChangeTimes->{
  3.7884228447398977`*^9, {3.788422906619956*^9, 3.7884229982077627`*^9}, {
   3.788423071628664*^9, 
   3.788423089963978*^9}},ExpressionUUID->"a4c6be2f-1799-478c-a78f-\
6a7530753a1a"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"ConstraintList", "=", 
   RowBox[{"SettingFunction", "[", 
    RowBox[{"M_genericmesh", ",", 
     RowBox[{"Association", "[", "]"}]}], "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{"AppendToConstraintList", "=", 
  RowBox[{"PackageFunction", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"M_genericmesh", ",", "fun_"}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "data", "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"data", "=", 
        RowBox[{"ConstraintList", "[", "M", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"ClearAllCacheDependingOn", "[", 
        RowBox[{"M", ",", "ConstraintList"}], "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"OptionValue", "[", "\"\<DesiredConstraint\>\"", "]"}], "===",
           "Automatic"}], ",", 
         RowBox[{"(*", "Then", "*)"}], "\[IndentingNewLine]", 
         RowBox[{"SetSettings", "[", 
          RowBox[{"M", ",", "\"\<ConstraintList\>\"", ",", 
           RowBox[{"Append", "[", 
            RowBox[{"data", ",", 
             RowBox[{"fun", "\[Rule]", " ", 
              RowBox[{"fun", "[", "M", "]"}]}]}], "]"}]}], "]"}], 
         "\[IndentingNewLine]", ",", 
         RowBox[{"(*", "Else", "*)"}], "\[IndentingNewLine]", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"OptionValue", "[", "\"\<DesiredConstraint\>\"", "]"}], 
            "===", "\"\<Zero\>\""}], ",", 
           RowBox[{"(*", "Then", "*)"}], "\[IndentingNewLine]", 
           RowBox[{"SetSettings", "[", 
            RowBox[{"M", ",", "\"\<ConstraintList\>\"", ",", 
             RowBox[{"Append", "[", 
              RowBox[{"data", ",", 
               RowBox[{"fun", "\[Rule]", 
                RowBox[{"0.", 
                 RowBox[{"fun", "[", "M", "]"}]}]}]}], "]"}]}], "]"}], 
           "\[IndentingNewLine]", ",", 
           RowBox[{"(*", "Else", "*)"}], "\[IndentingNewLine]", 
           RowBox[{"SetSettings", "[", 
            RowBox[{"M", ",", "\"\<ConstraintList\>\"", ",", 
             RowBox[{"Append", "[", 
              RowBox[{"data", ",", 
               RowBox[{"fun", "\[Rule]", " ", 
                RowBox[{
                "OptionValue", "[", "\"\<DesiredConstraint\>\"", "]"}]}]}], 
              "]"}]}], "]"}]}], "\[IndentingNewLine]", "]"}]}], 
        "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", "]"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"\"\<Options\>\"", "\[Rule]", 
     RowBox[{"{", 
      RowBox[{"\"\<DesiredConstraint\>\"", "\[Rule]", "Automatic"}], 
      "}"}]}]}], "\[IndentingNewLine]", "]"}]}]}], "Input",
 CellChangeTimes->{{3.6812002812306023`*^9, 3.6812002996132927`*^9}, {
   3.681200357092108*^9, 3.681200382821666*^9}, {3.6812005812943363`*^9, 
   3.681200631297662*^9}, {3.6812008964002647`*^9, 3.681200907520877*^9}, {
   3.6836110512071953`*^9, 3.683611120940061*^9}, {3.683613285703314*^9, 
   3.683613333950101*^9}, {3.683613427462246*^9, 3.6836134313719177`*^9}, {
   3.683613514234165*^9, 3.683613514425612*^9}, {3.683615545491458*^9, 
   3.6836156869892683`*^9}, {3.6836157673216763`*^9, 3.683615771984379*^9}, {
   3.6836159887265368`*^9, 3.6836159890138817`*^9}, {3.6836162015687933`*^9, 
   3.683616205847774*^9}, {3.683617756891182*^9, 3.683617759270804*^9}, {
   3.683617961272065*^9, 3.6836180076739388`*^9}, {3.6836180780123034`*^9, 
   3.6836180849659777`*^9}, {3.683618251637808*^9, 3.683618251880138*^9}, {
   3.6841446230642147`*^9, 3.684144623406025*^9}, {3.684747808629408*^9, 
   3.684747809973667*^9}, {3.689407390485532*^9, 3.6894073910134287`*^9}, 
   3.689411881925537*^9, {3.69304922268607*^9, 3.693049226604726*^9}, {
   3.7382469443760223`*^9, 3.738246954758442*^9}, {3.738260855913044*^9, 
   3.738260860949284*^9}, {3.757496550126973*^9, 3.757496565149391*^9}, {
   3.788422851327675*^9, 3.7884228643340197`*^9}, {3.79739488909864*^9, 
   3.797394893173465*^9}, {3.797395163394126*^9, 3.797395174537405*^9}},
 CellLabel->"In[20]:=",ExpressionUUID->"4f83fffc-5c64-4128-8035-1784bd4bbcd8"],

Cell[BoxData[
 RowBox[{"(*", 
  RowBox[{"ConstraintSpans", "=", 
   RowBox[{"PackageFunction", "[", 
    RowBox[{"M_", ",", "\[IndentingNewLine]", 
     RowBox[{"With", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"data", "=", 
         RowBox[{"FoldList", "[", 
          RowBox[{"Plus", ",", "1", ",", 
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"Length", "[", "G", "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"G", ",", 
               RowBox[{"ConstraintList", "[", "M", "]"}]}], "}"}]}], "]"}]}], 
          "]"}]}], "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{"AssociationThread", "[", 
        RowBox[{
         RowBox[{"Keys", "[", 
          RowBox[{"ConstraintList", "[", "M", "]"}], "]"}], ",", 
         RowBox[{"Span", "@@@", 
          RowBox[{"Transpose", "[", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"Most", "[", "data", "]"}], ",", 
             RowBox[{
              RowBox[{"Rest", "[", "data", "]"}], "-", "1"}]}], "}"}], 
           "]"}]}]}], "]"}]}], "\[IndentingNewLine]", "]"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{"InputType", "\[Rule]", "genericmesh"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{"Caching", "\[Rule]", "Persistent"}]}], "\[IndentingNewLine]", 
    "]"}]}], "*)"}]], "Input",
 CellChangeTimes->{{3.7132617868931303`*^9, 3.713261831637247*^9}, 
   3.71326188745196*^9, 3.713261933220067*^9, 
   3.714024936862048*^9},ExpressionUUID->"52e385cf-4d45-4fe5-86ec-\
eb9571bf155b"],

Cell[BoxData[
 RowBox[{"ConstraintLength", "=", 
  RowBox[{"PackageFunction", "[", 
   RowBox[{"M_genericmesh", ",", "\[IndentingNewLine]", 
    RowBox[{"Length", "[", 
     RowBox[{"Constraint", "[", "M", "]"}], "]"}], ",", "\[IndentingNewLine]", 
    RowBox[{"Caching", "\[Rule]", "Persistent"}]}], "\[IndentingNewLine]", 
   "]"}]}]], "Input",
 CellChangeTimes->{{3.7574969279382753`*^9, 3.757496928654812*^9}, {
  3.79739920859053*^9, 
  3.797399213340887*^9}},ExpressionUUID->"c5641da3-b359-4b6d-b61c-\
a8817acd398d"],

Cell[BoxData[
 RowBox[{"ConstraintSpans", "=", 
  RowBox[{"PackageFunction", "[", 
   RowBox[{"M_genericmesh", ",", "\[IndentingNewLine]", 
    RowBox[{"AssociationThread", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Keys", "[", 
       RowBox[{"ConstraintList", "[", "M", "]"}], "]"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"Module", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"a", ",", "b", ",", "c"}], "}"}], ",", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"c", "=", "1"}], ";", "\[IndentingNewLine]", 
         RowBox[{"b", "=", "0"}], ";", "\[IndentingNewLine]", 
         RowBox[{"Table", "[", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{
            RowBox[{"b", "+=", "d"}], ";", "\[IndentingNewLine]", 
            RowBox[{"a", "=", "c"}], ";", "\[IndentingNewLine]", 
            RowBox[{"c", "+=", "d"}], ";", "\[IndentingNewLine]", 
            RowBox[{"Span", "[", 
             RowBox[{"a", ",", "b"}], "]"}]}], "\[IndentingNewLine]", 
           RowBox[{"(*", 
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{"a", "\[LessEqual]", " ", "b"}], ",", 
              RowBox[{"Span", "[", 
               RowBox[{"a", ",", "b"}], "]"}], ",", 
              RowBox[{"{", "}"}]}], "]"}], "*)"}], "\[IndentingNewLine]", ",",
            "\[IndentingNewLine]", 
           RowBox[{"{", 
            RowBox[{"d", ",", 
             RowBox[{"Table", "[", 
              RowBox[{
               RowBox[{"Length", "[", 
                RowBox[{"Flatten", "[", 
                 RowBox[{"{", 
                  RowBox[{"G", "[", "M", "]"}], "}"}], "]"}], "]"}], ",", 
               RowBox[{"{", 
                RowBox[{"G", ",", 
                 RowBox[{"Keys", "[", 
                  RowBox[{"ConstraintList", "[", "M", "]"}], "]"}]}], "}"}]}],
               "]"}]}], "}"}]}], "]"}]}]}], "\[IndentingNewLine]", "]"}]}], 
     "\[IndentingNewLine]", "]"}], ",", "\[IndentingNewLine]", 
    RowBox[{"Caching", "\[Rule]", "Persistent"}]}], "\[IndentingNewLine]", 
   "]"}]}]], "Input",
 CellChangeTimes->{
  3.714024942407241*^9, {3.714025162112986*^9, 3.714025166301518*^9}, {
   3.714025314654708*^9, 3.714025334638097*^9}, {3.7140254051904488`*^9, 
   3.714025418980476*^9}, {3.714025469692379*^9, 3.714025473139072*^9}, {
   3.7382469569915953`*^9, 
   3.73824695900585*^9}},ExpressionUUID->"b9a4b187-a373-477a-b9a0-\
06d666801087"],

Cell[BoxData[
 RowBox[{"ReadUList", "=", 
  RowBox[{"PackageFunction", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"M_genericmesh", ",", "Ulist0_", ",", "slotlist_", ",", "G_"}], 
     "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{"With", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"spans", "=", 
        RowBox[{"ConstraintSpans", "[", "M", "]"}]}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"Table", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{
           RowBox[{
           "slotlist", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}],
            "\[Equal]", "1"}], ",", "\[IndentingNewLine]", 
          RowBox[{"Ulist0", "\[LeftDoubleBracket]", 
           RowBox[{"i", ",", 
            RowBox[{"spans", "[", "G", "]"}]}], "\[RightDoubleBracket]"}], 
          " ", ",", "\[IndentingNewLine]", 
          RowBox[{
          "Ulist0", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}]}], 
         "\[IndentingNewLine]", "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"i", ",", "1", ",", 
          RowBox[{"Length", "[", "Ulist0", "]"}]}], "}"}]}], "]"}]}], 
     "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", "]"}]}]], "Input",\

 CellChangeTimes->{{3.714025265512446*^9, 3.714025266669969*^9}, {
  3.738246960837862*^9, 
  3.738246963997057*^9}},ExpressionUUID->"b4250597-8685-4b8e-a7db-\
224800886ebe"],

Cell[BoxData[
 RowBox[{"ConstaintProcessingStorage", "=", 
  RowBox[{"PackageFunction", "[", 
   RowBox[{"M_genericmesh", ",", "\[IndentingNewLine]", 
    RowBox[{"Association", "[", "]"}], ",", "\[IndentingNewLine]", 
    RowBox[{"Caching", "\[Rule]", "Persistent"}]}], "\[IndentingNewLine]", 
   "]"}]}]], "Input",
 CellChangeTimes->{{3.788418127247262*^9, 3.788418162372457*^9}, {
   3.788418220747691*^9, 3.788418235641284*^9}, {3.7884210876502447`*^9, 
   3.7884210891674757`*^9}, 
   3.7884227900026283`*^9},ExpressionUUID->"af4c962f-4e98-458e-b53a-\
e458adfe6df8"],

Cell[BoxData[
 RowBox[{"ConstaintProcessingLog", "=", 
  RowBox[{"PackageFunction", "[", 
   RowBox[{"M_genericmesh", ",", "\[IndentingNewLine]", 
    RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{"Caching", "\[Rule]", "Persistent"}]}], "\[IndentingNewLine]", 
   "]"}]}]], "Input",
 CellChangeTimes->{{3.788421175252244*^9, 3.78842117596385*^9}, {
   3.788421533455933*^9, 3.788421533550639*^9}, 3.788422791056987*^9, {
   3.7973953027957373`*^9, 3.797395304324512*^9}},
 CellLabel->"",ExpressionUUID->"6edcebe0-31e1-4119-8896-e5c88d5c4aeb"],

Cell[BoxData[
 RowBox[{"DesiredConstraint", "=", 
  RowBox[{"PackageFunction", "[", 
   RowBox[{"M_genericmesh", ",", "\[IndentingNewLine]", 
    RowBox[{"ToPack", "@", 
     RowBox[{"Flatten", "@", 
      RowBox[{"Values", "[", 
       RowBox[{"ConstraintList", "[", "M", "]"}], "]"}]}]}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"Caching", "\[Rule]", "Persistent"}]}], "\[IndentingNewLine]", 
   "]"}]}]], "Input",
 CellChangeTimes->{
  3.681200909456295*^9, {3.683615743274066*^9, 3.683615749162717*^9}, 
   3.683618225109342*^9, 3.68940739159823*^9, {3.692959702549128*^9, 
   3.6929597033359957`*^9}, {3.738246965540979*^9, 3.7382469680364037`*^9}, 
   3.7574965949105883`*^9, {3.7574966617353067`*^9, 3.757496663256753*^9}, {
   3.75749689777874*^9, 3.757496907842785*^9}},
 CellLabel->"In[29]:=",ExpressionUUID->"fd5e9fa4-5da0-4fb7-a663-7a5fdd0367a9"],

Cell[BoxData[
 RowBox[{"Constraint", "=", 
  RowBox[{"PackageFunction", "[", 
   RowBox[{"M_genericmesh", ",", "\[IndentingNewLine]", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "g", "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"ToPack", "@", "Join"}], "@@", 
       RowBox[{"Table", "[", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{"g", "=", 
           RowBox[{"G", "[", "M", "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"TensorRank", "[", "g", "]"}], "\[Equal]", "0"}], ",", 
            RowBox[{"ToPack", "[", 
             RowBox[{"{", "g", "}"}], "]"}], ",", "g"}], "]"}]}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{"G", ",", 
           RowBox[{"Keys", "[", 
            RowBox[{"ConstraintList", "[", "M", "]"}], "]"}]}], "}"}]}], 
        "]"}]}]}], "\[IndentingNewLine]", "]"}], ",", "\[IndentingNewLine]", 
    RowBox[{"Caching", "\[Rule]", "True"}]}], "\[IndentingNewLine]", 
   "]"}]}]], "Input",
 CellChangeTimes->{
  3.6894073921803837`*^9, {3.738246970853394*^9, 3.738246972404187*^9}, 
   3.818757139974739*^9},ExpressionUUID->"e0a2e6bc-cc29-4bd6-ab8d-\
96b8bdff199d"],

Cell[BoxData[
 RowBox[{"(*", 
  RowBox[{"CreateConstraintMatrix", "=", 
   RowBox[{"PackageFunction", "[", 
    RowBox[{"M_genericmesh", ",", "\[IndentingNewLine]", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"flist", "=", 
         RowBox[{"MetricList", "[", "M", "]"}]}], "}"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            RowBox[{"Length", "[", "flist", "]"}], ">", "1"}], ")"}], "||", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"Abs", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"Values", "[", "flist", "]"}], "\[LeftDoubleBracket]", 
               "1", "\[RightDoubleBracket]"}], "-", "1."}], "]"}], ">", 
            "0."}], ")"}]}], "\[IndentingNewLine]", ",", 
         "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"Values", "[", "flist", "]"}], ".", 
          RowBox[{"Through", "[", 
           RowBox[{
            RowBox[{"Keys", "[", "flist", "]"}], "[", "M", "]"}], "]"}]}], 
         "\[IndentingNewLine]", ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            RowBox[{"Keys", "[", "flist", "]"}], "\[LeftDoubleBracket]", "1", 
            "\[RightDoubleBracket]"}], ")"}], "[", "M", "]"}]}], 
        "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", "]"}]}], 
    "\[IndentingNewLine]", "]"}]}], "*)"}]], "Input",
 CellChangeTimes->{{3.697429107166149*^9, 3.6974291340366983`*^9}, {
  3.697429176796241*^9, 3.697429278138104*^9}, {3.697429573985909*^9, 
  3.697429574272126*^9}, {3.749796573285014*^9, 3.749796574666182*^9}, {
  3.788891490068899*^9, 3.788891491094372*^9}, {3.7955291813162613`*^9, 
  3.795529197692163*^9}, {3.795529601999604*^9, 3.795529612957993*^9}, {
  3.79552975676828*^9, 3.795529770423114*^9}, {3.79738521681925*^9, 
  3.797385219985677*^9}, {3.7973861021947536`*^9, 3.7973861096568727`*^9}, {
  3.797399341880975*^9, 3.79739935183105*^9}, {3.8187579272721443`*^9, 
  3.818757927606907*^9}},ExpressionUUID->"98ea50b6-aa9c-4c8f-b0a2-\
5cbe1e50e521"],

Cell[BoxData[
 RowBox[{"(*", 
  RowBox[{"ConstraintMatrixContainer", "=", 
   RowBox[{"PackageFunction", "[", 
    RowBox[{"M_genericmesh", ",", "\[IndentingNewLine]", 
     RowBox[{"CreateMetric", "[", "M", "]"}], ",", "\[IndentingNewLine]", 
     RowBox[{"Caching", "\[Rule]", "True"}]}], "\[IndentingNewLine]", "]"}]}],
   "*)"}]], "Input",
 CellChangeTimes->{{3.797386608592368*^9, 3.7973866240931597`*^9}, 
   3.7973993564654083`*^9},ExpressionUUID->"2c70be85-305a-4b83-97f6-\
ad3da48e40ce"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Constraint", "'"}], "=", 
   RowBox[{"PackageFunction", "[", 
    RowBox[{"M_genericmesh", ",", "\[IndentingNewLine]", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", "g", "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"ToPack", "@", "Join"}], "@@", 
        RowBox[{"Table", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{"g", "=", 
            RowBox[{
             RowBox[{"G", "'"}], "[", "M", "]"}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"TensorRank", "[", "g", "]"}], "\[Equal]", "1"}], ",", 
             "\[IndentingNewLine]", 
             RowBox[{"If", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"Length", "[", "g", "]"}], "\[Equal]", "0"}], ",", 
               RowBox[{"{", "}"}], ",", 
               RowBox[{"Sparsify", "[", 
                RowBox[{"{", "g", "}"}], "]"}]}], "]"}], ",", 
             "\[IndentingNewLine]", 
             RowBox[{"Sparsify", "[", "g", "]"}]}], "\[IndentingNewLine]", 
            "]"}]}], "\[IndentingNewLine]", ",", 
          RowBox[{"{", 
           RowBox[{"G", ",", 
            RowBox[{"Keys", "[", 
             RowBox[{"ConstraintList", "[", "M", "]"}], "]"}]}], "}"}]}], 
         "]"}]}]}], "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", 
    "]"}]}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Constraint", "'"}], "=", 
  RowBox[{"PackageFunction", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"M_genericmesh", ",", "Ulist0_", ",", "slotlist_"}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"g", ",", "DGU", ",", "DG", ",", "Ulist", ",", "data"}], "}"}],
       ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"data", "=", 
        RowBox[{"Table", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{"Ulist", "=", 
            RowBox[{"ReadUList", "[", 
             RowBox[{"M", ",", "Ulist0", ",", "slotlist", ",", "G"}], "]"}]}],
            ";", "\[IndentingNewLine]", 
           RowBox[{"DGU", "=", 
            RowBox[{
             RowBox[{"G", "'"}], "[", 
             RowBox[{"M", ",", "Ulist", ",", "slotlist"}], "]"}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{"NumberQ", "[", "DGU", "]"}], ",", 
             RowBox[{"(*", "Then", "*)"}], "\[IndentingNewLine]", 
             RowBox[{"DGU", "=", 
              RowBox[{"Sparsify", "[", 
               RowBox[{"{", "DGU", "}"}], "]"}]}], ",", 
             RowBox[{"(*", "Else", "*)"}], "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"If", "[", 
               RowBox[{
                RowBox[{"!", 
                 RowBox[{"TensorQ", "[", "DGU", "]"}]}], ",", 
                RowBox[{"(*", "Then", "*)"}], "\[IndentingNewLine]", 
                RowBox[{
                 RowBox[{"DG", "=", 
                  RowBox[{
                   RowBox[{"G", "'"}], "[", "M", "]"}]}], ";", 
                 "\[IndentingNewLine]", 
                 RowBox[{"If", "[", 
                  RowBox[{
                   RowBox[{
                    RowBox[{"Length", "[", "DG", "]"}], "\[Equal]", "0"}], 
                   ",", "\[IndentingNewLine]", 
                   RowBox[{"DGU", "=", 
                    RowBox[{"{", "}"}]}], ",", "\[IndentingNewLine]", 
                   RowBox[{"(*", 
                    RowBox[{
                    RowBox[{"Print", "[", 
                    RowBox[{
                    "\"\<Constraint': Exception found with function \>\"", 
                    ",", "G", ",", "\"\<. Fallback used.\>\""}], "]"}], ";"}],
                     "*)"}], "\[IndentingNewLine]", 
                   RowBox[{
                    RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"TensorRank", "[", "DG", "]"}], "\[Equal]", "1"}],
                     ",", 
                    RowBox[{"DG", "=", 
                    RowBox[{"Sparsify", "[", 
                    RowBox[{"{", "DG", "}"}], "]"}]}]}], "]"}], ";", 
                    "\[IndentingNewLine]", 
                    RowBox[{"DGU", "=", 
                    RowBox[{"TensorVectorContract", "[", 
                    RowBox[{"DG", ",", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"GetBuffer", "[", 
                    RowBox[{"M", ",", "#"}], "]"}], "&"}], "/@", "Ulist"}], 
                    ",", "slotlist"}], "]"}]}], ";"}]}], 
                  "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", 
               "]"}], ";"}]}], "\[IndentingNewLine]", "]"}], ";", 
           "\[IndentingNewLine]", "DGU"}], ",", 
          RowBox[{"{", 
           RowBox[{"G", ",", 
            RowBox[{"Keys", "[", 
             RowBox[{"ConstraintList", "[", "M", "]"}], "]"}]}], "}"}]}], 
         "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"ToPack", "@", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"MemberQ", "[", 
           RowBox[{"slotlist", ",", "1"}], "]"}], ",", "\[IndentingNewLine]", 
          
          RowBox[{"Total", "[", "data", "]"}], ",", "\[IndentingNewLine]", 
          RowBox[{"Join", "@@", "data"}]}], "\[IndentingNewLine]", 
         "]"}]}]}]}], "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.689407392651518*^9, 3.689407393099134*^9}, {
   3.69721386703828*^9, 3.697213876060782*^9}, {3.700017662105796*^9, 
   3.7000176664312572`*^9}, {3.7000199353892393`*^9, 3.700019945259715*^9}, {
   3.7132626478724537`*^9, 3.7132626529203253`*^9}, {3.727112945038394*^9, 
   3.7271129700443153`*^9}, 3.727116152956089*^9, {3.7382465030492067`*^9, 
   3.738246506200241*^9}, {3.738246921092605*^9, 3.738246927783444*^9}, {
   3.738256483321767*^9, 3.738256493167769*^9}, 3.744026063654928*^9, {
   3.744026127466971*^9, 3.744026129151826*^9}},
 CellLabel->"In[83]:=",ExpressionUUID->"fca775ae-715e-4df6-9d33-47a215d000cb"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"Constraint", "''"}], "=", 
   RowBox[{"PackageFunction", "[", 
    RowBox[{"M_genericmesh", ",", "\[IndentingNewLine]", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", "g", "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"ToPack", "@", "Join"}], "@@", 
        RowBox[{"Table", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{"g", "=", 
            RowBox[{
             RowBox[{"G", "''"}], "[", "M", "]"}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"TensorRank", "[", "g", "]"}], "\[Equal]", "2"}], ",", 
             "\[IndentingNewLine]", 
             RowBox[{"Sparsify", "[", 
              RowBox[{"{", "g", "}"}], "]"}], ",", "\[IndentingNewLine]", 
             RowBox[{"If", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"TensorRank", "[", "g", "]"}], "\[Equal]", "1"}], ",", 
               RowBox[{"{", "}"}], ",", 
               RowBox[{"Sparsify", "[", "g", "]"}]}], "]"}]}], 
            "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", ",", 
          RowBox[{"{", 
           RowBox[{"G", ",", 
            RowBox[{"Keys", "[", 
             RowBox[{"ConstraintList", "[", "M", "]"}], "]"}]}], "}"}]}], 
         "]"}]}]}], "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", 
    "]"}]}], "\[IndentingNewLine]", "\[IndentingNewLine]"}]], "Input",
 CellChangeTimes->{{3.6812002664951*^9, 3.681200271722344*^9}, {
   3.681200405569091*^9, 3.6812004890869703`*^9}, {3.681200561159954*^9, 
   3.681200561583824*^9}, {3.681200602873822*^9, 3.681200605858266*^9}, {
   3.681200649752953*^9, 3.6812006501866827`*^9}, {3.681200712104566*^9, 
   3.6812007235779037`*^9}, {3.681200911074416*^9, 3.6812009239334097`*^9}, {
   3.683615752176113*^9, 3.6836157829715643`*^9}, {3.6843937286798897`*^9, 
   3.684393865437042*^9}, {3.6893965055278807`*^9, 3.6893965214852*^9}, 
   3.689407393589582*^9, {3.6972138813321123`*^9, 3.697213882779839*^9}, {
   3.7000199620357237`*^9, 3.7000199624113407`*^9}, {3.700118556005247*^9, 
   3.700118556935533*^9}, 3.700118733777596*^9, {3.7132623629772797`*^9, 
   3.713262413995513*^9}, {3.7132626380733347`*^9, 3.71326263899837*^9}, {
   3.714036112518104*^9, 3.714036122765882*^9}, {3.714037528591652*^9, 
   3.714037533093955*^9}, {3.714037741259111*^9, 3.714037742427163*^9}, {
   3.714041320503317*^9, 3.714041382197695*^9}, {3.714041694885358*^9, 
   3.7140417050666313`*^9}, {3.714488264983165*^9, 3.714488266070706*^9}, {
   3.714489032785946*^9, 3.7144890421525307`*^9}, {3.7144891189524813`*^9, 
   3.714489126353104*^9}, 3.7144891777499323`*^9, {3.714489549247295*^9, 
   3.7144895611487627`*^9}, 3.714489610482971*^9, {3.714489674719172*^9, 
   3.714489690235816*^9}, {3.7271129809439163`*^9, 3.7271130080357037`*^9}, {
   3.727116143497322*^9, 3.727116146710225*^9}, {3.738246509743184*^9, 
   3.738246515367507*^9}, {3.738246930224386*^9, 3.738246937207649*^9}, {
   3.7382564975934343`*^9, 3.738256504672765*^9}, {3.7440260843875513`*^9, 
   3.74402608479469*^9}, 3.75722029930048*^9, 3.757220791664501*^9, {
   3.757221049298719*^9, 3.75722105790291*^9}, {3.757222136966874*^9, 
   3.757222160022787*^9}, {3.757222215022077*^9, 3.757222236889531*^9}, {
   3.758479716301323*^9, 3.758479716634015*^9}, {3.758482742025803*^9, 
   3.758482785767666*^9}, 3.758482848421579*^9, {3.758482942623438*^9, 
   3.7584829606275673`*^9}, {3.758483149943721*^9, 3.758483155241212*^9}, {
   3.758484012430354*^9, 3.758484031759932*^9}, {3.758484317590951*^9, 
   3.758484327408217*^9}, 
   3.7884216319656763`*^9},ExpressionUUID->"63069bc8-1c70-4f6a-928a-\
164ab6584052"],

Cell[BoxData[
 RowBox[{
  RowBox[{"Constraint", "''"}], "=", 
  RowBox[{"PackageFunction", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"M_genericmesh", ",", "Ulist0_", ",", "slotlist_"}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "i0", ",", "slot1Q", ",", "spans", ",", "log", ",", "proc", ",", 
        "logPrint", ",", "f", ",", "DDGU", ",", "Ulist"}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"i0", "=", 
        RowBox[{"IntegerPositions", "[", 
         RowBox[{"slotlist", ",", "1"}], "]"}]}], ";", "\[IndentingNewLine]", 
       
       RowBox[{"slot1Q", "=", 
        RowBox[{
         RowBox[{"Length", "[", "i0", "]"}], ">", "0"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"proc", "=", 
        RowBox[{"ConstaintProcessingStorage", "[", "M", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"log", "=", 
        RowBox[{"ConstaintProcessingLog", "[", "M", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"logPrint", "=", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"G", ",", "x"}], "}"}], "\[Function]", 
         RowBox[{"(", 
          RowBox[{"(*", 
           RowBox[{
            RowBox[{"Print", "[", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{"G", ",", "2", ",", "slotlist"}], "}"}], "\[Rule]", 
              "x"}], "]"}], ";"}], "*)"}], 
          RowBox[{"AppendTo", "[", 
           RowBox[{"log", ",", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"G", ",", "2", ",", "slotlist"}], "}"}], "\[Rule]", 
             "x"}]}], "]"}], ")"}]}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"If", "[", 
         RowBox[{"slot1Q", ",", "Plus", ",", "Join"}], "]"}], "@@", 
        RowBox[{"Table", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{"f", "=", 
            RowBox[{"proc", "[", 
             RowBox[{"{", 
              RowBox[{"G", ",", "2", ",", "slotlist"}], "}"}], "]"}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"Ulist", "=", 
            RowBox[{"ReadUList", "[", 
             RowBox[{"M", ",", "Ulist0", ",", "slotlist", ",", "G"}], "]"}]}],
            ";", "\[IndentingNewLine]", 
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{"!", 
              RowBox[{"MissingQ", "[", "f", "]"}]}], ",", 
             "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"DDGU", "=", 
               RowBox[{"f", "[", 
                RowBox[{"M", ",", "Ulist"}], "]"}]}], ";"}], 
             "\[IndentingNewLine]", ",", "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"logPrint", "[", 
               RowBox[{
               "G", ",", 
                "\"\<Processing function has not been created, yet.\>\""}], 
               "]"}], ";", "\[IndentingNewLine]", 
              RowBox[{"If", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{"-", 
                  RowBox[{"Subtract", " ", "@@", " ", 
                   RowBox[{
                    RowBox[{"(", 
                    RowBox[{"ConstraintSpans", "[", "M", "]"}], ")"}], "[", 
                    "G", "]"}]}]}], "<", "0"}], ",", "\[IndentingNewLine]", 
                RowBox[{"(", "\[IndentingNewLine]", 
                 RowBox[{
                  RowBox[{"logPrint", "[", 
                   RowBox[{"G", ",", "\"\<No actual constraint found.\>\""}], 
                   "]"}], ";", "\[IndentingNewLine]", 
                  RowBox[{"f", "=", 
                   RowBox[{
                    RowBox[{"{", 
                    RowBox[{"\[FormalX]", ",", "\[FormalU]"}], "}"}], 
                    "\[Function]", "Nothing"}]}], ";", "\[IndentingNewLine]", 
                  
                  RowBox[{"(*", 
                   RowBox[{
                    RowBox[{"DDGU", "=", 
                    RowBox[{"{", "}"}]}], ";"}], "*)"}], 
                  "\[IndentingNewLine]", 
                  RowBox[{"DDGU", "=", "Nothing"}], ";"}], 
                 "\[IndentingNewLine]", ")"}], "\[IndentingNewLine]", ",", 
                "\[IndentingNewLine]", 
                RowBox[{"(", "\[IndentingNewLine]", 
                 RowBox[{
                  RowBox[{"logPrint", "[", 
                   RowBox[{"G", ",", "\"\<Constraint found.\>\""}], "]"}], 
                  ";", "\[IndentingNewLine]", 
                  RowBox[{"DDGU", "=", 
                   RowBox[{
                    RowBox[{"G", "''"}], "[", 
                    RowBox[{"M", ",", "Ulist", ",", "slotlist"}], "]"}]}], 
                  ";", "\[IndentingNewLine]", 
                  RowBox[{"If", "[", "\[IndentingNewLine]", 
                   RowBox[{
                    RowBox[{
                    RowBox[{"TensorQ", "[", "DDGU", "]"}], "||", 
                    RowBox[{"NumericQ", "[", "DDGU", "]"}]}], 
                    "\[IndentingNewLine]", ",", "\[IndentingNewLine]", 
                    RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{"TensorQ", "[", "DDGU", "]"}], ",", 
                    "\[IndentingNewLine]", 
                    RowBox[{"(", "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"logPrint", "[", 
                    RowBox[{
                    "G", ",", 
                    "\"\<Everything is fine, G'' is well-implemented and \
tensorial.\>\""}], "]"}], ";", "\[IndentingNewLine]", 
                    RowBox[{"f", "=", 
                    RowBox[{"With", "[", 
                    RowBox[{
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"G", "=", "G"}], ",", 
                    RowBox[{"s", "=", "slotlist"}]}], "}"}], ",", 
                    RowBox[{
                    RowBox[{"{", 
                    RowBox[{"\[FormalX]", ",", "\[FormalU]"}], "}"}], 
                    "\[Function]", 
                    RowBox[{
                    RowBox[{"G", "''"}], "[", 
                    RowBox[{"\[FormalX]", ",", "\[FormalU]", ",", "s"}], 
                    "]"}]}]}], "]"}]}]}], "\[IndentingNewLine]", ")"}], 
                    "\[IndentingNewLine]", ",", "\[IndentingNewLine]", 
                    RowBox[{"(", "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"DDGU", "=", 
                    RowBox[{"ToPack", "[", 
                    RowBox[{"{", "DDGU", "}"}], "]"}]}], ";", 
                    "\[IndentingNewLine]", 
                    RowBox[{"logPrint", "[", 
                    RowBox[{
                    "G", ",", 
                    "\"\<Everything is fine, G'' is well-implemented and \
scalar.\>\""}], "]"}], ";", "\[IndentingNewLine]", 
                    RowBox[{"f", "=", 
                    RowBox[{"With", "[", 
                    RowBox[{
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"G", "=", "G"}], ",", 
                    RowBox[{"s", "=", "slotlist"}]}], "}"}], ",", 
                    RowBox[{
                    RowBox[{"{", 
                    RowBox[{"\[FormalX]", ",", "\[FormalU]"}], "}"}], 
                    "\[Function]", 
                    RowBox[{"ToPack", "[", 
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"G", "''"}], "[", 
                    RowBox[{"\[FormalX]", ",", "\[FormalU]", ",", "s"}], 
                    "]"}], "}"}], "]"}]}]}], "]"}]}]}], "\[IndentingNewLine]",
                     ")"}]}], "\[IndentingNewLine]", "]"}], 
                    "\[IndentingNewLine]", 
                    RowBox[{"(*", 
                    RowBox[{
                    RowBox[{"DDGU", "=", "DDGU"}], ";"}], "*)"}], 
                    "\[IndentingNewLine]", ",", "\[IndentingNewLine]", 
                    RowBox[{"(", "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"logPrint", "[", 
                    RowBox[{
                    "G", ",", "\"\<G'' is not well-implemented.\>\""}], "]"}],
                     ";", "\[IndentingNewLine]", 
                    RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"Length", "[", "i0", "]"}], "\[LessEqual]", "0"}],
                     "\[IndentingNewLine]", ",", "\[IndentingNewLine]", 
                    RowBox[{"(", "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"logPrint", "[", 
                    RowBox[{"G", ",", "\"\<Slot 1 does not appear.\>\""}], 
                    "]"}], ";", "\[IndentingNewLine]", 
                    RowBox[{"(*", 
                    RowBox[{
                    RowBox[{
                    "one", " ", "of", " ", "the", " ", "worst", " ", 
                    "cases"}], ",", " ", 
                    RowBox[{
                    RowBox[{"computing", " ", "the", " ", "full", " ", "3"}], 
                    "-", 
                    RowBox[{
                    "tensor", " ", "and", " ", "contract", " ", 
                    "afterwards"}]}]}], "*)"}], "\[IndentingNewLine]", 
                    RowBox[{"f", "=", 
                    RowBox[{"With", "[", 
                    RowBox[{
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"G", "=", "G"}], ",", 
                    RowBox[{"s", "=", "slotlist"}]}], "}"}], ",", 
                    "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"{", 
                    RowBox[{"\[FormalX]", ",", "\[FormalU]"}], "}"}], 
                    "\[Function]", 
                    RowBox[{"TensorVectorContract", "[", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"G", "''"}], "[", "\[FormalX]", "]"}], ",", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"GetBuffer", "[", 
                    RowBox[{"\[FormalX]", ",", "#"}], "]"}], "&"}], "/@", 
                    "\[FormalU]"}], ",", "s"}], "]"}]}]}], 
                    "\[IndentingNewLine]", "]"}]}], ";", 
                    "\[IndentingNewLine]", 
                    RowBox[{"DDGU", "=", 
                    RowBox[{"f", "[", 
                    RowBox[{"M", ",", "Ulist"}], "]"}]}], ";"}], 
                    "\[IndentingNewLine]", ")"}], "\[IndentingNewLine]", ",", 
                    "\[IndentingNewLine]", 
                    RowBox[{"(", "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"logPrint", "[", 
                    RowBox[{"G", ",", "\"\<Slot 1 found.\>\""}], "]"}], ";", 
                    "\[IndentingNewLine]", 
                    RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"-", 
                    RowBox[{"Subtract", " ", "@@", " ", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{"ConstraintSpans", "[", "M", "]"}], ")"}], "[", 
                    "G", "]"}]}]}], "\[Equal]", "0"}], "\[IndentingNewLine]", 
                    ",", "\[IndentingNewLine]", 
                    RowBox[{"(", "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"logPrint", "[", 
                    RowBox[{"G", ",", "\"\<G is scalar.\>\""}], "]"}], ";", 
                    "\[IndentingNewLine]", 
                    RowBox[{"DDGU", "=", 
                    RowBox[{
                    RowBox[{"G", "''"}], "[", 
                    RowBox[{"M", ",", 
                    RowBox[{"Delete", "[", 
                    RowBox[{"Ulist", ",", "i0"}], "]"}], ",", 
                    RowBox[{"Delete", "[", 
                    RowBox[{"slotlist", ",", "i0"}], "]"}]}], "]"}]}], ";", 
                    "\[IndentingNewLine]", 
                    RowBox[{"If", "[", "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"TensorQ", "[", "DDGU", "]"}], 
                    "\[IndentingNewLine]", ",", "\[IndentingNewLine]", 
                    RowBox[{"(", "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"logPrint", "[", 
                    RowBox[{
                    "G", ",", 
                    "\"\<G is scalar but G'' supports requested slots.\>\""}],
                     "]"}], ";", "\[IndentingNewLine]", 
                    RowBox[{"f", "=", 
                    RowBox[{"With", "[", 
                    RowBox[{
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"G", "=", "G"}], ",", 
                    RowBox[{"i", "=", "i0"}], ",", 
                    RowBox[{"s", "=", 
                    RowBox[{"Delete", "[", 
                    RowBox[{"slotlist", ",", "i0"}], "]"}]}]}], "}"}], ",", 
                    "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"{", 
                    RowBox[{"\[FormalX]", ",", "\[FormalU]"}], "}"}], 
                    "\[Function]", 
                    RowBox[{
                    RowBox[{"GetBuffer", "[", 
                    RowBox[{"\[FormalX]", ",", 
                    RowBox[{
                    RowBox[{"\[FormalU]", "\[LeftDoubleBracket]", 
                    RowBox[{
                    "i", "\[LeftDoubleBracket]", "1", 
                    "\[RightDoubleBracket]"}], "\[RightDoubleBracket]"}], 
                    "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}]}], 
                    "]"}], 
                    RowBox[{
                    RowBox[{"G", "''"}], "[", 
                    RowBox[{"\[FormalX]", ",", 
                    RowBox[{"Delete", "[", 
                    RowBox[{"\[FormalU]", ",", "i"}], "]"}], ",", "s"}], 
                    "]"}]}]}]}], "\[IndentingNewLine]", "]"}]}], ";", 
                    "\[IndentingNewLine]", 
                    RowBox[{"(*", 
                    RowBox[{
                    RowBox[{"DDGU", "=", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"Ulist", "\[LeftDoubleBracket]", 
                    RowBox[{
                    "i0", "\[LeftDoubleBracket]", "1", 
                    "\[RightDoubleBracket]"}], "\[RightDoubleBracket]"}], 
                    "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], 
                    "DDGU"}]}], ";"}], "*)"}], "\[IndentingNewLine]", 
                    RowBox[{"DDGU", "=", 
                    RowBox[{"f", "[", 
                    RowBox[{"M", ",", "Ulist"}], "]"}]}], ";"}], 
                    "\[IndentingNewLine]", ")"}], "\[IndentingNewLine]", ",", 
                    "\[IndentingNewLine]", 
                    RowBox[{"(", "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"logPrint", "[", 
                    RowBox[{
                    "G", ",", 
                    "\"\<G is scalar and G'' does not support requested \
slots.\>\""}], "]"}], ";", "\[IndentingNewLine]", 
                    RowBox[{"f", "=", 
                    RowBox[{"With", "[", 
                    RowBox[{
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"G", "=", "G"}], ",", 
                    RowBox[{"i", "=", "i0"}], ",", 
                    RowBox[{"s", "=", 
                    RowBox[{"Delete", "[", 
                    RowBox[{"slotlist", ",", "i0"}], "]"}]}]}], "}"}], ",", 
                    "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"{", 
                    RowBox[{"\[FormalX]", ",", "\[FormalU]"}], "}"}], 
                    "\[Function]", 
                    RowBox[{
                    RowBox[{"GetBuffer", "[", 
                    RowBox[{"\[FormalX]", ",", 
                    RowBox[{
                    RowBox[{"\[FormalU]", "\[LeftDoubleBracket]", 
                    RowBox[{
                    "i", "\[LeftDoubleBracket]", "1", 
                    "\[RightDoubleBracket]"}], "\[RightDoubleBracket]"}], 
                    "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}]}], 
                    "]"}], 
                    RowBox[{"TensorVectorContract", "[", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"G", "''"}], "[", "\[FormalX]", "]"}], ",", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"GetBuffer", "[", 
                    RowBox[{"\[FormalX]", ",", "#"}], "]"}], "&"}], "/@", 
                    RowBox[{"Delete", "[", 
                    RowBox[{"\[FormalU]", ",", "i"}], "]"}]}], ",", "s"}], 
                    "]"}]}]}]}], "\[IndentingNewLine]", "]"}]}], ";", 
                    "\[IndentingNewLine]", 
                    RowBox[{"DDGU", "=", 
                    RowBox[{"f", "[", 
                    RowBox[{"M", ",", "Ulist"}], "]"}]}], ";"}], 
                    "\[IndentingNewLine]", ")"}]}], "\[IndentingNewLine]", 
                    "]"}]}], "\[IndentingNewLine]", ")"}], 
                    "\[IndentingNewLine]", ",", "\[IndentingNewLine]", 
                    RowBox[{"(", "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"logPrint", "[", 
                    RowBox[{"G", ",", "\"\<G is vectorial.\>\""}], "]"}], ";",
                     "\[IndentingNewLine]", 
                    RowBox[{"DDGU", "=", 
                    RowBox[{
                    RowBox[{"G", "''"}], "[", 
                    RowBox[{"M", ",", 
                    RowBox[{"Delete", "[", 
                    RowBox[{"Ulist", ",", "i0"}], "]"}], ",", 
                    RowBox[{"Delete", "[", 
                    RowBox[{"slotlist", ",", "i0"}], "]"}]}], "]"}]}], ";", 
                    "\[IndentingNewLine]", 
                    RowBox[{"If", "[", "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"TensorQ", "[", "DDGU", "]"}], 
                    "\[IndentingNewLine]", ",", "\[IndentingNewLine]", 
                    RowBox[{"(", "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"logPrint", "[", 
                    RowBox[{
                    "G", ",", 
                    "\"\<G is vectorial but G'' supports requested \
slots.\>\""}], "]"}], ";", "\[IndentingNewLine]", 
                    RowBox[{"f", "=", 
                    RowBox[{"With", "[", 
                    RowBox[{
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"G", "=", "G"}], ",", 
                    RowBox[{"i", "=", "i0"}], ",", 
                    RowBox[{"s", "=", 
                    RowBox[{"Delete", "[", 
                    RowBox[{"slotlist", ",", "i0"}], "]"}]}]}], "}"}], ",", 
                    "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"{", 
                    RowBox[{"\[FormalX]", ",", "\[FormalU]"}], "}"}], 
                    "\[Function]", 
                    RowBox[{
                    RowBox[{"GetBuffer", "[", 
                    RowBox[{"\[FormalX]", ",", 
                    RowBox[{"\[FormalU]", "\[LeftDoubleBracket]", 
                    RowBox[{
                    "i", "\[LeftDoubleBracket]", "1", 
                    "\[RightDoubleBracket]"}], "\[RightDoubleBracket]"}]}], 
                    "]"}], 
                    RowBox[{
                    RowBox[{"G", "''"}], "[", 
                    RowBox[{"\[FormalX]", ",", 
                    RowBox[{"Delete", "[", 
                    RowBox[{"\[FormalU]", ",", "i"}], "]"}], ",", "s"}], 
                    "]"}]}]}]}], "\[IndentingNewLine]", "]"}]}], ";", 
                    "\[IndentingNewLine]", 
                    RowBox[{"(*", 
                    RowBox[{
                    RowBox[{"DDGU", "=", 
                    RowBox[{
                    RowBox[{"Ulist", "\[LeftDoubleBracket]", 
                    RowBox[{
                    "i0", "\[LeftDoubleBracket]", "1", 
                    "\[RightDoubleBracket]"}], "\[RightDoubleBracket]"}], ".",
                     "DDGU"}]}], ";"}], "*)"}], "\[IndentingNewLine]", 
                    RowBox[{"DDGU", "=", 
                    RowBox[{"f", "[", 
                    RowBox[{"M", ",", "Ulist"}], "]"}]}], ";"}], 
                    "\[IndentingNewLine]", ")"}], "\[IndentingNewLine]", ",", 
                    "\[IndentingNewLine]", 
                    RowBox[{"(", "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"logPrint", "[", 
                    RowBox[{
                    "G", ",", 
                    "\"\<G is vectorial but G'' does not support requested \
slots.\>\""}], "]"}], ";", "\[IndentingNewLine]", 
                    RowBox[{"(*", 
                    RowBox[{
                    RowBox[{
                    "one", " ", "of", " ", "the", " ", "worst", " ", 
                    "cases"}], ",", " ", 
                    RowBox[{
                    RowBox[{"computing", " ", "the", " ", "full", " ", "3"}], 
                    "-", 
                    RowBox[{
                    "tensor", " ", "and", " ", "contract", " ", 
                    "afterwards"}]}]}], "*)"}], "\[IndentingNewLine]", 
                    RowBox[{"f", "=", 
                    RowBox[{"With", "[", 
                    RowBox[{
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"G", "=", "G"}], ",", 
                    RowBox[{"s", "=", "slotlist"}]}], "}"}], ",", 
                    "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"{", 
                    RowBox[{"\[FormalX]", ",", "\[FormalU]"}], "}"}], 
                    "\[Function]", 
                    RowBox[{"TensorVectorContract", "[", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"G", "''"}], "[", "\[FormalX]", "]"}], ",", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"GetBuffer", "[", 
                    RowBox[{"\[FormalX]", ",", "#"}], "]"}], "&"}], "/@", 
                    "\[FormalU]"}], ",", "s"}], "]"}]}]}], 
                    "\[IndentingNewLine]", "]"}]}], ";", 
                    "\[IndentingNewLine]", 
                    RowBox[{"DDGU", "=", 
                    RowBox[{"f", "[", 
                    RowBox[{"M", ",", "Ulist"}], "]"}]}], ";"}], 
                    "\[IndentingNewLine]", ")"}]}], "\[IndentingNewLine]", 
                    "]"}]}], "\[IndentingNewLine]", ")"}]}], 
                    "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", 
                    ")"}]}], "\[IndentingNewLine]", "]"}]}], 
                    "\[IndentingNewLine]", ")"}]}], "\[IndentingNewLine]", 
                   "]"}]}], "\[IndentingNewLine]", ")"}]}], 
               "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{"proc", "[", 
                RowBox[{"{", 
                 RowBox[{"G", ",", "2", ",", "slotlist"}], "}"}], "]"}], "=", 
               "f"}], ";", "\[IndentingNewLine]", 
              RowBox[{"SetPersistentCache", "[", 
               RowBox[{
               "M", ",", "\"\<ConstaintProcessingStorage\>\"", ",", "proc"}], 
               "]"}], ";", "\[IndentingNewLine]", 
              RowBox[{"SetPersistentCache", "[", 
               RowBox[{
               "M", ",", "\"\<ConstaintProcessingLog\>\"", ",", "log"}], 
               "]"}], ";"}]}], "\[IndentingNewLine]", "]"}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"(*", 
            RowBox[{"Sparsify", "[", "DDGU", "]"}], "*)"}], 
           "\[IndentingNewLine]", "DDGU"}], "\[IndentingNewLine]", ",", 
          RowBox[{"{", 
           RowBox[{"G", ",", 
            RowBox[{"Keys", "[", 
             RowBox[{"ConstraintList", "[", "M", "]"}], "]"}]}], "}"}]}], 
         "]"}]}]}]}], "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", 
   "]"}]}]], "Input",
 CellChangeTimes->{{3.7884155299124117`*^9, 3.788415535799499*^9}, {
   3.788415670940256*^9, 3.7884156753068542`*^9}, 3.7884160847643948`*^9, {
   3.788416126016046*^9, 3.7884161392466993`*^9}, {3.788417640905237*^9, 
   3.788417709428809*^9}, {3.7884183630950613`*^9, 3.7884183653166733`*^9}, {
   3.788418403262207*^9, 3.7884185184650803`*^9}, {3.788418582758284*^9, 
   3.78841879294448*^9}, {3.788418926042354*^9, 3.78841895935511*^9}, {
   3.7884190206908913`*^9, 3.788419114235832*^9}, {3.7884192147383966`*^9, 
   3.7884192641409063`*^9}, {3.788419312093052*^9, 3.7884193566844463`*^9}, {
   3.7884194413218822`*^9, 3.788419485066173*^9}, {3.788419521512719*^9, 
   3.788419699966095*^9}, {3.7884197399937057`*^9, 3.788419832155114*^9}, {
   3.788419876123424*^9, 3.788419876297863*^9}, {3.788419920168994*^9, 
   3.788419935208344*^9}, {3.788420015591366*^9, 3.788420019995858*^9}, {
   3.788420106849557*^9, 3.788420114752698*^9}, 3.78842021895012*^9, {
   3.788420264429186*^9, 3.7884203563758183`*^9}, {3.788420392735857*^9, 
   3.788420511057989*^9}, {3.788420592211483*^9, 3.788420593503395*^9}, {
   3.788420629941597*^9, 3.7884206427174883`*^9}, {3.7884206748523808`*^9, 
   3.788420712202982*^9}, {3.788420761409606*^9, 3.788420915540901*^9}, 
   3.78842100493775*^9, {3.788421103206625*^9, 3.788421124164568*^9}, {
   3.788421180130019*^9, 3.7884213080510406`*^9}, {3.7884213501165037`*^9, 
   3.788421489005619*^9}, {3.788421540166889*^9, 3.78842156087547*^9}, {
   3.788421645680677*^9, 3.7884217934427233`*^9}, {3.78842183473062*^9, 
   3.788421887022657*^9}, 3.788421941462781*^9, {3.7884219977804956`*^9, 
   3.78842200853189*^9}, {3.7884220458023767`*^9, 3.788422253706853*^9}, {
   3.7884222854888144`*^9, 3.788422491657049*^9}, 3.788422558888241*^9, {
   3.7884226414763193`*^9, 3.788422724741338*^9}, 3.7884227966872473`*^9, {
   3.788423125455662*^9, 3.788423128255775*^9}, 3.788423255431443*^9, 
   3.788427404958029*^9, 3.788427465430196*^9, {3.788427513556055*^9, 
   3.788427518450735*^9}, {3.7884277156665487`*^9, 3.7884277186976147`*^9}, {
   3.788428131178616*^9, 3.788428135625504*^9}, {3.788428194728084*^9, 
   3.788428207974243*^9}, {3.788447645145793*^9, 3.788447677935066*^9}, {
   3.7884477669241734`*^9, 3.7884478719916973`*^9}, {3.7884480374983597`*^9, 
   3.7884480637693777`*^9}, 3.797393465698838*^9, {3.797394843282621*^9, 
   3.7973948535101433`*^9}, {3.797395287753765*^9, 3.7973952899935837`*^9}, {
   3.797395325896996*^9, 3.79739533179184*^9}, {3.8049288135856743`*^9, 
   3.8049288396115*^9}, {3.8049288738518887`*^9, 3.8049288846915894`*^9}, {
   3.8158925410892687`*^9, 3.815892544191071*^9}, 3.815892611351205*^9, {
   3.8158926693218737`*^9, 3.815892675807951*^9}, {3.815892713746746*^9, 
   3.815892731496414*^9}, {3.815893367925819*^9, 3.8158934265290833`*^9}, {
   3.815905292004307*^9, 3.8159052930963078`*^9}, {3.815905334967351*^9, 
   3.815905422229631*^9}, {3.815905474171767*^9, 3.815905478643567*^9}, {
   3.8159055137155952`*^9, 3.81590551623466*^9}, {3.815905568168332*^9, 
   3.8159056959957523`*^9}, {3.8159057489847717`*^9, 3.815905749153789*^9}, 
   3.816683337773026*^9},ExpressionUUID->"dbe81886-d2da-4326-8fda-\
70aa5d29aa2e"],

Cell[BoxData[
 RowBox[{"(*", 
  RowBox[{
   RowBox[{"Constraint", "''"}], "=", 
   RowBox[{"PackageFunction", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"M_genericmesh", ",", "Ulist0_", ",", "slotlist0_"}], "}"}], 
     ",", "\[IndentingNewLine]", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
        "g", ",", "DDGU", ",", "DDG", ",", "Ulist", ",", "s", ",", "i0", ",", 
         "slotlist", ",", "lens"}], "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"i0", "=", 
         RowBox[{"IntegerPositions", "[", 
          RowBox[{"slotlist0", ",", "1"}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"Length", "[", "i0", "]"}], ">", "0"}], ",", 
          RowBox[{"(*", "Then", "*)"}], "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"lens", "=", 
            RowBox[{"ConstraintLengths", "[", "M", "]"}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"Plus", "@@", 
            RowBox[{"Table", "[", "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{
               RowBox[{"slotlist", "=", 
                RowBox[{"Join", "[", 
                 RowBox[{
                  RowBox[{
                  "slotlist0", "\[LeftDoubleBracket]", "i0", 
                   "\[RightDoubleBracket]"}], ",", 
                  RowBox[{"Delete", "[", 
                   RowBox[{"slotlist0", ",", "i0"}], "]"}]}], "]"}]}], ";", 
               "\[IndentingNewLine]", 
               RowBox[{"Ulist", "=", 
                RowBox[{"ReadUList", "[", 
                 RowBox[{"M", ",", "Ulist0", ",", "slotlist", ",", "G"}], 
                 "]"}]}], ";", "\[IndentingNewLine]", 
               RowBox[{"If", "[", 
                RowBox[{
                 RowBox[{
                  RowBox[{"lens", "[", "G", "]"}], "\[Equal]", "0"}], ",", 
                 "\[IndentingNewLine]", 
                 RowBox[{
                  RowBox[{"s", "=", 
                   RowBox[{
                    RowBox[{
                    RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"Length", "[", "#", "]"}], "\[Equal]", "0"}], ",",
                     "0.", ",", 
                    RowBox[{
                    "#", "\[LeftDoubleBracket]", "1", 
                    "\[RightDoubleBracket]"}]}], "]"}], "&"}], "@", 
                    RowBox[{"First", "[", "Ulist", "]"}]}]}], ";", 
                  "\[IndentingNewLine]", 
                  RowBox[{"Ulist", "=", 
                   RowBox[{"Rest", "[", "Ulist", "]"}]}], ";", 
                  "\[IndentingNewLine]", 
                  RowBox[{"slotlist", "=", 
                   RowBox[{"Rest", "[", "slotlist", "]"}]}], ";", 
                  "\[IndentingNewLine]", 
                  RowBox[{"DDGU", "=", " ", 
                   RowBox[{"s", " ", 
                    RowBox[{
                    RowBox[{"G", "''"}], "[", 
                    RowBox[{"M", ",", "Ulist", ",", "slotlist"}], "]"}]}]}], 
                  ";", "\[IndentingNewLine]", 
                  RowBox[{"If", "[", 
                   RowBox[{
                    RowBox[{"!", 
                    RowBox[{"TensorQ", "[", "DDGU", "]"}]}], ",", 
                    RowBox[{"(*", "Then", "*)"}], "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"DDG", "=", 
                    RowBox[{
                    RowBox[{"G", "''"}], "[", "M", "]"}]}], ";", 
                    "\[IndentingNewLine]", 
                    RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"Length", "[", "DDG", "]"}], "\[Equal]", "0"}], 
                    ",", "\[IndentingNewLine]", 
                    RowBox[{"DDGU", "=", "Nothing"}], ",", 
                    "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"DDGU", "=", 
                    RowBox[{"s", " ", 
                    RowBox[{"TensorVectorContract", "[", 
                    RowBox[{"DDG", ",", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"GetBuffer", "[", 
                    RowBox[{"M", ",", "#"}], "]"}], "&"}], "/@", "Ulist"}], 
                    ",", "slotlist"}], "]"}]}]}], ";"}]}], 
                    "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", 
                   "]"}]}], ",", "\[IndentingNewLine]", 
                 RowBox[{
                  RowBox[{"DDGU", "=", 
                   RowBox[{
                    RowBox[{"G", "''"}], "[", 
                    RowBox[{"M", ",", "Ulist", ",", "slotlist"}], "]"}]}], 
                  ";"}]}], "\[IndentingNewLine]", "]"}], ";", 
               "\[IndentingNewLine]", "DDGU"}], ",", "\[IndentingNewLine]", 
              RowBox[{"{", 
               RowBox[{"G", ",", 
                RowBox[{"Keys", "[", 
                 RowBox[{"ConstraintList", "[", "M", "]"}], "]"}]}], "}"}]}], 
             "]"}]}]}], "\[IndentingNewLine]", ",", 
          RowBox[{"(*", "Else", "*)"}], "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"ToPack", "@", "Join"}], "@@", 
           RowBox[{"Table", "[", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{
              RowBox[{"Ulist", "=", 
               RowBox[{"ReadUList", "[", 
                RowBox[{"M", ",", "Ulist0", ",", "slotlist0", ",", "G"}], 
                "]"}]}], ";", "\[IndentingNewLine]", 
              RowBox[{"DDGU", "=", 
               RowBox[{"Sparsify", "[", 
                RowBox[{
                 RowBox[{"G", "''"}], "[", 
                 RowBox[{"M", ",", "Ulist", ",", "slotlist0"}], "]"}], 
                "]"}]}], ";", "\[IndentingNewLine]", 
              RowBox[{"If", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{"!", 
                  RowBox[{"TensorQ", "[", "DDGU", "]"}]}], "&&", 
                 RowBox[{"!", 
                  RowBox[{"NumberQ", "[", "DDGU", "]"}]}]}], ",", 
                "\[IndentingNewLine]", 
                RowBox[{
                 RowBox[{"DDG", "=", 
                  RowBox[{
                   RowBox[{"G", "''"}], "[", "M", "]"}]}], ";", 
                 "\[IndentingNewLine]", 
                 RowBox[{"If", "[", 
                  RowBox[{
                   RowBox[{
                    RowBox[{"Length", "[", "DDG", "]"}], "\[Equal]", "0"}], 
                   ",", "\[IndentingNewLine]", 
                   RowBox[{"DDGU", "=", 
                    RowBox[{"{", "}"}]}], ",", "\[IndentingNewLine]", 
                   RowBox[{"(*", 
                    RowBox[{
                    RowBox[{"Print", "[", 
                    RowBox[{
                    "\"\<Constraint': Exception found with function \>\"", 
                    ",", "G", ",", "\"\<. Fallback used.\>\""}], "]"}], ";"}],
                     "*)"}], "\[IndentingNewLine]", 
                   RowBox[{
                    RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"TensorRank", "[", "DDG", "]"}], "\[Equal]", 
                    "2"}], ",", 
                    RowBox[{"DDG", "=", 
                    RowBox[{"Sparsify", "[", 
                    RowBox[{"{", "DDG", "}"}], "]"}]}]}], "]"}], ";", 
                    "\[IndentingNewLine]", 
                    RowBox[{"DDGU", "=", 
                    RowBox[{"TensorVectorContract", "[", 
                    RowBox[{"DDG", ",", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"GetBuffer", "[", 
                    RowBox[{"M", ",", "#"}], "]"}], "&"}], "/@", "Ulist"}], 
                    ",", "slotlist0"}], "]"}]}], ";"}]}], 
                  "\[IndentingNewLine]", "]"}], ";"}]}], 
               "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
              RowBox[{"If", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{"ArrayQ", "[", "DDGU", "]"}], "&&", 
                 RowBox[{"0", "<", 
                  RowBox[{"ArrayDepth", "[", "DDGU", "]"}], "<", 
                  RowBox[{"3", "-", 
                   RowBox[{"Length", "[", "slotlist0", "]"}]}]}], "&&", 
                 RowBox[{
                  RowBox[{"Length", "[", "DDGU", "]"}], ">", "0"}]}], ",", 
                "\[IndentingNewLine]", 
                RowBox[{"DDGU", "=", 
                 RowBox[{"Sparsify", "[", 
                  RowBox[{"{", "DDGU", "}"}], "]"}]}], ",", 
                "\[IndentingNewLine]", 
                RowBox[{"If", "[", 
                 RowBox[{
                  RowBox[{"NumberQ", "[", "DDGU", "]"}], ",", 
                  RowBox[{"DDGU", "=", 
                   RowBox[{"Sparsify", "[", 
                    RowBox[{"{", "DDGU", "}"}], "]"}]}]}], "]"}]}], 
               "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
              "DDGU"}], ",", "\[IndentingNewLine]", 
             RowBox[{"{", 
              RowBox[{"G", ",", 
               RowBox[{"Keys", "[", 
                RowBox[{"ConstraintList", "[", "M", "]"}], "]"}]}], "}"}]}], 
            "]"}]}]}], "\[IndentingNewLine]", "]"}]}]}], 
      "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", "]"}]}], 
  "*)"}]], "Input",
 CellChangeTimes->{
  3.7884216379322567`*^9},ExpressionUUID->"958a6f35-679a-48a5-9f5f-\
200e1f79b751"],

Cell[BoxData[
 RowBox[{"ConstraintViolation", "=", 
  RowBox[{"PackageFunction", "[", 
   RowBox[{"M_genericmesh", ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"Constraint", "[", "M", "]"}], "-", 
     RowBox[{"DesiredConstraint", "[", "M", "]"}]}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"Caching", "\[Rule]", "True"}]}], "\[IndentingNewLine]", 
   "]"}]}]], "Input",
 CellChangeTimes->{{3.681200730278901*^9, 3.6812007312220583`*^9}, {
   3.681200930876479*^9, 3.6812009324332314`*^9}, 3.689407395182179*^9, {
   3.738246940263082*^9, 
   3.738246942269412*^9}},ExpressionUUID->"f829e491-0309-4243-b5e7-\
d6300ff3d160"],

Cell[BoxData[
 RowBox[{
  RowBox[{"ConstraintViolation", "'"}], "=", 
  RowBox[{"PackageFunction", "[", 
   RowBox[{"M_genericmesh", ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"Constraint", "'"}], "[", "M", "]"}]}], "\[IndentingNewLine]", 
   "]"}]}]], "Input",
 CellChangeTimes->{{3.815627694990136*^9, 
  3.815627741863452*^9}},ExpressionUUID->"75be5180-8150-4d52-9225-\
ebce5d8c8afc"]
},
WindowSize->{1440, 851},
WindowMargins->{{0, Automatic}, {Automatic, 0}},
FrontEndVersion->"12.0 for Mac OS X x86 (64-bit) (April 8, 2019)",
StyleDefinitions->"Default.nb"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[558, 20, 237, 5, 92, "Input",ExpressionUUID->"999bd74a-04a3-4a8c-9a0b-f3fc22a8057c"],
Cell[798, 27, 711, 15, 192, "Input",ExpressionUUID->"a4c6be2f-1799-478c-a78f-6a7530753a1a"],
Cell[1512, 44, 4204, 84, 467, "Input",ExpressionUUID->"4f83fffc-5c64-4128-8035-1784bd4bbcd8"],
Cell[5719, 130, 1532, 38, 192, "Input",ExpressionUUID->"52e385cf-4d45-4fe5-86ec-eb9571bf155b"],
Cell[7254, 170, 522, 11, 117, "Input",ExpressionUUID->"c5641da3-b359-4b6d-b61c-a8817acd398d"],
Cell[7779, 183, 2444, 54, 467, "Input",ExpressionUUID->"b9a4b187-a373-477a-b9a0-06d666801087"],
Cell[10226, 239, 1437, 36, 242, "Input",ExpressionUUID->"b4250597-8685-4b8e-a7db-224800886ebe"],
Cell[11666, 277, 571, 11, 117, "Input",ExpressionUUID->"af4c962f-4e98-458e-b53a-e458adfe6df8"],
Cell[12240, 290, 557, 10, 117, "Input",ExpressionUUID->"6edcebe0-31e1-4119-8896-e5c88d5c4aeb"],
Cell[12800, 302, 864, 17, 117, "Input",ExpressionUUID->"fd5e9fa4-5da0-4fb7-a663-7a5fdd0367a9"],
Cell[13667, 321, 1281, 31, 242, "Input",ExpressionUUID->"e0a2e6bc-cc29-4bd6-ab8d-96b8bdff199d"],
Cell[14951, 354, 2162, 48, 267, "Input",ExpressionUUID->"98ea50b6-aa9c-4c8f-b0a2-5cbe1e50e521"],
Cell[17116, 404, 496, 10, 117, "Input",ExpressionUUID->"2c70be85-305a-4b83-97f6-ad3da48e40ce"],
Cell[17615, 416, 6233, 142, 917, "Input",ExpressionUUID->"fca775ae-715e-4df6-9d33-47a215d000cb"],
Cell[23851, 560, 3774, 69, 342, "Input",ExpressionUUID->"63069bc8-1c70-4f6a-928a-164ab6584052"],
Cell[27628, 631, 27323, 564, 3651, "Input",ExpressionUUID->"dbe81886-d2da-4326-8fda-70aa5d29aa2e"],
Cell[54954, 1197, 9463, 213, 1167, "Input",ExpressionUUID->"958a6f35-679a-48a5-9f5f-200e1f79b751"],
Cell[64420, 1412, 638, 14, 117, "Input",ExpressionUUID->"f829e491-0309-4243-b5e7-d6300ff3d160"],
Cell[65061, 1428, 399, 10, 92, "Input",ExpressionUUID->"75be5180-8150-4d52-9225-ebce5d8c8afc"]
}
]
*)

