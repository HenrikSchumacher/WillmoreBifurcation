(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 11.0' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       158,          7]
NotebookDataLength[     66142,       1528]
NotebookOptionsPosition[     64915,       1505]
NotebookOutlinePosition[     65307,       1521]
CellTagsIndexPosition[     65264,       1518]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{
Cell[BoxData[
 RowBox[{"VerbatimRegion", "[", "\[IndentingNewLine]", "\n", 
  RowBox[{
   RowBox[{"mesh", "/:", 
    RowBox[{"Join", "[", "M__mesh", "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "Mlist", ",", "Plist", ",", "flistlist", ",", "accn", ",", "blink", 
        ",", "Q"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"Mlist", "=", 
        RowBox[{"List", "[", "M", "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"Plist", "=", 
        RowBox[{"Map", "[", 
         RowBox[{"VertexCoordinates", ",", "Mlist"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"flistlist", "=", 
        RowBox[{"Map", "[", 
         RowBox[{"Triangles", ",", "Mlist"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"blink", "=", 
        RowBox[{"Join", "@@", 
         RowBox[{"DeleteMissing", "[", 
          RowBox[{"Map", "[", 
           RowBox[{"BoundaryLinkData", ",", "Mlist"}], "]"}], "]"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"blink", "\[Equal]", 
          RowBox[{"{", "}"}]}], ",", " ", 
         RowBox[{"blink", "=", 
          RowBox[{"Missing", "[", "]"}]}]}], "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"accn", "=", 
        RowBox[{"Prepend", "[", 
         RowBox[{
          RowBox[{"Most", "[", 
           RowBox[{"Accumulate", "[", 
            RowBox[{"Length", "/@", "Plist"}], "]"}], "]"}], ",", "0"}], 
         "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"Q", "=", 
        RowBox[{"Init", "[", 
         RowBox[{"mesh", ",", 
          RowBox[{"Join", "@@", "Plist"}], ",", 
          RowBox[{"Join", "@@", 
           RowBox[{"(", " ", 
            RowBox[{"flistlist", "+", "accn"}], ")"}]}], ",", "blink"}], 
         "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"If", "[", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"Or", "@@", 
          RowBox[{"Map", "[", 
           RowBox[{
            RowBox[{"x", "\[Function]", 
             RowBox[{
              RowBox[{"Head", "[", "x", "]"}], "=!=", "Missing"}]}], ",", 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"Mlist", "\[LeftDoubleBracket]", 
              RowBox[{"All", ",", "1"}], "\[RightDoubleBracket]"}], 
             "\[LeftDoubleBracket]", 
             RowBox[{
             "All", ",", "\"\<PersistentCache\>\"", ",", 
              "\"\<ColorGradientValues\>\""}], "\[RightDoubleBracket]"}]}], 
           "\[IndentingNewLine]", "]"}]}], ",", "\[IndentingNewLine]", 
         RowBox[{"ColorGradient", "[", 
          RowBox[{"Q", ",", 
           RowBox[{"Catenate", "@@", 
            RowBox[{"(", 
             RowBox[{"ColorGradientValues", "/@", "Mlist"}], ")"}]}]}], 
          "]"}]}], "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"If", "[", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"And", "@@", 
          RowBox[{"Map", "[", 
           RowBox[{
            RowBox[{"x", "\[Function]", 
             RowBox[{
              RowBox[{"Head", "[", "x", "]"}], "=!=", "Missing"}]}], ",", 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"Mlist", "\[LeftDoubleBracket]", 
              RowBox[{"All", ",", "1"}], "\[RightDoubleBracket]"}], 
             "\[LeftDoubleBracket]", 
             RowBox[{
             "All", ",", "\"\<Cache\>\"", ",", "\"\<FacetNormals\>\""}], 
             "\[RightDoubleBracket]"}]}], "\[IndentingNewLine]", "]"}]}], ",",
          "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"SetCache", "[", 
           RowBox[{"Q", ",", "\"\<FacetNormals\>\"", ",", 
            RowBox[{"Join", "@@", 
             RowBox[{"(", 
              RowBox[{"FacetNormals", "/@", "Mlist"}], ")"}]}]}], "]"}], 
          ";"}]}], "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
       "Q"}]}], "\n", "]"}]}], ";"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", "]"}]], "Input",
 CellChangeTimes->{{3.631876511728125*^9, 3.631876524456629*^9}, 
   3.6327368177646227`*^9, 3.648108594528195*^9, {3.678642296822565*^9, 
   3.678642340954854*^9}, {3.678642406691132*^9, 3.678642429218403*^9}, {
   3.678682976858283*^9, 3.678683005487368*^9}, {3.683107515348898*^9, 
   3.683107535809349*^9}, {3.683107585171978*^9, 3.6831076463433847`*^9}, 
   3.6831078501345387`*^9, {3.683107946605768*^9, 3.68310795954598*^9}, {
   3.6928769838972263`*^9, 3.692877026780909*^9}, {3.692877076827239*^9, 
   3.692877079137403*^9}, {3.6928771198209352`*^9, 3.692877188204585*^9}, {
   3.707670593814032*^9, 3.7076706052834387`*^9}, {3.7079244179918747`*^9, 
   3.7079244275603533`*^9}, {3.7194991406400547`*^9, 3.719499158538994*^9}, {
   3.719499428458662*^9, 3.7194994520646467`*^9}, 3.744275941509714*^9, 
   3.744277100828763*^9},
 CellLabel->
  "In[1215]:=",ExpressionUUID->"acb2539e-e76a-4c43-b8da-6fcf358b9496"],

Cell[BoxData[
 RowBox[{
  RowBox[{"Quiet", "@", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"p", ",", "pp", ",", "q", ",", "qq"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"pp", "=", 
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{"p", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], 
         ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", "1", ",", "3"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"qq", "=", 
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{"q", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], 
         ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", "1", ",", "3"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"With", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"code", "=", 
          RowBox[{"Sqrt", "[", 
           RowBox[{"Total", "[", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{"pp", "-", "qq"}], ")"}], "^", "2"}], "]"}], "]"}]}], 
         "}"}], ",", "\[IndentingNewLine]", 
        RowBox[{"interiorQ", "=", 
         RowBox[{"CPackageFunction", "[", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"P", ",", "_Real", ",", "2"}], "}"}], ",", 
             RowBox[{"{", 
              RowBox[{"Q", ",", "_Real", ",", "2"}], "}"}], ",", 
             RowBox[{"{", 
              RowBox[{"r", ",", "_Real", ",", "1"}], "}"}]}], "}"}], ",", 
           "\[IndentingNewLine]", 
           RowBox[{"Block", "[", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"c", "=", "0"}], "}"}], ",", "\[IndentingNewLine]", 
             RowBox[{"Transpose", "[", "\[IndentingNewLine]", 
              RowBox[{"Table", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{"c", "++"}], ";", "\[IndentingNewLine]", 
                 RowBox[{"Table", "[", 
                  RowBox[{
                   RowBox[{"Boole", "[", 
                    RowBox[{"code", ">", 
                    RowBox[{
                    "r", "\[LeftDoubleBracket]", "c", 
                    "\[RightDoubleBracket]"}]}], "]"}], ",", 
                   "\[IndentingNewLine]", 
                   RowBox[{"{", 
                    RowBox[{"p", ",", "P"}], "}"}]}], "]"}]}], ",", 
                "\[IndentingNewLine]", 
                RowBox[{"{", 
                 RowBox[{"q", ",", "Q"}], "}"}]}], "]"}], 
              "\[IndentingNewLine]", "]"}]}], "]"}]}], "\[IndentingNewLine]", 
          "]"}]}]}], "\n", "]"}]}]}], "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.648107806979911*^9, 3.6481078831160316`*^9}, {
   3.6481079392158012`*^9, 3.648107971649702*^9}, {3.6481080126666927`*^9, 
   3.648108092138034*^9}, 3.648108160393559*^9, {3.6481082373655653`*^9, 
   3.6481082436986017`*^9}, 3.6481082816366377`*^9},
 CellLabel->
  "In[1216]:=",ExpressionUUID->"8793b027-c235-4b91-8309-e32af026abe3"],

Cell[BoxData[
 RowBox[{"ToleranceGlue", "=", 
  RowBox[{"PackageFunction", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"M_mesh", ",", "\[Epsilon]_"}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "plist", ",", "p", ",", "nearest", ",", "clusters", ",", "a", ",", 
        "newp", ",", "newedges", ",", "candidates", ",", 
        "\[IndentingNewLine]", "lookup", ",", "clusteredplist", ",", 
        "otherplist", ",", "newtriangles"}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"candidates", "=", 
        RowBox[{"OptionValue", "[", "\"\<Candidates\>\"", "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"VectorQ", "[", "candidates", "]"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"plist", "=", "candidates"}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"candidates", "===", "All"}], ",", "\[IndentingNewLine]", 
            
            RowBox[{"plist", "=", "All"}], ",", "\[IndentingNewLine]", 
            RowBox[{"plist", "=", 
             RowBox[{"candidates", "[", "M", "]"}]}]}], "\[IndentingNewLine]",
            "]"}], ";"}]}], "\[IndentingNewLine]", "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"p", "=", 
        RowBox[{"VertexCoordinates", "[", 
         RowBox[{"M", ",", "plist"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"clusters", "=", 
        RowBox[{"DeleteDuplicates", "[", 
         RowBox[{"Sort", "/@", 
          RowBox[{"Nearest", "[", 
           RowBox[{
            RowBox[{"p", "\[Rule]", "Automatic"}], ",", "p", ",", 
            RowBox[{"{", 
             RowBox[{"\[Infinity]", ",", "\[Epsilon]"}], "}"}]}], "]"}]}], 
         "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"lookup", "=", 
        RowBox[{"Range", "[", 
         RowBox[{"VertexCount", "[", "M", "]"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"VectorQ", "[", "plist", "]"}], ",", "\[IndentingNewLine]", 
         RowBox[{"clusteredplist", "=", 
          RowBox[{"plist", "\[LeftDoubleBracket]", 
           RowBox[{"ToPack", "[", 
            RowBox[{"Flatten", "[", "clusters", "]"}], "]"}], 
           "\[RightDoubleBracket]"}]}], ",", "\[IndentingNewLine]", 
         RowBox[{"clusteredplist", "=", 
          RowBox[{"ToPack", "[", 
           RowBox[{"Flatten", "[", "clusters", "]"}], "]"}]}]}], 
        "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"otherplist", "=", 
        RowBox[{"Complement", "[", 
         RowBox[{"lookup", ",", "clusteredplist"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
        "lookup", "\[LeftDoubleBracket]", "clusteredplist", 
         "\[RightDoubleBracket]"}], "=", 
        RowBox[{"Join", "@@", 
         RowBox[{
          RowBox[{"Compile", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{"a", ",", "_Integer", ",", "1"}], "}"}], ",", 
              RowBox[{"{", 
               RowBox[{"i", ",", "_Integer"}], "}"}]}], "}"}], ",", 
            "\[IndentingNewLine]", 
            RowBox[{"Table", "[", 
             RowBox[{"i", ",", 
              RowBox[{"{", 
               RowBox[{"j", ",", "1", ",", 
                RowBox[{"Length", "[", "a", "]"}]}], "}"}]}], "]"}], ",", 
            "\[IndentingNewLine]", 
            RowBox[{"RuntimeAttributes", "\[Rule]", 
             RowBox[{"{", "Listable", "}"}]}], ",", "\[IndentingNewLine]", 
            RowBox[{"Parallelization", "\[Rule]", "True"}]}], 
           "\[IndentingNewLine]", "]"}], "[", 
          RowBox[{"clusters", ",", 
           RowBox[{"Range", "[", 
            RowBox[{"Length", "[", "clusters", "]"}], "]"}]}], "]"}]}]}], ";",
        "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
        "lookup", "\[LeftDoubleBracket]", "otherplist", 
         "\[RightDoubleBracket]"}], "=", 
        RowBox[{"Range", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"Length", "[", "clusters", "]"}], "+", "1"}], ",", 
          RowBox[{
           RowBox[{"Length", "[", "otherplist", "]"}], "+", 
           RowBox[{"Length", "[", "clusters", "]"}]}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"newp", "=", 
        RowBox[{"Join", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{"Compile", "[", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{
               RowBox[{"{", 
                RowBox[{"p", ",", "_Real", ",", "2"}], "}"}], ",", 
               RowBox[{"{", 
                RowBox[{"idx", ",", "_Integer", ",", "1"}], "}"}]}], "}"}], 
             ",", "\[IndentingNewLine]", 
             RowBox[{"Mean", "[", 
              RowBox[{"Part", "[", 
               RowBox[{"p", ",", "idx"}], "]"}], "]"}], ",", 
             "\[IndentingNewLine]", 
             RowBox[{"RuntimeAttributes", "\[Rule]", 
              RowBox[{"{", "Listable", "}"}]}], ",", "\[IndentingNewLine]", 
             RowBox[{"Parallelization", "\[Rule]", "True"}]}], 
            "\[IndentingNewLine]", "]"}], "[", 
           RowBox[{"p", ",", "clusters"}], "]"}], ",", "\[IndentingNewLine]", 
          
          RowBox[{"VertexCoordinates", "[", 
           RowBox[{"M", ",", "otherplist"}], "]"}]}], "\[IndentingNewLine]", 
         "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"newtriangles", "=", 
        RowBox[{"Select", "[", 
         RowBox[{
          RowBox[{"Partition", "[", 
           RowBox[{
            RowBox[{"lookup", "\[LeftDoubleBracket]", 
             RowBox[{"Flatten", "[", 
              RowBox[{"Triangles", "[", "M", "]"}], "]"}], 
             "\[RightDoubleBracket]"}], ",", "3"}], "]"}], ",", 
          "DuplicateFreeQ"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"Init", "[", 
        RowBox[{"mesh", ",", "newp", ",", "newtriangles"}], "]"}]}]}], 
     "\[IndentingNewLine]", "]"}], ",", "\[IndentingNewLine]", 
    RowBox[{
    "Description", "\[Rule]", 
     "\"\<ToleranceGlue[M,\[Epsilon]] returns the mesh M with all points with \
distances < \[Epsilon] identified.\>\""}], ",", "\[IndentingNewLine]", 
    RowBox[{"Options", "\[Rule]", 
     RowBox[{"{", "\[IndentingNewLine]", 
      RowBox[{"\"\<Candidates\>\"", "\[Rule]", "BoundaryVertices"}], 
      "\[IndentingNewLine]", "}"}]}]}], "\[IndentingNewLine]", 
   "]"}]}]], "Input",
 CellChangeTimes->{{3.726837013410514*^9, 3.72683702719142*^9}, {
   3.72683822189988*^9, 3.726838225357387*^9}, 3.727340570461775*^9, {
   3.757509129609537*^9, 3.757509138551667*^9}},
 CellLabel->
  "In[1217]:=",ExpressionUUID->"548cb156-e3fa-4470-b4b7-3a03219dac9c"],

Cell[BoxData[
 RowBox[{"ToleranceGlueOld", "=", 
  RowBox[{"PackageFunction", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"M_mesh", ",", "\[Epsilon]_"}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "num", ",", "numint", ",", "oldpts", ",", "bpts", ",", "minp", ",", 
        "maxp", ",", "rangep", ",", "segments", ",", "qq", ",", "bindata", 
        ",", "neighbours", ",", "clusters", ",", "binp", ",", "binplist", ",",
         "\[Sigma]", ",", "bplist", ",", "iplist"}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"oldpts", "=", 
        RowBox[{"VertexCoordinates", "[", "M", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"num", "=", 
        RowBox[{"Length", "[", "oldpts", "]"}]}], ";", "\[IndentingNewLine]", 
       
       RowBox[{"numint", "=", 
        RowBox[{"InteriorVertexCount", "[", "M", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"num", ">", "numint"}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"bpts", "=", 
           RowBox[{"oldpts", "\[LeftDoubleBracket]", 
            RowBox[{"BoundaryVertices", "[", "M", "]"}], 
            "\[RightDoubleBracket]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"bplist", "=", 
           RowBox[{
            RowBox[{"Range", "[", "num", "]"}], "\[LeftDoubleBracket]", 
            RowBox[{"BoundaryVertices", "[", "M", "]"}], 
            "\[RightDoubleBracket]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"iplist", "=", 
           RowBox[{
            RowBox[{"Range", "[", "num", "]"}], "\[LeftDoubleBracket]", 
            RowBox[{"BoundaryVertices", "[", "M", "]"}], 
            "\[RightDoubleBracket]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"minp", "=", 
           RowBox[{
            RowBox[{"Min", "/@", 
             RowBox[{"(", 
              RowBox[{"bpts", "\[Transpose]"}], ")"}]}], "-", 
            "\[Epsilon]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"maxp", "=", 
           RowBox[{
            RowBox[{"Max", "/@", 
             RowBox[{"(", 
              RowBox[{"bpts", "\[Transpose]"}], ")"}]}], "+", 
            "\[Epsilon]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"rangep", "=", 
           RowBox[{"(", 
            RowBox[{"maxp", "-", "minp"}], ")"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"segments", "=", 
           RowBox[{"Max", "@", 
            RowBox[{"Ceiling", "[", 
             RowBox[{"rangep", "/", 
              RowBox[{"(", 
               RowBox[{"2", "\[Epsilon]"}], ")"}]}], "]"}]}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"qq", "=", 
           RowBox[{"Ceiling", "[", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{"bpts", "-", 
               RowBox[{"ConstantArray", "[", 
                RowBox[{"minp", ",", 
                 RowBox[{"Length", "[", "bpts", "]"}]}], "]"}]}], ")"}], 
             RowBox[{"ConstantArray", "[", " ", 
              RowBox[{
               RowBox[{"segments", "/", "rangep"}], ",", 
               RowBox[{"Length", "[", "bpts", "]"}]}], "]"}]}], 
            "\[IndentingNewLine]", "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"bindata", "=", 
           RowBox[{"GroupBy", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"{", 
               RowBox[{"bplist", ",", "qq"}], "}"}], "\[Transpose]"}], ",", 
             RowBox[{"Last", "\[Rule]", "First"}]}], "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"neighbours", "=", 
           RowBox[{"Flatten", "[", 
            RowBox[{
             RowBox[{"Table", "[", 
              RowBox[{
               RowBox[{"{", 
                RowBox[{"a", ",", "b", ",", "c"}], "}"}], ",", 
               RowBox[{"{", 
                RowBox[{"a", ",", 
                 RowBox[{"-", "1"}], ",", "1"}], "}"}], ",", 
               RowBox[{"{", 
                RowBox[{"b", ",", 
                 RowBox[{"-", "1"}], ",", "1"}], "}"}], ",", 
               RowBox[{"{", 
                RowBox[{"c", ",", 
                 RowBox[{"-", "1"}], ",", "1"}], "}"}]}], "]"}], ",", "2"}], 
            "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"clusters", "=", 
           RowBox[{"Union", "@@", 
            RowBox[{"Table", "[", "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{
               RowBox[{"binplist", "=", 
                RowBox[{"Union", "@@", 
                 RowBox[{"DeleteMissing", "[", 
                  RowBox[{"bindata", "/@", 
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{"ConstantArray", "[", 
                    RowBox[{"bin", ",", "27"}], "]"}], "+", "neighbours"}], 
                    ")"}]}], "]"}]}]}], ";", "\[IndentingNewLine]", 
               RowBox[{"binp", "=", 
                RowBox[{
                "oldpts", "\[LeftDoubleBracket]", "binplist", 
                 "\[RightDoubleBracket]"}]}], ";", "\[IndentingNewLine]", 
               "\[IndentingNewLine]", 
               RowBox[{"Union", "@", 
                RowBox[{"(", 
                 RowBox[{"Sort", "/@", 
                  RowBox[{
                   RowBox[{"Reap", "[", "\[IndentingNewLine]", 
                    RowBox[{"Do", "[", "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"Sow", "[", 
                    RowBox[{
                    RowBox[{
                    "binplist", "\[LeftDoubleBracket]", "i", 
                    "\[RightDoubleBracket]"}], ",", 
                    RowBox[{
                    "binplist", "\[LeftDoubleBracket]", "i", 
                    "\[RightDoubleBracket]"}]}], "]"}], ";", 
                    "\[IndentingNewLine]", 
                    RowBox[{"Do", "[", "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"cNorm", "[", 
                    RowBox[{
                    RowBox[{
                    "binp", "\[LeftDoubleBracket]", "i", 
                    "\[RightDoubleBracket]"}], "-", " ", 
                    RowBox[{
                    "binp", "\[LeftDoubleBracket]", "j", 
                    "\[RightDoubleBracket]"}]}], "]"}], "<", "\[Epsilon]"}], 
                    ",", "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"Sow", "[", 
                    RowBox[{
                    RowBox[{
                    "binplist", "\[LeftDoubleBracket]", "i", 
                    "\[RightDoubleBracket]"}], ",", 
                    RowBox[{
                    "binplist", "\[LeftDoubleBracket]", "j", 
                    "\[RightDoubleBracket]"}]}], "]"}], ";", 
                    "\[IndentingNewLine]", 
                    RowBox[{"Sow", "[", 
                    RowBox[{
                    RowBox[{
                    "binplist", "\[LeftDoubleBracket]", "j", 
                    "\[RightDoubleBracket]"}], ",", 
                    RowBox[{
                    "binplist", "\[LeftDoubleBracket]", "i", 
                    "\[RightDoubleBracket]"}]}], "]"}]}]}], 
                    "\[IndentingNewLine]", "]"}], ",", 
                    RowBox[{"{", 
                    RowBox[{"j", ",", 
                    RowBox[{"i", "+", "1"}], ",", 
                    RowBox[{"Length", "[", "binp", "]"}]}], "}"}]}], "]"}]}], 
                    "\[IndentingNewLine]", ",", 
                    RowBox[{"{", 
                    RowBox[{"i", ",", "1", ",", 
                    RowBox[{"Length", "[", "binp", "]"}]}], "}"}]}], "]"}], 
                    "\[IndentingNewLine]", "]"}], "\[LeftDoubleBracket]", "2",
                    "\[RightDoubleBracket]"}]}], ")"}]}]}], ",", 
              "\[IndentingNewLine]", 
              RowBox[{"{", 
               RowBox[{"bin", ",", 
                RowBox[{"Keys", "[", "bindata", "]"}]}], "}"}]}], "]"}]}]}], 
          ";", "\[IndentingNewLine]", 
          RowBox[{"\[Sigma]", "=", 
           RowBox[{"Association", "@", 
            RowBox[{"Join", "[", "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"Thread", "[", 
               RowBox[{
                RowBox[{"InteriorVertices", "[", "M", "]"}], "\[Rule]", 
                RowBox[{"Range", "[", "numint", "]"}]}], "]"}], ",", 
              RowBox[{"Flatten", "[", 
               RowBox[{"Thread", "/@", 
                RowBox[{"Thread", "[", 
                 RowBox[{"clusters", "\[Rule]", 
                  RowBox[{"numint", "+", 
                   RowBox[{"Range", "[", 
                    RowBox[{"Length", "[", "clusters", "]"}], "]"}]}]}], 
                 "]"}]}], "]"}]}], "\[IndentingNewLine]", "]"}]}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"Init", "[", "\[IndentingNewLine]", 
           RowBox[{"mesh", ",", "\[IndentingNewLine]", 
            RowBox[{"Join", "[", "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"oldpts", "\[LeftDoubleBracket]", 
               RowBox[{"InteriorVertices", "[", "M", "]"}], 
               "\[RightDoubleBracket]"}], ",", "\[IndentingNewLine]", 
              RowBox[{"Table", "[", 
               RowBox[{
                RowBox[{"Mean", "[", 
                 RowBox[{
                 "oldpts", "\[LeftDoubleBracket]", "plist", 
                  "\[RightDoubleBracket]"}], "]"}], ",", 
                RowBox[{"{", 
                 RowBox[{"plist", ",", "clusters"}], "}"}]}], "]"}]}], 
             "\[IndentingNewLine]", "]"}], ",", "\[IndentingNewLine]", 
            RowBox[{"Select", "[", 
             RowBox[{
              RowBox[{"Map", "[", 
               RowBox[{"\[Sigma]", ",", 
                RowBox[{"Triangles", "[", "M", "]"}], ",", 
                RowBox[{"{", "2", "}"}]}], "]"}], ",", "DuplicateFreeQ"}], 
             "]"}]}], "\[IndentingNewLine]", "]"}]}], ",", 
         "\[IndentingNewLine]", "M"}], "\[IndentingNewLine]", "]"}]}]}], 
     "\[IndentingNewLine]", "]"}], ",", "\[IndentingNewLine]", 
    RowBox[{
    "Description", "\[Rule]", 
     "\"\<ToleranceGlue[M,\[Epsilon]] returns the mesh M with all boundary \
points with distances <\[Epsilon] identified.\>\""}]}], "\[IndentingNewLine]",
    "]"}]}]], "Input",
 CellChangeTimes->{{3.638248291387027*^9, 3.6382483857943897`*^9}, {
   3.6382484227342167`*^9, 3.638248460479005*^9}, {3.638248558748488*^9, 
   3.638248596290183*^9}, {3.638248683561789*^9, 3.638248697187505*^9}, {
   3.638248752933161*^9, 3.6382487698137836`*^9}, {3.638250872028037*^9, 
   3.638250874930822*^9}, {3.638250916508926*^9, 3.638250958876638*^9}, {
   3.638251010869589*^9, 3.638251016687812*^9}, {3.638251263575371*^9, 
   3.638251263879923*^9}, {3.638252386154108*^9, 3.638252393057908*^9}, {
   3.63825264650441*^9, 3.6382526468795843`*^9}, {3.6382527112028646`*^9, 
   3.6382527829633904`*^9}, {3.638257797103359*^9, 3.638257824088893*^9}, {
   3.638257881389347*^9, 3.638257946651132*^9}, {3.638257994662808*^9, 
   3.638257994866065*^9}, {3.638258105737664*^9, 3.638258115756337*^9}, 
   3.638259713551489*^9, {3.6382618899732857`*^9, 3.638262067203704*^9}, {
   3.638262169527239*^9, 3.638262225449304*^9}, {3.638262271499701*^9, 
   3.638262362543339*^9}, {3.638262419985652*^9, 3.6382624242750473`*^9}, {
   3.638262464085609*^9, 3.638262586560906*^9}, {3.638262627473013*^9, 
   3.638262698076515*^9}, {3.6382628511584578`*^9, 3.638262852619158*^9}, 
   3.63826295365805*^9, {3.6382631647971897`*^9, 3.638263224666844*^9}, 
   3.638263418354287*^9, 3.638273054843439*^9, {3.665948994205595*^9, 
   3.665949021076219*^9}, {3.665949067543797*^9, 3.665949099110046*^9}, {
   3.665949132097209*^9, 3.665949139115779*^9}, {3.665949173890503*^9, 
   3.6659491818175*^9}, 3.6659495837969*^9, {3.66594975440602*^9, 
   3.6659497809884644`*^9}, {3.665949824673141*^9, 3.665949842351646*^9}, {
   3.665950058343768*^9, 3.66595006512718*^9}, {3.719499170622427*^9, 
   3.719499243553515*^9}, {3.7194995904587307`*^9, 3.7194996001376038`*^9}, {
   3.720114065806162*^9, 3.720114074799057*^9}, {3.7268367435500603`*^9, 
   3.726836743859826*^9}, {3.757509121389168*^9, 3.757509125841707*^9}},
 CellLabel->
  "In[1218]:=",ExpressionUUID->"aae3d950-c9b2-4c09-81be-48edf1d17810"],

Cell[BoxData[
 RowBox[{"CutHole", "=", 
  RowBox[{"PackageFunction", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"M_mesh", ",", "Q_", ",", "r_", ",", "V_"}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "P", ",", "fflist", ",", "data", ",", "intQlist", ",", "newintplist", 
        ",", "outplist", ",", "bplist", ",", "droplist", ",", "newfflist", 
        ",", "incidence2", ",", "nweP", ",", "\[Sigma]", ",", "M1", ",", 
        "newbplist", ",", "pp", ",", "newP", ",", "u", ",", "v"}], "}"}], ",",
       "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"P", "=", 
        RowBox[{"VertexCoordinates", "[", "M", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"fflist", "=", 
        RowBox[{"Triangles", "[", "M", "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"data", "=", 
        RowBox[{"interiorQ", "[", 
         RowBox[{"P", ",", "Q", ",", "r"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"intQlist", "=", 
        RowBox[{"Times", "@@@", "data"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"newintplist", "=", 
        RowBox[{"Flatten", "[", 
         RowBox[{"Position", "[", 
          RowBox[{"intQlist", ",", "1"}], "]"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"outplist", "=", 
        RowBox[{"Complement", "[", 
         RowBox[{
          RowBox[{"Range", "[", 
           RowBox[{"VertexCount", "[", "M", "]"}], "]"}], ",", 
          "newintplist"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"bplist", "=", 
        RowBox[{"Extract", "[", 
         RowBox[{"outplist", ",", 
          RowBox[{"Position", "[", 
           RowBox[{
            RowBox[{"Table", "[", 
             RowBox[{
              RowBox[{"Total", "[", 
               RowBox[{"intQlist", "[", 
                RowBox[{"[", "pnp", "]"}], "]"}], "]"}], ",", 
              RowBox[{"{", 
               RowBox[{"pnp", ",", 
                RowBox[{
                 RowBox[{"AdjacencyLists", "[", 
                  RowBox[{"M", ",", "Vertices", ",", "Vertices"}], "]"}], 
                 "\[LeftDoubleBracket]", "outplist", 
                 "\[RightDoubleBracket]"}]}], "}"}]}], "]"}], ",", 
            RowBox[{"_", "?", "Positive"}]}], "]"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"droplist", "=", 
        RowBox[{"Complement", "[", 
         RowBox[{"outplist", ",", "bplist"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"newfflist", "=", 
        RowBox[{"fflist", "\[LeftDoubleBracket]", 
         RowBox[{"DeleteCases", "[", 
          RowBox[{
           RowBox[{"Union", "@@", 
            RowBox[{
             RowBox[{"AdjacencyLists", "[", 
              RowBox[{"M", ",", "Vertices", ",", "Triangles"}], "]"}], 
             "\[LeftDoubleBracket]", "newintplist", 
             "\[RightDoubleBracket]"}]}], ",", "0"}], "]"}], 
         "\[RightDoubleBracket]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"newintplist", "=", 
        RowBox[{"Union", "[", 
         RowBox[{"newintplist", ",", "bplist"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"incidence2", "=", 
        RowBox[{"Map", "[", 
         RowBox[{
          RowBox[{"x", "\[Function]", 
           RowBox[{"Flatten", "[", 
            RowBox[{"Position", "[", 
             RowBox[{"x", ",", "0"}], "]"}], "]"}]}], ",", 
          RowBox[{
           RowBox[{"data", "[", 
            RowBox[{"[", "bplist", "]"}], "]"}], "\[Transpose]"}]}], "]"}]}], 
       ";", 
       RowBox[{"newbplist", "=", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{"bplist", "[", 
           RowBox[{"[", "ind", "]"}], "]"}], ",", 
          RowBox[{"{", 
           RowBox[{"ind", ",", "incidence2"}], "}"}]}], "]"}]}], ";", 
       RowBox[{"pp", "=", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{"Part", "[", 
           RowBox[{"P", ",", "x"}], "]"}], ",", 
          RowBox[{"{", 
           RowBox[{"x", ",", "newbplist"}], "}"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"v", "=", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"Mean", "[", 
            RowBox[{"pp", "[", 
             RowBox[{"[", "i", "]"}], "]"}], "]"}], "-", 
           RowBox[{
            RowBox[{
             RowBox[{"Q", "[", 
              RowBox[{"[", "i", "]"}], "]"}], ".", 
             RowBox[{"V", "[", 
              RowBox[{"[", "i", "]"}], "]"}]}], 
            RowBox[{"V", "[", 
             RowBox[{"[", "i", "]"}], "]"}]}]}], ",", 
          RowBox[{"{", 
           RowBox[{"i", ",", "1", ",", 
            RowBox[{"Length", "[", "Q", "]"}]}], "}"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"Do", "[", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{"P", "[", 
           RowBox[{"[", 
            RowBox[{"newbplist", "[", 
             RowBox[{"[", "i", "]"}], "]"}], "]"}], "]"}], "=", 
          "\[IndentingNewLine]", 
          RowBox[{"Table", "[", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{
             RowBox[{"u", "=", 
              RowBox[{
               RowBox[{"(", 
                RowBox[{"x", "-", 
                 RowBox[{"Q", "[", 
                  RowBox[{"[", "i", "]"}], "]"}]}], ")"}], "-", 
               RowBox[{
                RowBox[{"V", "[", 
                 RowBox[{"[", "i", "]"}], "]"}], " ", 
                RowBox[{
                 RowBox[{"V", "[", 
                  RowBox[{"[", "i", "]"}], "]"}], ".", 
                 RowBox[{"(", 
                  RowBox[{"x", "-", 
                   RowBox[{"Q", "[", 
                    RowBox[{"[", "i", "]"}], "]"}]}], ")"}]}]}]}]}], ";", 
             "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"Q", "[", 
               RowBox[{"[", "i", "]"}], "]"}], "+", 
              RowBox[{"v", "[", 
               RowBox[{"[", "i", "]"}], "]"}], "+", 
              RowBox[{
               RowBox[{"Sqrt", "[", 
                RowBox[{
                 RowBox[{
                  RowBox[{"r", "[", 
                   RowBox[{"[", "i", "]"}], "]"}], "^", "2"}], "-", 
                 RowBox[{
                  RowBox[{"v", "[", 
                   RowBox[{"[", "i", "]"}], "]"}], ".", 
                  RowBox[{"v", "[", 
                   RowBox[{"[", "i", "]"}], "]"}]}]}], "]"}], " ", 
               RowBox[{"Normalize", "[", "u", "]"}]}]}]}], ",", 
            "\[IndentingNewLine]", 
            RowBox[{"{", 
             RowBox[{"x", ",", 
              RowBox[{"pp", "[", 
               RowBox[{"[", "i", "]"}], "]"}]}], "}"}]}], "]"}]}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{"i", ",", "1", ",", 
           RowBox[{"Length", "[", "Q", "]"}]}], "}"}]}], "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"newP", "=", 
        RowBox[{"P", "[", 
         RowBox[{"[", "newintplist", "]"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Sigma]", "=", 
        RowBox[{"Association", "[", 
         RowBox[{"Thread", "[", 
          RowBox[{"newintplist", "\[Rule]", 
           RowBox[{"Range", "[", 
            RowBox[{"Length", "[", "newintplist", "]"}], "]"}]}], "]"}], 
         "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"newfflist", "=", 
        RowBox[{"Map", "[", 
         RowBox[{"\[Sigma]", ",", "newfflist", ",", 
          RowBox[{"{", "2", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"Init", "[", 
        RowBox[{"mesh", ",", "newP", ",", "newfflist"}], "]"}]}]}], 
     "\[IndentingNewLine]", "]"}], ",", "\[IndentingNewLine]", 
    RowBox[{
    "Description", "\[Rule]", 
     "\"\<CutHole[M,Q,r,V] cuts holes of radii r at points Q into M, \
adjusting the boundary curves to lie in the plane perpendicular to \
V.\>\""}]}], "\[IndentingNewLine]", "]"}]}]], "Input",
 CellChangeTimes->{{3.631876598237887*^9, 3.631876761421576*^9}, {
  3.6327367915258703`*^9, 3.6327368042696867`*^9}, {3.648108360403058*^9, 
  3.6481083723869534`*^9}, {3.648108575616899*^9, 3.648108583858327*^9}, {
  3.7194992511865*^9, 3.719499312409038*^9}, {3.720104131661068*^9, 
  3.7201041369027348`*^9}, {3.757509114590016*^9, 3.7575091185226593`*^9}, {
  3.836116179583825*^9, 
  3.8361162043861847`*^9}},ExpressionUUID->"4ba3443d-baf9-4d5f-a215-\
06f3d00e0f9c"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"MeshPart", "=", 
   RowBox[{"PackageFunction", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"M_mesh", ",", "plist_"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", "\[IndentingNewLine]", 
        RowBox[{
        "list", ",", "flist", ",", "lookuptable", ",", "newfaces", ",", 
         "newpoints"}], "\[IndentingNewLine]", "}"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"list", "=", 
         RowBox[{"Flatten", "[", "plist", "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"flist", "=", 
         RowBox[{"PositionsOfInteger", "[", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"Normal", "[", 
            RowBox[{
             RowBox[{"AdjacencyMatrix", "[", 
              RowBox[{"M", ",", "Triangles", ",", "Vertices"}], "]"}], ".", 
             RowBox[{"SparseArray", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"Partition", "[", 
                 RowBox[{"list", ",", "1"}], "]"}], "\[Rule]", "1"}], ",", 
               RowBox[{"{", 
                RowBox[{"VertexCount", "[", "M", "]"}], "}"}]}], "]"}]}], 
            "]"}], ",", "\[IndentingNewLine]", "3"}], "\[IndentingNewLine]", 
          "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"lookuptable", "=", 
         RowBox[{"Normal", "[", 
          RowBox[{"SparseArray", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"Partition", "[", 
              RowBox[{"list", ",", "1"}], "]"}], "\[Rule]", 
             RowBox[{"Range", "[", 
              RowBox[{"Length", "[", "list", "]"}], "]"}]}], ",", 
            RowBox[{"{", 
             RowBox[{"VertexCount", "[", "M", "]"}], "}"}]}], "]"}], "]"}]}], 
        ";", "\[IndentingNewLine]", 
        RowBox[{"newfaces", "=", 
         RowBox[{"Partition", "[", 
          RowBox[{
           RowBox[{"lookuptable", "\[LeftDoubleBracket]", 
            RowBox[{"Flatten", "[", 
             RowBox[{"Triangles", "[", 
              RowBox[{"M", ",", "flist"}], "]"}], "]"}], 
            "\[RightDoubleBracket]"}], ",", "3"}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"newpoints", "=", 
         RowBox[{"VertexCoordinates", "[", 
          RowBox[{"M", ",", "list"}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"Length", "[", "newfaces", "]"}], ">", "0"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"Init", "[", 
           RowBox[{"mesh", ",", "newpoints", ",", "newfaces"}], "]"}], ",", 
          "\[IndentingNewLine]", "$Failed"}], "\[IndentingNewLine]", 
         "]"}]}]}], "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", 
    "]"}]}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{"MeshRingPart", "=", 
  RowBox[{"PackageFunction", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"M_mesh", ",", "plist_", ",", "r_"}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"MeshPart", "[", 
     RowBox[{"M", ",", 
      RowBox[{"Ring", "[", 
       RowBox[{"M", ",", "plist", ",", "r"}], "]"}]}], "]"}]}], 
   "\[IndentingNewLine]", "]"}]}]}], "Input",
 CellChangeTimes->{{3.656940235057694*^9, 3.6569402695521393`*^9}, {
   3.656940760363575*^9, 3.6569408387423067`*^9}, {3.6569408929529123`*^9, 
   3.6569409370941896`*^9}, {3.656940979055209*^9, 3.656940981287511*^9}, {
   3.665933387603636*^9, 3.665933387605814*^9}, {3.7194992987944727`*^9, 
   3.7194993222776117`*^9}, 3.719499368289074*^9, {3.747667939785864*^9, 
   3.747667977358142*^9}, {3.7540525357555227`*^9, 3.7540525402227783`*^9}, 
   3.756279934527746*^9, {3.7563175010906076`*^9, 3.756317525946393*^9}, {
   3.757509109027561*^9, 3.757509110838894*^9}, {3.807164874977236*^9, 
   3.807164879596073*^9}},
 CellLabel->
  "In[1219]:=",ExpressionUUID->"4b7ff096-bb4d-496d-a385-59a356f42ff6"],

Cell[BoxData[
 RowBox[{"SeparateComponents", "=", 
  RowBox[{"PackageFunction", "[", 
   RowBox[{"M_mesh", ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"MeshPart", "[", 
       RowBox[{"M", ",", "#"}], "]"}], "&"}], "/@", 
     RowBox[{"ConnectedComponents", "[", "M", "]"}]}]}], 
   "\[IndentingNewLine]", "]"}]}]], "Input",ExpressionUUID->"3a4d5f48-f950-\
4218-a42a-7bf64cdb7c69"],

Cell[BoxData[
 RowBox[{"EdgeCut", "=", 
  RowBox[{"PackageFunction", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"M_mesh", ",", "cutelist_"}], "}"}], ",", "\[IndentingNewLine]", 
    
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "m", ",", "n", ",", "pts", ",", "cutplist", ",", "elist", ",", "VNT", 
        ",", "vt", ",", "vp", ",", "adjTT", ",", "adj", ",", "comp", ",", 
        "\[Chi]", ",", "i", ",", "j", ",", "newi", ",", "doublingQ"}], "}"}], 
      ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"doublingQ", "=", 
        RowBox[{"OptionValue", "[", "\"\<Doubling\>\"", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Length", "[", "cutelist", "]"}], ">", "0"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"pts", "=", 
           RowBox[{"VertexCoordinates", "[", "M", "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"n", "=", 
           RowBox[{"VertexCount", "[", "M", "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"m", "=", 
           RowBox[{"TriangleCount", "[", "M", "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"cutplist", "=", 
           RowBox[{"Union", "@@", 
            RowBox[{
             RowBox[{"Edges", "[", "M", "]"}], "\[LeftDoubleBracket]", 
             "cutelist", "\[RightDoubleBracket]"}]}]}], ";", 
          "\[IndentingNewLine]", "\[IndentingNewLine]", 
          RowBox[{"elist", "=", 
           RowBox[{"Complement", "[", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"Union", "@@", 
              RowBox[{
               RowBox[{
                RowBox[{"AdjacencyMatrix", "[", 
                 RowBox[{"M", ",", "Vertices", ",", "Edges"}], "]"}], 
                "\[LeftDoubleBracket]", "cutplist", "\[RightDoubleBracket]"}],
                "[", "\"\<AdjacencyLists\>\"", "]"}]}], ",", 
             "\[IndentingNewLine]", "cutelist"}], "\[IndentingNewLine]", 
            "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"VNT", "=", 
           RowBox[{
            RowBox[{
             RowBox[{"AdjacencyMatrix", "[", 
              RowBox[{"M", ",", "Vertices", ",", "Triangles"}], "]"}], 
             "\[LeftDoubleBracket]", "cutplist", "\[RightDoubleBracket]"}], 
            "[", "\"\<AdjacencyLists\>\"", "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"vt", "=", 
           RowBox[{"Join", "@@", "VNT"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"vp", "=", 
           RowBox[{"Join", "@@", 
            RowBox[{"MapThread", "[", 
             RowBox[{"ConstantArray", ",", 
              RowBox[{"{", 
               RowBox[{"cutplist", ",", 
                RowBox[{"Length", "/@", "VNT"}]}], "}"}]}], "]"}]}]}], ";", 
          "\[IndentingNewLine]", "\[IndentingNewLine]", 
          RowBox[{"adjTT", "=", 
           RowBox[{
            RowBox[{
             RowBox[{"#", "-", 
              RowBox[{"DiagonalMatrix", "[", 
               RowBox[{"Diagonal", "[", "#", "]"}], "]"}]}], "&"}], "[", 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{
              RowBox[{
               RowBox[{
                RowBox[{"#", "\[Transpose]"}], ".", "#"}], "&"}], "@", 
              "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{"AdjacencyMatrix", "[", 
                RowBox[{"M", ",", "Edges", ",", "Triangles"}], "]"}], 
               "\[LeftDoubleBracket]", "elist", "\[RightDoubleBracket]"}]}], 
             ".", 
             RowBox[{"DiagonalMatrix", "[", 
              RowBox[{"SparseArray", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{"Partition", "[", 
                  RowBox[{"vt", ",", "1"}], "]"}], "\[Rule]", "1"}], ",", 
                "m"}], "]"}], "]"}]}], "\[IndentingNewLine]", "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"adj", "=", 
           RowBox[{"Times", "[", 
            RowBox[{
             RowBox[{"adjTT", "\[LeftDoubleBracket]", 
              RowBox[{"vt", ",", "vt"}], "\[RightDoubleBracket]"}], ",", 
             RowBox[{
              RowBox[{"IdentityMatrix", "[", 
               RowBox[{"m", ",", "SparseArray"}], "]"}], 
              "\[LeftDoubleBracket]", 
              RowBox[{"vp", ",", "vp"}], "\[RightDoubleBracket]"}]}], "]"}]}],
           ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
          "\[IndentingNewLine]", 
          RowBox[{"comp", "=", 
           RowBox[{
           "SparseArray`StronglyConnectedComponents", "[", "adj", "]"}]}], 
          ";", "\[IndentingNewLine]", 
          RowBox[{"\[Chi]", "=", 
           RowBox[{"Normal", "[", 
            RowBox[{"SparseArray", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"Partition", "[", 
                RowBox[{"cutplist", ",", "1"}], "]"}], "\[Rule]", "1"}], ",", 
              
              RowBox[{"{", "n", "}"}]}], "]"}], "]"}]}], ";"}], 
         "\[IndentingNewLine]", ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"comp", "=", 
           RowBox[{"{", "}"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"\[Chi]", "=", 
           RowBox[{"ConstantArray", "[", 
            RowBox[{"0", ",", "n"}], "]"}]}], ";"}]}], "\[IndentingNewLine]", 
        "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"TrueQ", "[", "doublingQ", "]"}], ",", "\[IndentingNewLine]", 
         RowBox[{"Module", "[", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
            "Q", ",", "triangles1", ",", "triangles2", ",", "offset"}], "}"}],
            ",", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"triangles1", "=", 
             RowBox[{"Triangles", "[", "M", "]"}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"triangles2", "=", 
             RowBox[{
              RowBox[{"Reverse", "/@", 
               RowBox[{"Triangles", "[", "M", "]"}]}], "+", "n"}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"Do", "[", "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{
               RowBox[{"i", "=", 
                RowBox[{"vp", "\[LeftDoubleBracket]", 
                 RowBox[{
                 "c", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], 
                 "\[RightDoubleBracket]"}]}], ";", "\[IndentingNewLine]", 
               RowBox[{"If", "[", 
                RowBox[{
                 RowBox[{
                  RowBox[{
                  "\[Chi]", "\[LeftDoubleBracket]", "i", 
                   "\[RightDoubleBracket]"}], "\[Equal]", "1"}], ",", 
                 "\[IndentingNewLine]", 
                 RowBox[{
                  RowBox[{
                  "\[Chi]", "\[LeftDoubleBracket]", "i", 
                   "\[RightDoubleBracket]"}], "=", "0"}], 
                 "\[IndentingNewLine]", ",", "\[IndentingNewLine]", 
                 RowBox[{
                  RowBox[{"newi", "=", 
                   RowBox[{"i", "+", "n"}]}], ";", "\[IndentingNewLine]", 
                  RowBox[{"j", "=", 
                   RowBox[{
                   "vt", "\[LeftDoubleBracket]", "c", 
                    "\[RightDoubleBracket]"}]}], ";", "\[IndentingNewLine]", 
                  RowBox[{
                   RowBox[{
                   "triangles1", "\[LeftDoubleBracket]", "j", 
                    "\[RightDoubleBracket]"}], "=", 
                   RowBox[{"ToPack", "[", 
                    RowBox[{
                    RowBox[{
                    "triangles1", "\[LeftDoubleBracket]", "j", 
                    "\[RightDoubleBracket]"}], "/.", 
                    RowBox[{"i", "\[Rule]", "newi"}]}], "]"}]}], ";", 
                  "\[IndentingNewLine]", 
                  RowBox[{
                   RowBox[{
                   "triangles2", "\[LeftDoubleBracket]", "j", 
                    "\[RightDoubleBracket]"}], "=", 
                   RowBox[{"ToPack", "[", 
                    RowBox[{
                    RowBox[{
                    "triangles2", "\[LeftDoubleBracket]", "j", 
                    "\[RightDoubleBracket]"}], "/.", 
                    RowBox[{"newi", "\[Rule]", "i"}]}], "]"}]}], ";"}]}], 
                "\[IndentingNewLine]", "]"}], ";"}], "\[IndentingNewLine]", 
              ",", 
              RowBox[{"{", 
               RowBox[{"c", ",", "comp"}], "}"}]}], "]"}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"Q", "=", 
             RowBox[{"Init", "[", 
              RowBox[{"mesh", ",", 
               RowBox[{"Join", "[", 
                RowBox[{"pts", ",", "pts"}], "]"}], ",", 
               RowBox[{"Join", "[", 
                RowBox[{"triangles1", ",", "triangles2"}], "]"}]}], "]"}]}], 
            ";", "\[IndentingNewLine]", 
            RowBox[{"offset", "=", 
             RowBox[{"OptionValue", "[", "\"\<Offset\>\"", "]"}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"NumericQ", "[", "offset", "]"}], "&&", 
               RowBox[{
                RowBox[{"Abs", "[", "offset", "]"}], ">", 
                RowBox[{"10", "^", 
                 RowBox[{"-", "8"}]}]}]}], ",", "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{"If", "[", 
                RowBox[{
                 RowBox[{"!", 
                  RowBox[{"OrientedQ", "[", "Q", "]"}]}], ",", 
                 RowBox[{"Message", "[", 
                  RowBox[{"EdgeCut", "::", "notor"}], "]"}]}], "]"}], ";", 
               "\[IndentingNewLine]", 
               RowBox[{"Displace", "[", 
                RowBox[{"Q", ",", 
                 RowBox[{"offset", " ", 
                  RowBox[{"Normals", "[", "Q", "]"}]}]}], "]"}]}], ",", 
              "\[IndentingNewLine]", "Q"}], "\[IndentingNewLine]", "]"}]}]}], 
          "\[IndentingNewLine]", "]"}], "\[IndentingNewLine]", ",", 
         "\[IndentingNewLine]", 
         RowBox[{"Module", "[", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"triangles", ",", "ibag"}], "}"}], ",", 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"triangles", "=", 
             RowBox[{"Triangles", "[", "M", "]"}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"ibag", "=", 
             RowBox[{"Internal`Bag", "[", 
              RowBox[{"Most", "[", 
               RowBox[{"{", "0", "}"}], "]"}], "]"}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"Do", "[", "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{
               RowBox[{"i", "=", 
                RowBox[{"vp", "\[LeftDoubleBracket]", 
                 RowBox[{
                 "c", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], 
                 "\[RightDoubleBracket]"}]}], ";", "\[IndentingNewLine]", 
               RowBox[{"If", "[", 
                RowBox[{
                 RowBox[{
                  RowBox[{
                  "\[Chi]", "\[LeftDoubleBracket]", "i", 
                   "\[RightDoubleBracket]"}], "\[Equal]", "1"}], ",", 
                 "\[IndentingNewLine]", 
                 RowBox[{
                  RowBox[{"newi", "=", "i"}], ";", 
                  RowBox[{
                   RowBox[{
                   "\[Chi]", "\[LeftDoubleBracket]", "i", 
                    "\[RightDoubleBracket]"}], "=", "0"}]}], ",", 
                 "\[IndentingNewLine]", 
                 RowBox[{
                  RowBox[{"newi", "=", 
                   RowBox[{"++", "n"}]}], ";", 
                  RowBox[{"Internal`StuffBag", "[", 
                   RowBox[{"ibag", ",", "i"}], "]"}], ";"}]}], 
                "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
               RowBox[{"j", "=", 
                RowBox[{
                "vt", "\[LeftDoubleBracket]", "c", 
                 "\[RightDoubleBracket]"}]}], ";", "\[IndentingNewLine]", 
               RowBox[{
                RowBox[{
                "triangles", "\[LeftDoubleBracket]", "j", 
                 "\[RightDoubleBracket]"}], "=", 
                RowBox[{"ToPack", "[", 
                 RowBox[{
                  RowBox[{
                  "triangles", "\[LeftDoubleBracket]", "j", 
                   "\[RightDoubleBracket]"}], "/.", 
                  RowBox[{"i", "\[Rule]", "newi"}]}], "]"}]}]}], ",", 
              "\[IndentingNewLine]", 
              RowBox[{"{", 
               RowBox[{"c", ",", "comp"}], "}"}]}], "]"}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"Init", "[", 
             RowBox[{"mesh", ",", 
              RowBox[{"Join", "[", 
               RowBox[{"pts", ",", 
                RowBox[{"pts", "\[LeftDoubleBracket]", 
                 RowBox[{"Internal`BagPart", "[", 
                  RowBox[{"ibag", ",", "All"}], "]"}], 
                 "\[RightDoubleBracket]"}]}], "]"}], ",", "triangles"}], 
             "]"}]}]}], "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]",
         "]"}]}]}], "\[IndentingNewLine]", "]"}], ",", "\[IndentingNewLine]", 
    
    RowBox[{"Options", "\[Rule]", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"\"\<Doubling\>\"", "\[Rule]", "False"}], ",", 
       RowBox[{"\"\<Offset\>\"", "\[Rule]", "0."}]}], "}"}]}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"\"\<Warnings\>\"", "\[Rule]", 
     RowBox[{"{", 
      RowBox[{
      "\"\<notor\>\"", "\[Rule]", 
       "\"\<Doubled mesh is not oriented. Nontrivial values of  option \
\\\"Offset\\\" may lead to unexpected results.\>\""}], "\[IndentingNewLine]", 
      "}"}]}]}], "\[IndentingNewLine]", "]"}]}]], "Input",
 CellChangeTimes->{{3.757511277604542*^9, 3.757511407669036*^9}, {
   3.75751144003262*^9, 3.757511522283327*^9}, 3.7580312139987917`*^9, {
   3.758032437418242*^9, 3.758032447782634*^9}, {3.758034138114545*^9, 
   3.7580341668883553`*^9}, {3.758034239083048*^9, 3.7580344437986794`*^9}, {
   3.758034520476454*^9, 3.758034521467556*^9}, {3.758034582728306*^9, 
   3.7580346364013*^9}, {3.7580346821920013`*^9, 3.758034705773546*^9}, {
   3.758034995298855*^9, 3.758034996008584*^9}, {3.758036243531761*^9, 
   3.758036317515644*^9}, {3.758036735578116*^9, 3.7580367370469913`*^9}, {
   3.807164887851318*^9, 3.807164909995822*^9}},
 CellLabel->
  "In[1221]:=",ExpressionUUID->"7299a213-21f3-4285-b8d9-f53ce9e3388b"],

Cell[BoxData[
 RowBox[{"(*", 
  RowBox[{"EdgeCut", "=", 
   RowBox[{"PackageFunction", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"M_mesh", ",", "cutelist_"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
        "cutedges", ",", "cutplist", ",", "cuttlist", ",", "plist", ",", 
         "plookuptable", ",", "Q", ",", "subelist", ",", "AET", ",", "AVV", 
         ",", "ATT", ",", "Tcomponents", ",", "Vcomponents", ",", "AVT", ",", 
         "Qtriangles", ",", "newpts", ",", "newtriangles", ",", "r", ",", 
         "changedtriangles", ",", "componentpairs"}], "}"}], ",", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"cutedges", "=", 
         RowBox[{
          RowBox[{"Edges", "[", "M", "]"}], "\[LeftDoubleBracket]", 
          "cutelist", "\[RightDoubleBracket]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"cutplist", "=", 
         RowBox[{"DeleteDuplicates", "[", 
          RowBox[{"Sort", "[", 
           RowBox[{"Flatten", "[", "cutedges", "]"}], "]"}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"cuttlist", "=", 
         RowBox[{"Union", "@@", 
          RowBox[{
           RowBox[{
            RowBox[{"VertexTriangleAdjacencyMatrix", "[", "M", "]"}], 
            "\[LeftDoubleBracket]", "cutplist", "\[RightDoubleBracket]"}], 
           "[", "\"\<AdjacencyLists\>\"", "]"}]}]}], ";", 
        "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"plist", "=", 
         RowBox[{"Ring", "[", 
          RowBox[{"M", ",", "cutplist", ",", "1"}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"plookuptable", "=", 
         RowBox[{"AssociationThread", "[", 
          RowBox[{"plist", ",", 
           RowBox[{"Range", "[", 
            RowBox[{"Length", "[", "plist", "]"}], "]"}]}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"Q", "=", 
         RowBox[{"MeshPart", "[", 
          RowBox[{"M", ",", "plist"}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"subelist", "=", 
         RowBox[{"EdgeLookup", "[", 
          RowBox[{"Q", ",", 
           RowBox[{"Partition", "[", 
            RowBox[{
             RowBox[{"Lookup", "[", 
              RowBox[{"plookuptable", ",", 
               RowBox[{"Flatten", "[", "cutedges", "]"}]}], "]"}], ",", "2"}],
             "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
        "\[IndentingNewLine]", 
        RowBox[{"AET", "=", 
         RowBox[{
          RowBox[{"SparseArray", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"Partition", "[", 
              RowBox[{"subelist", ",", "1"}], "]"}], "\[Rule]", "0"}], ",", 
            RowBox[{"EdgeCount", "[", "Q", "]"}], ",", "1"}], "]"}], 
          RowBox[{"EdgeTriangleAdjacencyMatrix", "[", "Q", "]"}]}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"AVV", "=", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"#", "\[Transpose]"}], "+", "#"}], "&"}], "@", 
          RowBox[{"SparseArray", "[", 
           RowBox[{
            RowBox[{
             RowBox[{
              RowBox[{"Edges", "[", "Q", "]"}], "\[LeftDoubleBracket]", 
              "subelist", "\[RightDoubleBracket]"}], "\[Rule]", "1"}], ",", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"1", ",", "1"}], "}"}], 
             RowBox[{"VertexCount", "[", "Q", "]"}]}]}], "]"}]}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"ATT", "=", 
         RowBox[{"SparseArray", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"#", "-", 
             RowBox[{"DiagonalMatrix", "[", 
              RowBox[{"Diagonal", "[", "#", "]"}], "]"}]}], "&"}], "[", 
           RowBox[{
            RowBox[{"AET", "\[Transpose]"}], ".", "AET"}], "]"}], "]"}]}], 
        ";", "\[IndentingNewLine]", 
        RowBox[{"Tcomponents", "=", 
         RowBox[{
         "SparseArray`StronglyConnectedComponents", "[", "ATT", "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"Vcomponents", "=", 
         RowBox[{"ConnectedComponents", "[", "Q", "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"AVT", "=", 
         RowBox[{"VertexTriangleAdjacencyMatrix", "[", "Q", "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"componentpairs", "=", 
         RowBox[{"Table", "[", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"With", "[", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"tt", "=", 
               RowBox[{"Union", "@@", 
                RowBox[{
                 RowBox[{
                 "AVT", "\[LeftDoubleBracket]", "v", 
                  "\[RightDoubleBracket]"}], "[", "\"\<AdjacencyLists\>\"", 
                 "]"}]}]}], "}"}], ",", "\[IndentingNewLine]", 
             RowBox[{"Select", "[", 
              RowBox[{"Tcomponents", ",", 
               RowBox[{
                RowBox[{"IntersectingQ", "[", 
                 RowBox[{"tt", ",", "#"}], "]"}], "&"}]}], "]"}]}], 
            "\[IndentingNewLine]", "]"}], "\[IndentingNewLine]", ",", 
           RowBox[{"{", 
            RowBox[{"v", ",", "Vcomponents"}], "}"}]}], "]"}]}], ";", 
        "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"Qtriangles", "=", 
         RowBox[{"Triangles", "[", "Q", "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"newpts", "=", 
         RowBox[{"Join", "[", 
          RowBox[{
           RowBox[{"VertexCoordinates", "[", "M", "]"}], ",", 
           RowBox[{
            RowBox[{"VertexCoordinates", "[", "M", "]"}], 
            "\[LeftDoubleBracket]", "cutplist", "\[RightDoubleBracket]"}]}], 
          "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"newtriangles", "=", 
         RowBox[{"Triangles", "[", "M", "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"r", "=", 
         RowBox[{"Dispatch", "[", 
          RowBox[{"Thread", "[", 
           RowBox[{"cutplist", "\[Rule]", 
            RowBox[{"Range", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"VertexCount", "[", "M", "]"}], "+", "1"}], ",", 
              RowBox[{
               RowBox[{"VertexCount", "[", "M", "]"}], "+", 
               RowBox[{"Length", "[", "cutplist", "]"}]}]}], "]"}]}], "]"}], 
          "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"Do", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{"changedtriangles", "=", 
            RowBox[{"Partition", "[", 
             RowBox[{
              RowBox[{"plist", "\[LeftDoubleBracket]", 
               RowBox[{"Flatten", "[", 
                RowBox[{
                "Qtriangles", "\[LeftDoubleBracket]", "comp", 
                 "\[RightDoubleBracket]"}], "]"}], "\[RightDoubleBracket]"}], 
              ",", "3"}], "]"}]}], ";", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"newtriangles", "\[LeftDoubleBracket]", 
             RowBox[{"TriangleLookup", "[", 
              RowBox[{"M", ",", "changedtriangles"}], "]"}], 
             "\[RightDoubleBracket]"}], "=", 
            RowBox[{"changedtriangles", "/.", "r"}]}]}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"{", 
           RowBox[{"comp", ",", 
            RowBox[{"componentpairs", "\[LeftDoubleBracket]", 
             RowBox[{"All", ",", "2"}], "\[RightDoubleBracket]"}]}], "}"}]}], 
         "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"Init", "[", 
         RowBox[{"mesh", ",", " ", "newpts", ",", "newtriangles"}], "]"}]}]}],
       "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", "]"}]}], 
  "*)"}]], "Input",
 CellChangeTimes->{{3.757511277604542*^9, 3.757511407669036*^9}, {
  3.75751144003262*^9, 3.757511522283327*^9}},
 CellLabel->
  "In[409]:=",ExpressionUUID->"6eb6df3a-ed76-4bde-b84f-96fbbc1cd977"],

Cell[BoxData[
 RowBox[{"ScrambleMesh", "=", 
  RowBox[{"PackageFunction", "[", 
   RowBox[{"M_mesh", ",", "\[IndentingNewLine]", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"perm", ",", "perminv"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"perm", "=", 
        RowBox[{"RandomSample", "[", 
         RowBox[{"1", ";;", 
          RowBox[{"VertexCount", "[", "M", "]"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"perminv", "=", 
        RowBox[{"InversePermutation", "[", "perm", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"Orient", "@", 
        RowBox[{"Init", "[", 
         RowBox[{"mesh", ",", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"VertexCoordinates", "[", "M", "]"}], 
           "\[LeftDoubleBracket]", "perm", "\[RightDoubleBracket]"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"Partition", "[", 
           RowBox[{
            RowBox[{"perminv", "\[LeftDoubleBracket]", 
             RowBox[{"Flatten", "[", 
              RowBox[{
               RowBox[{"Triangles", "[", "M", "]"}], "\[LeftDoubleBracket]", 
               RowBox[{"RandomSample", "[", 
                RowBox[{"1", ";;", 
                 RowBox[{"TriangleCount", "[", "M", "]"}]}], "]"}], 
               "\[RightDoubleBracket]"}], "]"}], "\[RightDoubleBracket]"}], 
            ",", "3"}], "]"}]}], "\[IndentingNewLine]", "]"}]}]}]}], 
     "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", "]"}]}]], "Input",\

 CellChangeTimes->{{3.814935880579558*^9, 3.814935888265299*^9}},
 CellLabel->
  "In[412]:=",ExpressionUUID->"0a4b31d0-8822-4890-970d-6e040b936ac1"]
},
WindowSize->{1440, 851},
WindowMargins->{{0, Automatic}, {Automatic, 0}},
FrontEndVersion->"12.3 for Mac OS X x86 (64-bit) (June 19, 2021)",
StyleDefinitions->"Default.nb",
ExpressionUUID->"07910691-057d-4ac7-962d-6c50b4294451"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[558, 20, 4969, 112, 667, "Input",ExpressionUUID->"acb2539e-e76a-4c43-b8da-6fcf358b9496"],
Cell[5530, 134, 3036, 76, 367, "Input",ExpressionUUID->"8793b027-c235-4b91-8309-e32af026abe3"],
Cell[8569, 212, 6962, 160, 1117, "Input",ExpressionUUID->"548cb156-e3fa-4470-b4b7-3a03219dac9c"],
Cell[15534, 374, 12431, 263, 1267, "Input",ExpressionUUID->"aae3d950-c9b2-4c09-81be-48edf1d17810"],
Cell[27968, 639, 8452, 207, 917, "Input",ExpressionUUID->"4ba3443d-baf9-4d5f-a215-06f3d00e0f9c"],
Cell[36423, 848, 3931, 88, 567, "Input",ExpressionUUID->"4b7ff096-bb4d-496d-a385-59a356f42ff6"],
Cell[40357, 938, 407, 10, 92, "Input",ExpressionUUID->"3a4d5f48-f950-4218-a42a-7bf64cdb7c69"],
Cell[40767, 950, 14563, 329, 1967, "Input",ExpressionUUID->"7299a213-21f3-4285-b8d9-f53ce9e3388b"],
Cell[55333, 1281, 7888, 181, 942, "Input",ExpressionUUID->"6eb6df3a-ed76-4bde-b84f-96fbbc1cd977"],
Cell[63224, 1464, 1687, 39, 267, "Input",ExpressionUUID->"0a4b31d0-8822-4890-970d-6e040b936ac1"]
}
]
*)

