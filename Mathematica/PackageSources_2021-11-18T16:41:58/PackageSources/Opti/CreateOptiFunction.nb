Notebook[{Cell[BoxData[RowBox[{"CreateOptiFunction", "=", 
      RowBox[{"PackageFunction", "[", 
        RowBox[{RowBox[{"{", RowBox[{"name_", ",", "f_", ",", "numargs_"}], 
            "}"}], ",", "\[IndentingNewLine]", RowBox[{"With", "[", 
            RowBox[{RowBox[{"{", RowBox[{"Call", "=", RowBox[{"If", "[", 
                    RowBox[{RowBox[{"OptionValue", "[", "\"Compiled\"", 
                        "]"}], ",", "\[IndentingNewLine]", 
                      "CreateCompiledOptiFunction", ",", 
                      "\[IndentingNewLine]", 
                      "CreateUncompiledOptiFunction"}], 
                    "\[IndentingNewLine]", "]"}]}], "}"}], ",", 
              "\[IndentingNewLine]", RowBox[{"Call", "[", RowBox[
                 {"name", ",", "f", ",", "numargs", ",", 
                  "\[IndentingNewLine]", RowBox[{"\"InputType\"", "\[Rule]", 
                    RowBox[{"OptionValue", "[", "\"InputType\"", "]"}]}], 
                  ",", "\[IndentingNewLine]", RowBox[{"\"Derivatives\"", 
                    "\[Rule]", RowBox[{"OptionValue", "[", "\"Derivatives\"", 
                      "]"}]}], ",", "\[IndentingNewLine]", RowBox[
                   {"\"Caching\"", "\[Rule]", RowBox[{"OptionValue", "[", 
                      "\"Caching\"", "]"}]}]}], "\[IndentingNewLine]", 
                "]"}]}], "]"}], ",", "\[IndentingNewLine]", 
          RowBox[{"\"Options\"", "\[Rule]", RowBox[
             {"{", "\[IndentingNewLine]", RowBox[{RowBox[{"\"InputType\"", 
                  "\[Rule]", "point"}], ",", "\[IndentingNewLine]", 
                RowBox[{"\"Derivatives\"", "\[Rule]", "2"}], ",", 
                "\[IndentingNewLine]", RowBox[{"\"Caching\"", "\[Rule]", 
                  "True"}], ",", "\[IndentingNewLine]", RowBox[
                 {"\"Compiled\"", "\[Rule]", "False"}]}], 
              "\[IndentingNewLine]", "}"}]}]}], "\[IndentingNewLine]", 
        "]"}]}]], "Input", CellChangeTimes -> 
    {{3.649257514385476*^9, 3.649257718577643*^9}, {3.6492580481014433*^9, 
      3.649258053345605*^9}}], 
  Cell[BoxData[RowBox[{"CreateUncompiledOptiFunction", "=", 
      RowBox[{"PackageFunction", "[", 
        RowBox[{RowBox[{"{", RowBox[{"name_", ",", "f_", ",", "numargs_"}], 
            "}"}], ",", "\[IndentingNewLine]", RowBox[{"Quiet", "[", 
            RowBox[{"Block", "[", RowBox[{RowBox[{"{", RowBox[{"Limbo`X", 
                    ",", "XX"}], "}"}], ",", "\[IndentingNewLine]", 
                RowBox[{RowBox[{"XX", "=", RowBox[{"Table", "[", RowBox[
                       {RowBox[{"Limbo`X", "\[LeftDoubleBracket]", "i", 
                          "\[RightDoubleBracket]"}], ",", RowBox[{"{", 
                          RowBox[{"i", ",", "1", ",", "numargs"}], "}"}]}], 
                      "]"}]}], ";", "\[IndentingNewLine]", RowBox[{"Do", "[", 
                    "\[IndentingNewLine]", RowBox[{RowBox[{"With", "[", 
                        RowBox[{RowBox[{"{", RowBox[{"code", "=", RowBox[
                          {"ToString", "[", RowBox[{RowBox[{"D", "[", RowBox[
                          {RowBox[{"f", "[", "XX", "]"}], ",", RowBox[{"{", 
                          RowBox[{"XX", ",", "i"}], "}"}]}], "]"}], ",", 
                          "InputForm"}], "]"}]}], "}"}], ",", 
                          "\[IndentingNewLine]", RowBox[{"ToExpression", "[", 
                          "\[IndentingNewLine]", RowBox[{RowBox[
                          {"StringJoin", "[", RowBox[{"ConstantArray", "[", 
                          RowBox[{"\"D\"", ",", "i"}], "]"}], "]"}], "<>", 
                          "name", "<>", "\"=PackageFunction[P_,\
\[IndentingNewLine]With[{Limbo`X=getc[P]},\n\"", "<>", "code", "<>", 
                          "\"\n],\n\\\"InputType\\\"\[Rule]\"", "<>", RowBox[
                          {"ToString", "[", RowBox[{"OptionValue", "[", 
                          "\"InputType\"", "]"}], "]"}], "<>", 
                          "\",\n\\\"Caching\\\"\[Rule]\"", "<>", RowBox[
                          {"ToString", "[", RowBox[{"OptionValue", "[", 
                          "\"Caching\"", "]"}], "]"}], "<>", "\"\n]\""}], 
                          "\[IndentingNewLine]", "]"}]}], "]"}], ",", 
                      RowBox[{"{", RowBox[{"i", ",", "0", ",", RowBox[
                          {"OptionValue", "[", "\"Derivatives\"", "]"}]}], 
                        "}"}]}], "]"}], ";", "\[IndentingNewLine]", 
                  RowBox[{"Do", "[", "\[IndentingNewLine]", RowBox[
                     {RowBox[{"ToExpression", "[", "\[IndentingNewLine]", 
                        RowBox[{"\"Derivative[\"", "<>", RowBox[{"ToString", 
                          "[", "i", "]"}], "<>", "\"][\"", "<>", RowBox[
                          {"StringJoin", "[", RowBox[{"ConstantArray", "[", 
                          RowBox[{"\"D\"", ",", "j"}], "]"}], "]"}], "<>", 
                          "name", "<>", "\"]:=\"", "<>", RowBox[
                          {"StringJoin", "[", RowBox[{"ConstantArray", "[", 
                          RowBox[{"\"D\"", ",", RowBox[{"j", "+", "i"}]}], 
                          "]"}], "]"}], "<>", "name"}], 
                        "\[IndentingNewLine]", "]"}], ",", 
                      "\[IndentingNewLine]", RowBox[{"{", RowBox[{"j", ",", 
                          "0", ",", RowBox[{"OptionValue", "[", 
                          "\"Derivatives\"", "]"}]}], "}"}], ",", RowBox[
                       {"{", RowBox[{"i", ",", "1", ",", RowBox[{RowBox[
                          {"OptionValue", "[", "\"Derivatives\"", "]"}], "-", 
                          "j"}]}], "}"}]}], "]"}], ";"}]}], 
              "\[IndentingNewLine]", "]"}], "]"}], ",", 
          "\[IndentingNewLine]", RowBox[{"\"Options\"", "\[Rule]", 
            RowBox[{"{", "\[IndentingNewLine]", RowBox[{RowBox[
                 {"\"InputType\"", "\[Rule]", "point"}], ",", 
                "\[IndentingNewLine]", RowBox[{"\"Derivatives\"", "\[Rule]", 
                  "2"}], ",", "\[IndentingNewLine]", RowBox[{"\"Caching\"", 
                  "\[Rule]", "True"}]}], "\[IndentingNewLine]", "}"}]}]}], 
        "\[IndentingNewLine]", "]"}]}]], "Input", 
   CellChangeTimes -> {{3.6492417713036547*^9, 3.649241772445383*^9}, 
     {3.649241997872169*^9, 3.6492420246707773*^9}, 3.649243373382228*^9, 
     {3.6492434892737713*^9, 3.649243489620409*^9}, 
     {3.649257364551869*^9, 3.649257389124425*^9}, {3.649257450529394*^9, 
      3.649257495649497*^9}}], 
  Cell[BoxData[RowBox[{"CreateCompiledOptiFunction", "=", 
      RowBox[{"PackageFunction", "[", 
        RowBox[{RowBox[{"{", RowBox[{"name_", ",", "f_", ",", "numargs_"}], 
            "}"}], ",", "\[IndentingNewLine]", RowBox[{"Quiet", "[", 
            RowBox[{"Block", "[", RowBox[{RowBox[{"{", RowBox[{"Limbo`X", 
                    ",", "XX"}], "}"}], ",", "\[IndentingNewLine]", 
                RowBox[{RowBox[{"XX", "=", RowBox[{"Table", "[", RowBox[
                       {RowBox[{"Limbo`X", "\[LeftDoubleBracket]", "i", 
                          "\[RightDoubleBracket]"}], ",", RowBox[{"{", 
                          RowBox[{"i", ",", "1", ",", "numargs"}], "}"}]}], 
                      "]"}]}], ";", "\[IndentingNewLine]", RowBox[{"Do", "[", 
                    "\[IndentingNewLine]", RowBox[{RowBox[{RowBox[{"With", 
                          "[", RowBox[{RowBox[{"{", RowBox[{"code", "=", 
                          RowBox[{"ToString", "[", RowBox[{RowBox[{"N", "[", 
                          RowBox[{"D", "[", RowBox[{RowBox[{"f", "[", "XX", 
                          "]"}], ",", RowBox[{"{", RowBox[{"XX", ",", "i"}], 
                          "}"}]}], "]"}], "]"}], ",", "InputForm"}], "]"}]}], 
                          "}"}], ",", "\[IndentingNewLine]", RowBox[
                          {"ToExpression", "[", "\[IndentingNewLine]", 
                          RowBox[{"\"get\"", "<>", RowBox[{"StringJoin", "[", 
                          RowBox[{"ConstantArray", "[", RowBox[{"\"D\"", ",", 
                          "i"}], "]"}], "]"}], "<>", "name", "<>", 
                          "\"=CPackageFunction[\n{{Limbo`X,_Real,1}},\n\"", 
                          "<>", "code", "<>", "\"\n]\""}], "]"}]}], 
                          "\[IndentingNewLine]", "]"}], ";", 
                        "\[IndentingNewLine]", RowBox[{"ToExpression", "[", 
                          "\[IndentingNewLine]", RowBox[{RowBox[
                          {"StringJoin", "[", RowBox[{"ConstantArray", "[", 
                          RowBox[{"\"D\"", ",", "i"}], "]"}], "]"}], "<>", 
                          "name", "<>", "\"=PackageFunction[P_,\nget\"", 
                          "<>", RowBox[{"StringJoin", "[", RowBox[
                          {"ConstantArray", "[", RowBox[{"\"D\"", ",", "i"}], 
                          "]"}], "]"}], "<>", "name", "<>", 
                          "\"[getc[P]],\n\\\"InputType\\\"\[Rule]\"", "<>", 
                          RowBox[{"ToString", "[", RowBox[{"OptionValue", 
                          "[", "\"InputType\"", "]"}], "]"}], "<>", 
                          "\",\n\\\"Caching\\\"\[Rule]\"", "<>", RowBox[
                          {"ToString", "[", RowBox[{"OptionValue", "[", 
                          "\"Caching\"", "]"}], "]"}], "<>", "\"\n]\""}], 
                          "\[IndentingNewLine]", "]"}], ";"}], 
                      "\[IndentingNewLine]", ",", RowBox[{"{", RowBox[
                         {"i", ",", "0", ",", RowBox[{"OptionValue", "[", 
                          "\"Derivatives\"", "]"}]}], "}"}]}], "]"}], ";", 
                  "\[IndentingNewLine]", RowBox[{"Do", "[", 
                    "\[IndentingNewLine]", RowBox[{RowBox[{"ToExpression", 
                        "[", "\[IndentingNewLine]", RowBox[
                         {"\"Derivative[\"", "<>", RowBox[{"ToString", "[", 
                          "i", "]"}], "<>", "\"][\"", "<>", RowBox[
                          {"StringJoin", "[", RowBox[{"ConstantArray", "[", 
                          RowBox[{"\"D\"", ",", "j"}], "]"}], "]"}], "<>", 
                          "name", "<>", "\"]:=\"", "<>", RowBox[
                          {"StringJoin", "[", RowBox[{"ConstantArray", "[", 
                          RowBox[{"\"D\"", ",", RowBox[{"j", "+", "i"}]}], 
                          "]"}], "]"}], "<>", "name"}], 
                        "\[IndentingNewLine]", "]"}], ",", 
                      "\[IndentingNewLine]", RowBox[{"{", RowBox[{"j", ",", 
                          "0", ",", RowBox[{"OptionValue", "[", 
                          "\"Derivatives\"", "]"}]}], "}"}], ",", RowBox[
                       {"{", RowBox[{"i", ",", "1", ",", RowBox[{RowBox[
                          {"OptionValue", "[", "\"Derivatives\"", "]"}], "-", 
                          "j"}]}], "}"}]}], "]"}], ";"}]}], 
              "\[IndentingNewLine]", "]"}], "]"}], ",", 
          "\[IndentingNewLine]", RowBox[{"\"Options\"", "\[Rule]", 
            RowBox[{"{", "\[IndentingNewLine]", RowBox[{RowBox[
                 {"\"InputType\"", "\[Rule]", "point"}], ",", 
                "\[IndentingNewLine]", RowBox[{"\"Derivatives\"", "\[Rule]", 
                  "2"}], ",", "\[IndentingNewLine]", RowBox[{"\"Caching\"", 
                  "\[Rule]", "True"}]}], "\[IndentingNewLine]", "}"}]}]}], 
        "\[IndentingNewLine]", "]"}]}]], "Input", 
   CellChangeTimes -> {{3.6492417713036547*^9, 3.649241772445383*^9}, 
     {3.649241997872169*^9, 3.6492420246707773*^9}, 3.649243373382228*^9, 
     {3.6492434892737713*^9, 3.649243489620409*^9}, 
     {3.6492564528202343*^9, 3.6492564605930443*^9}, 
     {3.649256879269876*^9, 3.649256951506913*^9}, 3.6492570081591387*^9, 
     3.649257055867437*^9, {3.6492570923107967*^9, 3.649257136535527*^9}, 
     {3.649257202061503*^9, 3.6492572052550097*^9}, 
     {3.649257264497424*^9, 3.649257298093004*^9}, {3.649257374010606*^9, 
      3.649257374293714*^9}, {3.649257410196396*^9, 
      3.6492574388617773*^9}}]}, WindowSize -> {1100, 852}, 
 WindowMargins -> {{Automatic, 0}, {Automatic, 0}}, 
 FrontEndVersion -> 
  "10.0 for Mac OS X x86 (32-bit, 64-bit Kernel) (December 4, 2014)", 
 StyleDefinitions -> "Default.nb"]
