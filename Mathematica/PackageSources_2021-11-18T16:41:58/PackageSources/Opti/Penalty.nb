Notebook[{Cell[BoxData[RowBox[{"VerbatimRegion", "[", "\[IndentingNewLine]", 
      RowBox[{RowBox[{RowBox[{"PenaltyFunction", "::", "usage"}], "=", "\"Fun\
ction reserved for the penalty function in the optimization tool \
PenaltyMethod.\""}], ";", "\[IndentingNewLine]", 
        RowBox[{RowBox[{"DPenaltyFunction", "::", "usage"}], "=", "\"Function \
reserved for the derivative of the penalty function in the optimization tool \
PenaltyMethod.\""}], ";", "\[IndentingNewLine]", 
        RowBox[{"ToExpression", "[", 
          "\"Derivative[1][PenaltyFunction]:=DPenaltyFunction\"", 
          "\[IndentingNewLine]", "]"}], ";"}], "\[IndentingNewLine]", "]"}]], 
   "Input", CellChangeTimes -> {{3.649243078145607*^9, 3.649243081392885*^9}, 
     {3.649243135785408*^9, 3.649243142540309*^9}, {3.6492431738217278*^9, 
      3.649243180994513*^9}, {3.649243252025744*^9, 3.649243326126535*^9}}], 
  Cell[BoxData[RowBox[{"PenaltyMethod", "=", 
      RowBox[{"PackageFunction", "[", 
        RowBox[{RowBox[{"{", RowBox[{"x0_", ",", "fun_", ",", "gun_", ",", 
              "hun_"}], "}"}], ",", "\[IndentingNewLine]", 
          RowBox[{"Module", "[", RowBox[{RowBox[{"{", "\[IndentingNewLine]", 
                RowBox[{RowBox[{"residue", "=", "\[Infinity]"}], ",", 
                  "\[IndentingNewLine]", RowBox[{"residuelist", "=", 
                    RowBox[{"{", "\[Infinity]", "}"}]}], ",", 
                  "\[IndentingNewLine]", RowBox[{"\[Sigma]", "=", RowBox[
                     {"OptionValue", "[", "\"Scale\[Alpha]\"", "]"}]}], ",", 
                  "\[IndentingNewLine]", RowBox[{"\[Alpha]", "=", RowBox[
                     {"OptionValue", "[", "\"Initial\[Alpha]\"", "]"}]}], 
                  ",", "\[IndentingNewLine]", RowBox[{"\[Alpha]list", "=", 
                    RowBox[{"{", RowBox[{"OptionValue", "[", 
                        "\"Initial\[Alpha]\"", "]"}], "}"}]}], ",", 
                  "\[IndentingNewLine]", RowBox[{"TOL1", "=", RowBox[
                     {"OptionValue", "[", "\"AccuracyGoal\"", "]"}]}], ",", 
                  "\[IndentingNewLine]", RowBox[{"TOL2", "=", RowBox[
                     {"OptionValue", "[", "\"InternalAccuracyGoal\"", 
                      "]"}]}], ",", "\[IndentingNewLine]", RowBox[{"iter", 
                    "=", "0"}], ",", "\[IndentingNewLine]", "x", ",", 
                  "xlist", ",", "funlist"}], "\[IndentingNewLine]", "}"}], 
              ",", "\[IndentingNewLine]", RowBox[{RowBox[{"x", 
                  "\[LeftArrow]", "x0"}], ";", "\[IndentingNewLine]", 
                RowBox[{"xlist", "=", RowBox[{"{", RowBox[{"getc", "[", "x", 
                      "]"}], "}"}]}], ";", "\[IndentingNewLine]", 
                RowBox[{"funlist", "=", RowBox[{"{", RowBox[{"fun", "[", "x", 
                      "]"}], "}"}]}], ";", "\[IndentingNewLine]", 
                RowBox[{"While", "[", RowBox[{RowBox[{RowBox[{"residue", ">", 
                        "TOL1"}], "&&", RowBox[{"iter", "<", RowBox[
                         {"OptionValue", "[", "\"MaxIterations\"", "]"}]}]}], 
                    ",", "\[IndentingNewLine]", RowBox[{RowBox[{"iter", 
                        "++"}], ";", "\[IndentingNewLine]", RowBox[
                       {"PenaltyFunction", "=", RowBox[{"PackageFunction", 
                          "[", RowBox[{"x_", ",", "\[IndentingNewLine]", 
                          RowBox[{RowBox[{"fun", "[", "x", "]"}], " ", "+", 
                          RowBox[{RowBox[{"\[Alpha]", "/", "2"}], RowBox[
                          {"Total", "[", RowBox[{RowBox[{"cMax0", "[", RowBox[
                          {"gun", "[", "x", "]"}], "]"}], "^", "2"}], 
                          "]"}]}], "+", RowBox[{RowBox[{"\[Alpha]", "/", 
                          "2"}], " ", RowBox[{RowBox[{"hun", "[", "x", "]"}], 
                          ".", RowBox[{"hun", "[", "x", "]"}]}]}]}], ",", 
                          "\[IndentingNewLine]", RowBox[{"\"InputType\"", 
                          "\[Rule]", " ", "point"}]}], "\[IndentingNewLine]", 
                          "]"}]}], ";", "\[IndentingNewLine]", 
                      "\[IndentingNewLine]", RowBox[{"DPenaltyFunction", "=", 
                        RowBox[{"PackageFunction", "[", RowBox[{"x_", ",", 
                          "\[IndentingNewLine]", RowBox[{RowBox[{RowBox[
                          {"fun", "'"}], "[", "x", "]"}], " ", "+", RowBox[
                          {"\[Alpha]", " ", RowBox[{RowBox[{"cMax0", "[", 
                          RowBox[{"gun", "[", "x", "]"}], "]"}], ".", RowBox[
                          {RowBox[{"gun", "'"}], "[", "x", "]"}]}]}], "+", 
                          RowBox[{"\[Alpha]", " ", RowBox[{RowBox[{"hun", 
                          "[", "x", "]"}], ".", RowBox[{RowBox[{"hun", "'"}], 
                          "[", "x", "]"}]}]}]}], ",", "\[IndentingNewLine]", 
                          RowBox[{"\"InputType\"", "\[Rule]", " ", 
                          "point"}]}], "\[IndentingNewLine]", "]"}]}], ";", 
                      "\[IndentingNewLine]", "\[IndentingNewLine]", 
                      RowBox[{"x", "\[LeftArrow]", RowBox[{"ModelAlgorithm", 
                          "[", RowBox[{"x", ",", "PenaltyFunction", ",", 
                          "\[IndentingNewLine]", RowBox[{"\"MaxIterations\"", 
                          "\[Rule]", "100"}], ",", "\[IndentingNewLine]", 
                          RowBox[{"\"SearchDirection\"", "\[Rule]", RowBox[
                          {"{", RowBox[{"\"LBFGS\"", ",", RowBox[
                          {"\"MaxHistoryLength\"", "\[Rule]", "20"}]}], 
                          "}"}]}], ",", "\[IndentingNewLine]", RowBox[
                          {"\"AccuracyGoal\"", "\[Rule]", RowBox[{"TOL2", 
                          "/", "\[Alpha]"}]}], ",", "\[IndentingNewLine]", 
                          RowBox[{"\"HistoryFunctions\"", "\[Rule]", RowBox[
                          {"{", "getc", "}"}]}]}], "\[IndentingNewLine]", 
                          "]"}]}], ";", "\[IndentingNewLine]", RowBox[
                       {"\[Alpha]", "=", RowBox[{"\[Sigma]", " ", 
                          "\[Alpha]"}]}], ";", "\[IndentingNewLine]", 
                      RowBox[{"AppendTo", "[", RowBox[{"xlist", ",", RowBox[
                          {"getc", "[", "x", "]"}]}], "]"}], ";", 
                      "\[IndentingNewLine]", RowBox[{"residue", "=", 
                        RowBox[{RowBox[{"cMaxNonnegative", "[", RowBox[
                          {"gun", "[", "x", "]"}], "]"}], "+", RowBox[{"Max", 
                          "[", RowBox[{"0.", ",", RowBox[{"Max", "[", RowBox[
                          {"Abs", "[", RowBox[{"hun", "[", "x", "]"}], "]"}], 
                          "]"}]}], "]"}]}]}], ";", "\[IndentingNewLine]", 
                      RowBox[{"AppendTo", "[", RowBox[{"residuelist", ",", 
                          "residue"}], "]"}], ";", "\[IndentingNewLine]", 
                      RowBox[{"AppendTo", "[", RowBox[{"\[Alpha]list", ",", 
                          "\[Alpha]"}], "]"}], ";", "\[IndentingNewLine]", 
                      RowBox[{"AppendTo", "[", RowBox[{"funlist", ",", 
                          RowBox[{"fun", "[", "x", "]"}]}], "]"}], ";"}]}], 
                  "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
                RowBox[{"SetCache", "[", RowBox[{"x", ",", 
                    "\"PenaltyMethodData\"", ",", RowBox[{"Association", "[", 
                      "\[IndentingNewLine]", RowBox[{RowBox[{"\"Iterates\"", 
                          "\[Rule]", "xlist"}], ",", "\[IndentingNewLine]", 
                        RowBox[{"\"FunctionValues\"", "\[Rule]", "funlist"}], 
                        ",", "\[IndentingNewLine]", RowBox[{"\"Residues\"", 
                          "\[Rule]", "residuelist"}], ",", 
                        "\[IndentingNewLine]", RowBox[{"\"\[Alpha]\"", 
                          "\[Rule]", "\[Alpha]list"}]}], 
                      "\[IndentingNewLine]", "]"}]}], "]"}], ";", 
                "\[IndentingNewLine]", "x"}]}], "\[IndentingNewLine]", 
            "\[IndentingNewLine]", "]"}], ",", "\[IndentingNewLine]", 
          RowBox[{"\"InputType\"", "\[Rule]", "point"}], ",", 
          "\[IndentingNewLine]", RowBox[{"\"Options\"", "\[Rule]", 
            RowBox[{"{", "\[IndentingNewLine]", RowBox[{RowBox[
                 {"\"AccuracyGoal\"", "\[Rule]", RowBox[{"10", "^", 
                    RowBox[{"(", RowBox[{"-", "5"}], ")"}]}]}], ",", 
                "\[IndentingNewLine]", RowBox[{"\"InternalAccuracyGoal\"", 
                  "\[Rule]", RowBox[{"10", "^", RowBox[{"(", RowBox[
                       {"-", "1"}], ")"}]}]}], ",", "\[IndentingNewLine]", 
                RowBox[{"\"MaxIterations\"", "\[Rule]", "100"}], ",", 
                "\[IndentingNewLine]", RowBox[{"\"Initial\[Alpha]\"", 
                  "\[Rule]", "10."}], ",", "\[IndentingNewLine]", 
                RowBox[{"\"Scale\[Alpha]\"", "\[Rule]", "2."}]}], 
              "\[IndentingNewLine]", "}"}]}]}], "\[IndentingNewLine]", 
        "]"}]}]], "Input", CellChangeTimes -> 
    {{3.645899727263322*^9, 3.645899828905941*^9}, {3.6458999153675632*^9, 
      3.6458999613009243*^9}, {3.645900085155057*^9, 3.64590008617725*^9}, 
     {3.649244105147053*^9, 3.649244141612112*^9}, 3.6492441995280657*^9, 
     3.649244235124733*^9, {3.649244300274088*^9, 3.64924432620999*^9}, 
     {3.649244455539157*^9, 3.649244478258554*^9}, {3.6492445564309196*^9, 
      3.649244558017473*^9}, {3.649250839383746*^9, 3.649250907728579*^9}, 
     {3.649252533826939*^9, 3.6492526416254377*^9}, 
     {3.649252671853682*^9, 3.649252805222226*^9}, {3.649252843857543*^9, 
      3.649252877964469*^9}, 3.649252961912199*^9, {3.649253238042079*^9, 
      3.649253275946412*^9}, {3.649253369369863*^9, 3.6492533697447767*^9}, 
     {3.649253423639433*^9, 3.649253424268437*^9}, {3.649253479235602*^9, 
      3.6492534955793457*^9}, 3.649253610258621*^9, 3.649253713957828*^9, 
     {3.649253823109071*^9, 3.649253850986278*^9}, 3.649253894056366*^9, 
     3.6492539325804243*^9, {3.6492539715160837*^9, 3.64925398405414*^9}, 
     3.649254169478952*^9, 3.6492544499896917*^9, {3.64925466228195*^9, 
      3.6492546636006002*^9}, {3.649254703927148*^9, 3.6492547048521843*^9}, 
     {3.649256307348075*^9, 3.649256355485935*^9}, {3.6520875710460863*^9, 
      3.652087576346052*^9}, {3.652087667581709*^9, 3.652087670542367*^9}}], 
  Cell[BoxData[RowBox[{"PenaltyMethodData", "=", 
      RowBox[{"PackageFunction", "[", 
        RowBox[{RowBox[{"{", RowBox[{"x_", ",", "args___"}], "}"}], ",", 
          "\[IndentingNewLine]", RowBox[{"x", "\[LeftDoubleBracket]", 
            RowBox[{"1", ",", "\"Cache\"", ",", "\"PenaltyMethodData\"", ",", 
              "args"}], "\[RightDoubleBracket]"}], ",", 
          "\[IndentingNewLine]", RowBox[{"\"InputType\"", "\[Rule]", 
            "point"}]}], "\[IndentingNewLine]", "]"}]}]], "Input", 
   CellChangeTimes -> {{3.6492435928030252*^9, 3.649243685033802*^9}, 
     {3.649252908984251*^9, 3.649252910111369*^9}, {3.6520876210715103*^9, 
      3.6520876268471003*^9}}]}, WindowSize -> {1124, 852}, 
 WindowMargins -> {{Automatic, 0}, {Automatic, 0}}, 
 FrontEndVersion -> 
  "10.0 for Mac OS X x86 (32-bit, 64-bit Kernel) (December 4, 2014)", 
 StyleDefinitions -> "Default.nb"]
